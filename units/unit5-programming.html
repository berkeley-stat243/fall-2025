<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Chris Paciorek">
<meta name="dcterms.date" content="2025-10-01">

<title>Programming concepts</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-ff803dae0bae9edb91fb3cd2582d8e33.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://siteimproveanalytics.com/js/siteanalyze_6294756.js"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../assets/styles.css">
</head>

<body class="nav-sidebar docked quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../units/unit1-intro.html">Units</a></li><li class="breadcrumb-item"><a href="../units/unit5-programming.html">Unit 5 (Programming)</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../assets/stat_bear.png" alt="UC Berkeley Statistics logo" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Stat 243</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/berkeley-stat243/fall-2025" title="" class="quarto-navigation-tool px-1" aria-label="GitHub"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../syllabus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Syllabus</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../schedule.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Schedule</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../office_hours.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Office Hours</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Units</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/unit1-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 1 (UNIX intro)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/unit2-dataTech.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 2 (Data technologies)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/unit3-bash.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 3 (Bash shell)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/unit4-goodPractices.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 4 (Good practices)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/unit5-programming.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Unit 5 (Programming)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/unit6-parallel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 6 (Parallelization)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/unit7-bigData.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 7 (Databases)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/unit8-numbers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 8 (Precision)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/unit9-sim.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 9 (Simulation)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/unit10-linalg.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 10 (Linear Algebra)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/unit11-optim.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 11 (Optimization)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../units/unit12-graphics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unit 12 (Graphics)</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Labs</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../labs/lab0-setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 0 (Optional setup)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../labs/lab1-submission.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 1 (Quarto/Git/Submission)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../labs/lab2-testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 2 (Exceptions/Testing)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../labs/lab3-debugging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 3 (Debugging)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../labs/lab4-reproducibility.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 4 (Reproducibility)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../labs/lab5-codereview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lab 5 (Code review)</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Problem Sets</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ps/ps1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Set 1</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ps/ps2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Set 2</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ps/ps3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Set 3</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ps/ps4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Set 4</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../project/project.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Final Project</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">How tos</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../howtos/accessPython.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Accessing Python</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../howtos/accessUnixCommandLine.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Accessing the Unix Command Line</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../howtos/installGit.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Installing Git</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../howtos/installQuarto.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Installing and Using Quarto</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../howtos/vscode.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using VS Code</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../howtos/submitPS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Set Submissions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../howtos/windowsAndLinux.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Windows 10 and the Ubuntu Subsystem</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../license.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">License</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#text-manipulation-string-processing-and-regular-expressions-regex" id="toc-text-manipulation-string-processing-and-regular-expressions-regex" class="nav-link" data-scroll-target="#text-manipulation-string-processing-and-regular-expressions-regex">1. Text manipulation, string processing and regular expressions (regex)</a>
  <ul class="collapse">
  <li><a href="#string-processing-and-regular-expressions-in-python" id="toc-string-processing-and-regular-expressions-in-python" class="nav-link" data-scroll-target="#string-processing-and-regular-expressions-in-python">String processing and regular expressions in Python</a>
  <ul class="collapse">
  <li><a href="#finding-patterns" id="toc-finding-patterns" class="nav-link" data-scroll-target="#finding-patterns">Finding patterns</a></li>
  <li><a href="#manipulating-and-replacing-patterns" id="toc-manipulating-and-replacing-patterns" class="nav-link" data-scroll-target="#manipulating-and-replacing-patterns">Manipulating and replacing patterns</a></li>
  <li><a href="#greedy-matching" id="toc-greedy-matching" class="nav-link" data-scroll-target="#greedy-matching">Greedy matching</a></li>
  </ul></li>
  <li><a href="#special-characters-in-python" id="toc-special-characters-in-python" class="nav-link" data-scroll-target="#special-characters-in-python">Special characters in Python</a></li>
  </ul></li>
  <li><a href="#interacting-with-the-operating-system-and-external-code-and-configuring-python" id="toc-interacting-with-the-operating-system-and-external-code-and-configuring-python" class="nav-link" data-scroll-target="#interacting-with-the-operating-system-and-external-code-and-configuring-python">2. Interacting with the operating system and external code and configuring Python</a>
  <ul class="collapse">
  <li><a href="#interacting-with-the-operating-system" id="toc-interacting-with-the-operating-system" class="nav-link" data-scroll-target="#interacting-with-the-operating-system">Interacting with the operating system</a></li>
  <li><a href="#interacting-with-external-code" id="toc-interacting-with-external-code" class="nav-link" data-scroll-target="#interacting-with-external-code">Interacting with external code</a></li>
  </ul></li>
  <li><a href="#modules-and-packages" id="toc-modules-and-packages" class="nav-link" data-scroll-target="#modules-and-packages">3. Modules and packages</a>
  <ul class="collapse">
  <li><a href="#modules" id="toc-modules" class="nav-link" data-scroll-target="#modules">Modules</a></li>
  <li><a href="#the-import-statement" id="toc-the-import-statement" class="nav-link" data-scroll-target="#the-import-statement">The import statement</a></li>
  <li><a href="#packages" id="toc-packages" class="nav-link" data-scroll-target="#packages">Packages</a>
  <ul class="collapse">
  <li><a href="#internalprivate-objects" id="toc-internalprivate-objects" class="nav-link" data-scroll-target="#internalprivate-objects">Internal/private objects</a></li>
  <li><a href="#subpackages" id="toc-subpackages" class="nav-link" data-scroll-target="#subpackages">Subpackages</a></li>
  </ul></li>
  <li><a href="#installing-packages" id="toc-installing-packages" class="nav-link" data-scroll-target="#installing-packages">Installing packages</a>
  <ul class="collapse">
  <li><a href="#making-your-package-installable-optional" id="toc-making-your-package-installable-optional" class="nav-link" data-scroll-target="#making-your-package-installable-optional">Making your package installable (optional)</a></li>
  <li><a href="#reproducibility-and-package-management" id="toc-reproducibility-and-package-management" class="nav-link" data-scroll-target="#reproducibility-and-package-management">Reproducibility and package management</a></li>
  <li><a href="#package-locations" id="toc-package-locations" class="nav-link" data-scroll-target="#package-locations">Package locations</a></li>
  <li><a href="#source-vs.-binary-packages" id="toc-source-vs.-binary-packages" class="nav-link" data-scroll-target="#source-vs.-binary-packages">Source vs.&nbsp;binary packages</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#types-and-data-structures" id="toc-types-and-data-structures" class="nav-link" data-scroll-target="#types-and-data-structures">4. Types and data structures</a>
  <ul class="collapse">
  <li><a href="#data-structures" id="toc-data-structures" class="nav-link" data-scroll-target="#data-structures">Data structures</a></li>
  <li><a href="#types-and-classes" id="toc-types-and-classes" class="nav-link" data-scroll-target="#types-and-classes">Types and classes</a>
  <ul class="collapse">
  <li><a href="#overview-and-static-vs.-dynamic-typing" id="toc-overview-and-static-vs.-dynamic-typing" class="nav-link" data-scroll-target="#overview-and-static-vs.-dynamic-typing">Overview and static vs.&nbsp;dynamic typing</a></li>
  <li><a href="#types-in-python" id="toc-types-in-python" class="nav-link" data-scroll-target="#types-in-python">Types in Python</a></li>
  <li><a href="#composite-objects" id="toc-composite-objects" class="nav-link" data-scroll-target="#composite-objects">Composite objects</a></li>
  <li><a href="#mutable-objects" id="toc-mutable-objects" class="nav-link" data-scroll-target="#mutable-objects">Mutable objects</a></li>
  <li><a href="#converting-between-types" id="toc-converting-between-types" class="nav-link" data-scroll-target="#converting-between-types">Converting between types</a></li>
  <li><a href="#dataframes" id="toc-dataframes" class="nav-link" data-scroll-target="#dataframes">Dataframes</a></li>
  <li><a href="#python-object-protocols" id="toc-python-object-protocols" class="nav-link" data-scroll-target="#python-object-protocols">Python object protocols</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#programming-paradigms-object-oriented-and-functional-programming" id="toc-programming-paradigms-object-oriented-and-functional-programming" class="nav-link" data-scroll-target="#programming-paradigms-object-oriented-and-functional-programming">5. Programming paradigms: object-oriented and functional programming</a></li>
  <li><a href="#object-oriented-programming-oop" id="toc-object-oriented-programming-oop" class="nav-link" data-scroll-target="#object-oriented-programming-oop">6. Object-oriented programming (OOP)</a>
  <ul class="collapse">
  <li><a href="#principles" id="toc-principles" class="nav-link" data-scroll-target="#principles">Principles</a></li>
  <li><a href="#classes-in-python" id="toc-classes-in-python" class="nav-link" data-scroll-target="#classes-in-python">Classes in Python</a>
  <ul class="collapse">
  <li><a href="#inheritance" id="toc-inheritance" class="nav-link" data-scroll-target="#inheritance">Inheritance</a></li>
  </ul></li>
  <li><a href="#attributes" id="toc-attributes" class="nav-link" data-scroll-target="#attributes">Attributes</a>
  <ul class="collapse">
  <li><a href="#class-attributes-vs.-instance-attributes" id="toc-class-attributes-vs.-instance-attributes" class="nav-link" data-scroll-target="#class-attributes-vs.-instance-attributes">Class attributes vs.&nbsp;instance attributes</a></li>
  <li><a href="#adding-attributes" id="toc-adding-attributes" class="nav-link" data-scroll-target="#adding-attributes">Adding attributes</a></li>
  </ul></li>
  <li><a href="#generic-function-oop" id="toc-generic-function-oop" class="nav-link" data-scroll-target="#generic-function-oop">Generic function OOP</a>
  <ul class="collapse">
  <li><a href="#why-use-generic-functions" id="toc-why-use-generic-functions" class="nav-link" data-scroll-target="#why-use-generic-functions">Why use generic functions?</a></li>
  <li><a href="#multiple-dispatch-oop" id="toc-multiple-dispatch-oop" class="nav-link" data-scroll-target="#multiple-dispatch-oop">Multiple dispatch OOP</a></li>
  </ul></li>
  <li><a href="#the-python-object-model-and-dunder-methods" id="toc-the-python-object-model-and-dunder-methods" class="nav-link" data-scroll-target="#the-python-object-model-and-dunder-methods">The Python object model and <em>dunder</em> methods</a>
  <ul class="collapse">
  <li><a href="#the-print-function" id="toc-the-print-function" class="nav-link" data-scroll-target="#the-print-function">The print function</a></li>
  <li><a href="#dunder-methods-example" id="toc-dunder-methods-example" class="nav-link" data-scroll-target="#dunder-methods-example">Dunder methods: example</a></li>
  <li><a href="#python-object-protocols-example-1-iterators" id="toc-python-object-protocols-example-1-iterators" class="nav-link" data-scroll-target="#python-object-protocols-example-1-iterators">Python object protocols: Example 1 – iterators</a></li>
  <li><a href="#python-object-protocols-example-2-context-managers-using-with" id="toc-python-object-protocols-example-2-context-managers-using-with" class="nav-link" data-scroll-target="#python-object-protocols-example-2-context-managers-using-with">Python object protocols: Example 2 – context managers using <code>with</code></a></li>
  </ul></li>
  </ul></li>
  <li><a href="#functional-programming" id="toc-functional-programming" class="nav-link" data-scroll-target="#functional-programming">7. Functional programming</a>
  <ul class="collapse">
  <li><a href="#functional-programming-in-python" id="toc-functional-programming-in-python" class="nav-link" data-scroll-target="#functional-programming-in-python">Functional programming (in Python)</a>
  <ul class="collapse">
  <li><a href="#overview-of-functional-programming" id="toc-overview-of-functional-programming" class="nav-link" data-scroll-target="#overview-of-functional-programming">Overview of functional programming</a></li>
  <li><a href="#the-principle-of-no-side-effects" id="toc-the-principle-of-no-side-effects" class="nav-link" data-scroll-target="#the-principle-of-no-side-effects">The principle of no side effects</a></li>
  <li><a href="#functions-are-first-class-objects" id="toc-functions-are-first-class-objects" class="nav-link" data-scroll-target="#functions-are-first-class-objects">Functions are first-class objects</a></li>
  <li><a href="#which-operations-are-function-calls" id="toc-which-operations-are-function-calls" class="nav-link" data-scroll-target="#which-operations-are-function-calls">Which operations are function calls?</a></li>
  <li><a href="#map-operations" id="toc-map-operations" class="nav-link" data-scroll-target="#map-operations">Map operations</a></li>
  </ul></li>
  <li><a href="#function-evaluation-frames-and-the-call-stack" id="toc-function-evaluation-frames-and-the-call-stack" class="nav-link" data-scroll-target="#function-evaluation-frames-and-the-call-stack">Function evaluation, frames, and the call stack</a>
  <ul class="collapse">
  <li><a href="#overview-1" id="toc-overview-1" class="nav-link" data-scroll-target="#overview-1">Overview</a></li>
  <li><a href="#frames-and-the-call-stack" id="toc-frames-and-the-call-stack" class="nav-link" data-scroll-target="#frames-and-the-call-stack">Frames and the call stack</a></li>
  </ul></li>
  <li><a href="#function-inputs-and-outputs" id="toc-function-inputs-and-outputs" class="nav-link" data-scroll-target="#function-inputs-and-outputs">Function inputs and outputs</a>
  <ul class="collapse">
  <li><a href="#arguments" id="toc-arguments" class="nav-link" data-scroll-target="#arguments">Arguments</a></li>
  <li><a href="#function-outputs" id="toc-function-outputs" class="nav-link" data-scroll-target="#function-outputs">Function outputs</a></li>
  </ul></li>
  <li><a href="#pass-by-value-vs.-pass-by-reference" id="toc-pass-by-value-vs.-pass-by-reference" class="nav-link" data-scroll-target="#pass-by-value-vs.-pass-by-reference">Pass by value vs.&nbsp;pass by reference</a>
  <ul class="collapse">
  <li><a href="#pointers-optional" id="toc-pointers-optional" class="nav-link" data-scroll-target="#pointers-optional">Pointers (optional)</a></li>
  </ul></li>
  <li><a href="#namespaces-and-scopes" id="toc-namespaces-and-scopes" class="nav-link" data-scroll-target="#namespaces-and-scopes">Namespaces and scopes</a>
  <ul class="collapse">
  <li><a href="#lexical-scoping-and-enclosing-scopes" id="toc-lexical-scoping-and-enclosing-scopes" class="nav-link" data-scroll-target="#lexical-scoping-and-enclosing-scopes">Lexical scoping and enclosing scopes</a></li>
  <li><a href="#global-and-non-local-variables" id="toc-global-and-non-local-variables" class="nav-link" data-scroll-target="#global-and-non-local-variables">Global and non-local variables</a></li>
  <li><a href="#closures" id="toc-closures" class="nav-link" data-scroll-target="#closures">Closures</a></li>
  </ul></li>
  <li><a href="#decorators" id="toc-decorators" class="nav-link" data-scroll-target="#decorators">Decorators</a></li>
  </ul></li>
  <li><a href="#memory-and-copies" id="toc-memory-and-copies" class="nav-link" data-scroll-target="#memory-and-copies">8. Memory and copies</a>
  <ul class="collapse">
  <li><a href="#overview-2" id="toc-overview-2" class="nav-link" data-scroll-target="#overview-2">Overview</a>
  <ul class="collapse">
  <li><a href="#allocating-and-freeing-memory" id="toc-allocating-and-freeing-memory" class="nav-link" data-scroll-target="#allocating-and-freeing-memory">Allocating and freeing memory</a></li>
  <li><a href="#the-heap-and-the-stack" id="toc-the-heap-and-the-stack" class="nav-link" data-scroll-target="#the-heap-and-the-stack">The heap and the stack</a></li>
  </ul></li>
  <li><a href="#monitoring-memory-use" id="toc-monitoring-memory-use" class="nav-link" data-scroll-target="#monitoring-memory-use">Monitoring memory use</a>
  <ul class="collapse">
  <li><a href="#monitoring-overall-memory-use-on-a-unix-style-computer" id="toc-monitoring-overall-memory-use-on-a-unix-style-computer" class="nav-link" data-scroll-target="#monitoring-overall-memory-use-on-a-unix-style-computer">Monitoring overall memory use on a UNIX-style computer</a></li>
  <li><a href="#monitoring-memory-use-in-python" id="toc-monitoring-memory-use-in-python" class="nav-link" data-scroll-target="#monitoring-memory-use-in-python">Monitoring memory use in Python</a></li>
  </ul></li>
  <li><a href="#how-memory-is-used-in-python" id="toc-how-memory-is-used-in-python" class="nav-link" data-scroll-target="#how-memory-is-used-in-python">How memory is used in Python</a>
  <ul class="collapse">
  <li><a href="#two-key-tools-id-and-is" id="toc-two-key-tools-id-and-is" class="nav-link" data-scroll-target="#two-key-tools-id-and-is">Two key tools: <code>id</code> and <code>is</code></a></li>
  <li><a href="#memory-use-in-specific-circumstances" id="toc-memory-use-in-specific-circumstances" class="nav-link" data-scroll-target="#memory-use-in-specific-circumstances">Memory use in specific circumstances</a></li>
  <li><a href="#when-are-copies-made" id="toc-when-are-copies-made" class="nav-link" data-scroll-target="#when-are-copies-made">When are copies made?</a></li>
  </ul></li>
  <li><a href="#strategies-for-saving-memory" id="toc-strategies-for-saving-memory" class="nav-link" data-scroll-target="#strategies-for-saving-memory">Strategies for saving memory</a></li>
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example">Example</a></li>
  </ul></li>
  <li><a href="#efficiency" id="toc-efficiency" class="nav-link" data-scroll-target="#efficiency">9. Efficiency</a>
  <ul class="collapse">
  <li><a href="#interpreters-and-compilation" id="toc-interpreters-and-compilation" class="nav-link" data-scroll-target="#interpreters-and-compilation">Interpreters and compilation</a>
  <ul class="collapse">
  <li><a href="#why-are-interpreted-languages-slow" id="toc-why-are-interpreted-languages-slow" class="nav-link" data-scroll-target="#why-are-interpreted-languages-slow">Why are interpreted languages slow?</a></li>
  <li><a href="#compilation" id="toc-compilation" class="nav-link" data-scroll-target="#compilation">Compilation</a></li>
  </ul></li>
  <li><a href="#benchmarking-and-profiling" id="toc-benchmarking-and-profiling" class="nav-link" data-scroll-target="#benchmarking-and-profiling">Benchmarking and profiling</a>
  <ul class="collapse">
  <li><a href="#timing-your-code" id="toc-timing-your-code" class="nav-link" data-scroll-target="#timing-your-code">Timing your code</a></li>
  <li><a href="#profiling" id="toc-profiling" class="nav-link" data-scroll-target="#profiling">Profiling</a></li>
  </ul></li>
  <li><a href="#writing-efficient-python-code" id="toc-writing-efficient-python-code" class="nav-link" data-scroll-target="#writing-efficient-python-code">Writing efficient (Python) code</a>
  <ul class="collapse">
  <li><a href="#pre-allocating-memory" id="toc-pre-allocating-memory" class="nav-link" data-scroll-target="#pre-allocating-memory">Pre-allocating memory</a></li>
  <li><a href="#vectorization-and-use-of-fast-matrix-algebra" id="toc-vectorization-and-use-of-fast-matrix-algebra" class="nav-link" data-scroll-target="#vectorization-and-use-of-fast-matrix-algebra">Vectorization and use of fast matrix algebra</a></li>
  <li><a href="#vectorization-mapping-and-loops" id="toc-vectorization-mapping-and-loops" class="nav-link" data-scroll-target="#vectorization-mapping-and-loops">Vectorization, mapping, and loops</a></li>
  <li><a href="#matrix-algebra-efficiency" id="toc-matrix-algebra-efficiency" class="nav-link" data-scroll-target="#matrix-algebra-efficiency">Matrix algebra efficiency</a></li>
  <li><a href="#order-of-operations-and-efficiency" id="toc-order-of-operations-and-efficiency" class="nav-link" data-scroll-target="#order-of-operations-and-efficiency">Order of operations and efficiency</a></li>
  <li><a href="#avoiding-unnecessary-operations" id="toc-avoiding-unnecessary-operations" class="nav-link" data-scroll-target="#avoiding-unnecessary-operations">Avoiding unnecessary operations</a></li>
  <li><a href="#speed-of-lookup-operations" id="toc-speed-of-lookup-operations" class="nav-link" data-scroll-target="#speed-of-lookup-operations">Speed of lookup operations</a></li>
  <li><a href="#hashing-including-name-lookup" id="toc-hashing-including-name-lookup" class="nav-link" data-scroll-target="#hashing-including-name-lookup">Hashing (including name lookup)</a></li>
  </ul></li>
  <li><a href="#additional-general-strategies-for-efficiency" id="toc-additional-general-strategies-for-efficiency" class="nav-link" data-scroll-target="#additional-general-strategies-for-efficiency">Additional general strategies for efficiency</a>
  <ul class="collapse">
  <li><a href="#cache-aware-programming" id="toc-cache-aware-programming" class="nav-link" data-scroll-target="#cache-aware-programming">Cache-aware programming</a></li>
  <li><a href="#loop-fusion" id="toc-loop-fusion" class="nav-link" data-scroll-target="#loop-fusion">Loop fusion</a></li>
  <li><a href="#jit-compilation-with-jax" id="toc-jit-compilation-with-jax" class="nav-link" data-scroll-target="#jit-compilation-with-jax">JIT compilation (with JAX)</a></li>
  <li><a href="#lazy-evaluation" id="toc-lazy-evaluation" class="nav-link" data-scroll-target="#lazy-evaluation">Lazy evaluation</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="unit5-programming.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../units/unit1-intro.html">Units</a></li><li class="breadcrumb-item"><a href="../units/unit5-programming.html">Unit 5 (Programming)</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Programming concepts</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Chris Paciorek </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 1, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="overview" class="level1">
<h1>Overview</h1>
<p>This unit covers a variety of programming concepts, illustrated in the context of Python and with comments about and connections to other languages. It also serves as a way to teach some advanced features of Python. In general the concepts are relevant in other languages, though other languages may implement things differently. One of my goals for the unit is for us to think about why things are the way they are in Python. I.e., what principles were used in creating the language and what choices were made? While other languages use different principles and made different choices, understanding what one language does in detail will be helpful when you are learning another language or choosing a language for a project.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Quarto configuration details for this document">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Quarto configuration details for this document
</div>
</div>
<div class="callout-body-container callout-body">
<p>This document uses the <code>knitr</code> engine for rendering to be able to run chunks in multiple languages (Python and bash, as well as a few R chunks. It has the Quarto configuration <code>ipynb-shell-interactivity: all</code>, so that output from all Python code in a chunk will print in the rendered document; when done with the <code>knitr</code> engine, the output is interspersed with the code in the chunk rather than printed all at the end.</p>
</div>
</div>
</section>
<section id="text-manipulation-string-processing-and-regular-expressions-regex" class="level1">
<h1>1. Text manipulation, string processing and regular expressions (regex)</h1>
<p>Text manipulations in Python have a number of things in common with UNIX, R, and Perl, as many of the ideas/software evolved from UNIX. When I use the term <em>string</em> here, I’ll be referring to any sequence of characters that may include numbers, white space (including newlines), and special characters, usually stored as an object of the <code>str</code> class.</p>
<section id="string-processing-and-regular-expressions-in-python" class="level2">
<h2 class="anchored" data-anchor-id="string-processing-and-regular-expressions-in-python">String processing and regular expressions in Python</h2>
<p>Here we’ll see functionality for working with strings in Python, focusing on regular expressions with the <code>re</code> package. This will augment our consideration of regular expressions in the shell, in particular by seeing how we can replace patterns in addition to finding them.</p>
<p>The <code>re</code> package provides Perl-style regular expressions, but it doesn’t seem to support named character classes such as <code>[:digit:]</code>. Instead use classes such as <code>\d</code> and <code>[0-9]</code>.</p>
<section id="finding-patterns" class="level3">
<h3 class="anchored" data-anchor-id="finding-patterns">Finding patterns</h3>
<p>In Python, you can apply a matching function and then query the result to get information about what was matched and where in the string.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> <span class="st">"Here's my number: 919-543-3300."</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> re.search(<span class="st">"</span><span class="ch">\\</span><span class="st">d+"</span>, text)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;re.Match object; span=(18, 21), match='919'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>m.group()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'919'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>m.start()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>18</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>m.end()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>21</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>m.span()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(18, 21)</code></pre>
</div>
</div>
<p>Notice that that showed us only the first match.</p>
<p>The <a href="#special-characters-in-python">discussion of special characters</a> explains why we need to provide <code>\\d</code> rather than <code>\d</code>.</p>
<p>We can instead use <code>findall</code> to get all the matches.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>re.findall(<span class="st">"</span><span class="ch">\\</span><span class="st">d+"</span>, text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['919', '543', '3300']</code></pre>
</div>
</div>
<p>This is equivalent to:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>pattern <span class="op">=</span> re.<span class="bu">compile</span>(<span class="st">"</span><span class="ch">\\</span><span class="st">d+"</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>re.findall(pattern, text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['919', '543', '3300']</code></pre>
</div>
</div>
<p>The compile can be omitted and will be done implicitly, but is a good idea to do explicitly if you have a complex regex pattern that you will use repeatedly (e.g., on every line in a file). It is also a reminder that regular expressions is a separate language, which can be compiled into a program. The compilation results in an object that relies on finite state machines to match the pattern.</p>
<p>To ignore case, do the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> <span class="st">"That cat in the Hat"</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>re.findall(<span class="st">"hat"</span>, text, re.IGNORECASE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['hat', 'Hat']</code></pre>
</div>
</div>
<p>There are several other regex flags (also called compilation flags) that can control the behavior of the matching engine in interesting ways (check out <code>re.VERBOSE</code> and <code>re.MULTILINE</code> for instance).</p>
<p>We can of course use list comprehension to work with multiple strings. But we need to be careful to check whether a match was found.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> return_group(pattern, txt):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> re.search(pattern, txt)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> m:</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>       <span class="cf">return</span> m.group()</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>       <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> [<span class="st">"Here's my number: 919-543-3300."</span>, <span class="st">"hi John, good to meet you"</span>,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"They bought 731 bananas"</span>, <span class="st">"Please call 1.919.554.3800"</span>]</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>[return_group(<span class="st">"</span><span class="ch">\\</span><span class="st">d+"</span>, <span class="bu">str</span>) <span class="cf">for</span> <span class="bu">str</span> <span class="kw">in</span> text]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['919', None, '731', '1']</code></pre>
</div>
</div>
<p>Recall that we can search for location-specific matches in relation to the start and end of a string.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> <span class="st">"hats are all that are important to a hatter."</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>re.findall(<span class="st">"^hat</span><span class="ch">\\</span><span class="st">w+"</span>, text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['hats']</code></pre>
</div>
</div>
<p>Recall that we can search based on repetitions (as already demonstrated with the <code>\w+</code> just above).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> <span class="st">"Here's my number: 919-543-3300. They bought 731 hats. Please call 1.919.554.3800."</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>re.findall(<span class="st">"</span><span class="ch">\\</span><span class="st">d</span><span class="sc">{3}</span><span class="st">[-.]</span><span class="ch">\\</span><span class="st">d</span><span class="sc">{3}</span><span class="st">[-.]</span><span class="ch">\\</span><span class="st">d</span><span class="sc">{4}</span><span class="st">"</span>, text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['919-543-3300', '919.554.3800']</code></pre>
</div>
</div>
<p>As another example, the phone number detection problem could have been done a bit more compactly (as well as more generally to allow for an initial “1-” or “1.”) as:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> <span class="st">"Here's my number: 919-543-3300. They bought 731 bananas. Please call 1.919.554.3800."</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>re.findall(<span class="st">"((1[-.])?(</span><span class="ch">\\</span><span class="st">d</span><span class="sc">{3}</span><span class="st">[-.]){1,2}</span><span class="ch">\\</span><span class="st">d</span><span class="sc">{4}</span><span class="st">)"</span>, text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[('919-543-3300', '', '543-'), ('1.919.554.3800', '1.', '554.')]</code></pre>
</div>
</div>
<p>Question: the above regex would actually match something that is not a valid phone number. What can go wrong?</p>
<p>When you are searching for all occurrences of a pattern in a large text object, it may be beneficial to use <code>finditer</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>it <span class="op">=</span> re.finditer(<span class="st">"(http|ftp):</span><span class="ch">\\</span><span class="st">/</span><span class="ch">\\</span><span class="st">/"</span>, text)  <span class="co"># http or ftp followed by ://</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> match <span class="kw">in</span> it:</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    match.span()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This method behaves lazily and returns an iterator that gives us one match at a time, and only scans for the next match when we ask for it. This is similar to the behavior we saw with <code>pandas.read_csv(chunksize = n)</code></p>
</section>
<section id="manipulating-and-replacing-patterns" class="level3">
<h3 class="anchored" data-anchor-id="manipulating-and-replacing-patterns">Manipulating and replacing patterns</h3>
<p>We can replace matching substrings with <code>re.sub</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> <span class="st">"Here's my number: 919-543-3300."</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>re.sub(<span class="st">"</span><span class="ch">\\</span><span class="st">d"</span>, <span class="st">"Z"</span>, text   )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>"Here's my number: ZZZ-ZZZ-ZZZZ."</code></pre>
</div>
</div>
<p>Next let’s consider grouping using <code>()</code>. We’ll see that the grouping operator also controls what is returned as the matched patterns.</p>
<p>Here’s a basic example of using grouping via parentheses with the OR operator.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> <span class="st">"At the site http://www.ibm.com. Some other text. ftp://ibm.com"</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>re.search(<span class="st">"(http|ftp):</span><span class="ch">\\</span><span class="st">/</span><span class="ch">\\</span><span class="st">/"</span>, text).group()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'http://'</code></pre>
</div>
</div>
<p>However, if we want to find all the matches and try to use <code>findall</code>, we see that, when grouping operators are present, it returns only the “captured” groups, as discussed a bit in <code>help(re.findall)</code>, so we’d need to add an additional grouping operator to capture the full pattern when using <code>findall</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>re.findall(<span class="st">"(http|ftp):</span><span class="ch">\\</span><span class="st">/</span><span class="ch">\\</span><span class="st">/"</span>, text)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['http', 'ftp']</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>re.findall(<span class="st">"((http|ftp):</span><span class="ch">\\</span><span class="st">/</span><span class="ch">\\</span><span class="st">/)"</span>, text) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[('http://', 'http'), ('ftp://', 'ftp')]</code></pre>
</div>
</div>
<p>If we only wanted to full pattern without capturing the inner group, we can use some additional syntax, <code>?:</code>, for “non-capturing” groups:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>re.findall(<span class="st">"((?:http|ftp):</span><span class="ch">\\</span><span class="st">/</span><span class="ch">\\</span><span class="st">/)"</span>, text) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['http://', 'ftp://']</code></pre>
</div>
</div>
<p>Groups are also used when we need to reference back to a detected pattern when doing a replacement. This is why they are sometimes referred to as “capturing groups”. For example, here we’ll find any numbers and add underscores before and after them:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> <span class="st">"Here's my number: 919-543-3300. They bought 731 bananas. Please call 919.554.3800."</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>re.sub(<span class="st">"([0-9]+)"</span>, <span class="st">"_</span><span class="ch">\\</span><span class="st">1_"</span>, text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>"Here's my number: _919_-_543_-_3300_. They bought _731_ bananas. Please call _919_._554_._3800_."</code></pre>
</div>
</div>
<p>Here we’ll remove commas not used as field separators.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> <span class="st">'"H4NY07011","ACKERMAN, GARY L.","H","$13,242",,,'</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>re.sub(<span class="st">"([^</span><span class="ch">\"</span><span class="st">,]),"</span>, <span class="st">"</span><span class="ch">\\</span><span class="st">1"</span>, text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'"H4NY07011","ACKERMAN GARY L.","H","$13242",,,'</code></pre>
</div>
</div>
<p>How does that work? Consider that <code>[^\",]</code> matches a character that is not a quote and not a comma. The regex is such a character followed by a comma, with the matched character saved in <code>\\1</code> because of the grouping operator.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Challenge">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge
</div>
</div>
<div class="callout-body-container callout-body">
<p>Instead of removing the commas to remove the ambiguity, how would you convert the comma delimiters to pipe (<code>|</code>) delimiters (since the pipe is rarely used in text)?</p>
</div>
</div>
<p>Extending the use of <code>\\1</code>, we can refer to multiple captured groups:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> <span class="st">"Here's my number: 919-543-3300. They bought 731 bananas. Please call 919.554.3800."</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>re.sub(<span class="st">"([0-9]</span><span class="sc">{3}</span><span class="st">)[-</span><span class="er">\</span><span class="st">.]([0-9]</span><span class="sc">{3}</span><span class="st">)[-</span><span class="er">\</span><span class="st">.]([0-9]</span><span class="sc">{4}</span><span class="st">)"</span>, <span class="st">"area code </span><span class="ch">\\</span><span class="st">1, number </span><span class="ch">\\</span><span class="st">2-</span><span class="ch">\\</span><span class="st">3"</span>, text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>"Here's my number: area code 919, number 543-3300. They bought 731 bananas. Please call area code 919, number 554-3800."</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Additional regex functionality">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Additional regex functionality
</div>
</div>
<div class="callout-body-container callout-body">
<p>Regex extensions that we won’t discuss further here include:</p>
<ul>
<li>Groups can also be given names, instead of having to refer to them by their numbers.</li>
<li>We can have <code>sub</code> call a “callback” function to do the replacement. The function will be invoked on each match with the argument being equivalent to the result of <code>re.search</code>.</li>
<li>We can reference previously captured groups within a pattern using the same <code>\\1</code>-style syntax (as opposed to when doing replacement as seen above).</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Challenge">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge
</div>
</div>
<div class="callout-body-container callout-body">
<p>Suppose a text string has dates in the form “Aug-3”, “May-9”, etc. and I want them in the form “3 Aug”, “9 May”, etc. How would I do this regex?</p>
</div>
</div>
</section>
<section id="greedy-matching" class="level3">
<h3 class="anchored" data-anchor-id="greedy-matching">Greedy matching</h3>
<p>Finally, let’s consider where a match ends when there is ambiguity.</p>
<p>As a simple example consider that if we try this search, we match as many digits as possible, rather than returning the first “9” as satisfying the request for “one or more” digits.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> <span class="st">"See the 998 balloons."</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>re.findall(<span class="st">"</span><span class="ch">\\</span><span class="st">d+"</span>, text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['998']</code></pre>
</div>
</div>
<p>That behavior is called <em>greedy</em> matching, and it’s the default. That example also shows why it is the default. What would happen if it were not the default?</p>
<p>However, sometimes greedy matching doesn’t get us what we want.</p>
<p>Consider this attempt to remove multiple html tags from a string.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> <span class="st">"Do an internship &lt;b&gt; in place &lt;/b&gt; of &lt;b&gt; one &lt;/b&gt; course."</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>re.sub(<span class="st">"&lt;.*&gt;"</span>, <span class="st">""</span>, text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'Do an internship  course.'</code></pre>
</div>
</div>
<p>Notice what happens because of greedy matching.</p>
<p>One way to avoid greedy matching is to use a <code>?</code> after the repetition specifier.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>re.sub(<span class="st">"&lt;.*?&gt;"</span>, <span class="st">""</span>, text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'Do an internship  in place  of  one  course.'</code></pre>
</div>
</div>
<p>However, that syntax is a bit frustrating because <code>?</code> is also used to indicate 0 or 1 repetitions, making the regex a bit hard to read/understand.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Challenge">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge
</div>
</div>
<div class="callout-body-container callout-body">
<p>Suppose I want to strip out HTML tags but without using the <code>?</code> to avoid greedy matching. How can I be more careful in constructing my regex?</p>
</div>
</div>
</section>
</section>
<section id="special-characters-in-python" class="level2">
<h2 class="anchored" data-anchor-id="special-characters-in-python">Special characters in Python</h2>
<p>Recall that when characters are used for special purposes, we need to ‘escape’ them if we want them interpreted as the actual (<em>literal</em>) character. In what follows, I show this in Python, but similar manipulations are sometimes needed in the shell and in R.</p>
<p>This can get particularly confusing in Python as the backslash is also used to input special characters such as newline (<code>\n</code>) or tab (<code>\t</code>). Apparently there was some change in handling <em>escape sequences</em> as of Python 3.12. We now need to do this for the regex <code>\d</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>re.search(<span class="st">"</span><span class="ch">\\</span><span class="st">d+"</span>, <span class="st">"a93b"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;re.Match object; span=(1, 3), match='93'&gt;</code></pre>
</div>
</div>
<p>In Python 3.11, it was fine to use <code>\d</code>, but now we need <code>\\d</code>, because Python now tries to interpret <code>\d</code> as a special character (like <code>\n</code>, but <code>\d</code> doesn’t exist) and doesn’t pass it directly along as regex syntax.</p>
<p>Here are some examples of using special characters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>tmp <span class="op">=</span> <span class="st">"Harry said, </span><span class="ch">\"</span><span class="st">Hi</span><span class="ch">\"</span><span class="st">"</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tmp)   <span class="co"># This prints out without a newline -- this is hard to show in rendered doc.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Harry said, "Hi"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>tmp <span class="op">=</span> <span class="st">"Harry said, </span><span class="ch">\"</span><span class="st">Hi</span><span class="ch">\"</span><span class="st">.</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tmp)   <span class="co"># This prints out with the newline -- hard to show in rendered doc.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Harry said, "Hi".</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>tmp <span class="op">=</span> [<span class="st">"azar"</span>, <span class="st">"foo"</span>, <span class="st">"hello</span><span class="ch">\t</span><span class="st">there</span><span class="ch">\n</span><span class="st">"</span>]</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tmp[<span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>hello   there</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>re.search(<span class="st">"[</span><span class="ch">\t</span><span class="st">Z]"</span>, tmp[<span class="dv">2</span>])   <span class="co"># Search for a tab or a 'Z'.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;re.Match object; span=(5, 6), match='\t'&gt;</code></pre>
</div>
</div>
<p>Here are some examples of using various special characters in regex syntax. To use a special character as a regular character, we need to escape it (which in Python 3.12 involves two backslashes, as discussed above):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Search for characters that are not 'z'</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="co">## (using ^ as regular expression syntax)</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>re.search(<span class="st">"[^z]"</span>, <span class="st">"zero"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;re.Match object; span=(1, 2), match='e'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Show results for various input strings:</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> st <span class="kw">in</span> [<span class="st">"a^2"</span>, <span class="st">"93"</span>, <span class="st">"zzz"</span>, <span class="st">"zit"</span>, <span class="st">"azar"</span>]:</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(st <span class="op">+</span> <span class="st">":</span><span class="ch">\t</span><span class="st">"</span>, re.search(<span class="st">"[^z]"</span>, st))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>a^2:     &lt;re.Match object; span=(0, 1), match='a'&gt;
93:  &lt;re.Match object; span=(0, 1), match='9'&gt;
zzz:     None
zit:     &lt;re.Match object; span=(1, 2), match='i'&gt;
azar:    &lt;re.Match object; span=(0, 1), match='a'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co">## Search for either a '^' (as a regular character) or a 'z':</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> st <span class="kw">in</span> [<span class="st">"a^2"</span>, <span class="st">"93"</span>, <span class="st">"zzz"</span>, <span class="st">"zit"</span>, <span class="st">"azar"</span>]:</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(st <span class="op">+</span> <span class="st">":</span><span class="ch">\t</span><span class="st">"</span>, re.search(<span class="st">"[</span><span class="ch">\\</span><span class="st">^z]"</span>, st))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>a^2:     &lt;re.Match object; span=(1, 2), match='^'&gt;
93:  None
zzz:     &lt;re.Match object; span=(0, 1), match='z'&gt;
zit:     &lt;re.Match object; span=(0, 1), match='z'&gt;
azar:    &lt;re.Match object; span=(1, 2), match='z'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co">## Search for exactly three characters</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="co">## (using . as regular expression syntax)</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> st <span class="kw">in</span> [<span class="st">"abc"</span>, <span class="st">"1234"</span>, <span class="st">"def"</span>]:</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(st <span class="op">+</span> <span class="st">":</span><span class="ch">\t</span><span class="st">"</span>, re.search(<span class="st">"^.</span><span class="sc">{3}</span><span class="st">$"</span>, st))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>abc:     &lt;re.Match object; span=(0, 3), match='abc'&gt;
1234:    None
def:     &lt;re.Match object; span=(0, 3), match='def'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="co">## Search for a period (as a regular character)</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> st <span class="kw">in</span> [<span class="st">"3.9"</span>, <span class="st">"27"</span>, <span class="st">"4.2"</span>]:</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(st <span class="op">+</span> <span class="st">":</span><span class="ch">\t</span><span class="st">"</span>, re.search(<span class="st">"</span><span class="ch">\\</span><span class="st">."</span>, st)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3.9:     &lt;re.Match object; span=(1, 2), match='.'&gt;
27:  None
4.2:     &lt;re.Match object; span=(1, 2), match='.'&gt;</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Challenge">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge
</div>
</div>
<div class="callout-body-container callout-body">
<p>Explain why we use a single backslash to get a newline and double backslash to write out a Windows path in the examples here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Suppose we want to use a \ in our string:</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"hello</span><span class="ch">\n</span><span class="st">again"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>hello
again</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"hello</span><span class="ch">\\</span><span class="st">nagain"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>hello\nagain</code></pre>
</div>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"My Windows path is: C:</span><span class="ch">\\</span><span class="st">Users</span><span class="ch">\\</span><span class="st">nadal."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>My Windows path is: C:\Users\nadal.</code></pre>
</div>
</div>
<p>Another way to achieve this effect if your string does not contain any special characters is to prefix your string literal with an r for “raw”:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="vs">r"My Windows path is: C:</span><span class="er">\</span><span class="vs">Users</span><span class="ch">\n</span><span class="vs">adal</span><span class="dv">.</span><span class="vs">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>My Windows path is: C:\Users\nadal.</code></pre>
</div>
</div>
</div>
</div>
<p>On a more involved note, searching for an actual backslash gets even more complicated (you can search online for <a href="https://docs.python.org/3/howto/regex.html#the-backslash-plague">“backslash plague”</a> or “backslash hell”), because we need to pass two backslashes as the regular expression, so that a literal backslash is searched for. However, to pass two backslashes, we need to escape each of them with a backslash so Python doesn’t treat each backslash as part of a special character. So that’s four backslashes to search for a single backslash! Yikes. One rule of thumb is just to keep entering backslashes until things work!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Use and search for an actual backslash</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>tmp <span class="op">=</span> <span class="st">"something </span><span class="ch">\\</span><span class="st"> other</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tmp) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>something \ other</code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>re.search(<span class="st">"</span><span class="ch">\\\\</span><span class="st">"</span>, tmp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;re.Match object; span=(10, 11), match='\\'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    re.search(<span class="st">"</span><span class="ch">\\</span><span class="st">"</span>, tmp)</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> error:</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(error)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>bad escape (end of pattern) at position 0</code></pre>
</div>
</div>
<p>Again here you can use “raw” strings, at the price of losing the ability to use any special characters:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Search for an actual backslash</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>re.search(<span class="vs">r"</span><span class="ch">\\</span><span class="vs">"</span>, tmp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;re.Match object; span=(10, 11), match='\\'&gt;</code></pre>
</div>
</div>
<p>The use of the raw string <code>r"\\"</code> tells Python to treat this string literal without any escaping, but that does not apply to the regex engine (or else we would have used a single backslash), so we do need the second backslash. So yes. This can be quite confusing.</p>
<div class="callout callout-style-default callout-warning callout-titled" title="Pasting quotation marks">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Pasting quotation marks
</div>
</div>
<div class="callout-body-container callout-body">
<p>Be careful when cutting and pasting from documents that are not text files as you may paste in something that looks like a single or double quote, but which Python cannot interpret as a quote because it’s some other ASCII (or Unicode) quote character. If you paste in a ” from PDF, it will not be interpreted as a standard Python double quote mark.</p>
</div>
</div>
<p>Similar things come up in the shell and in R, but in the shell you often don’t need as many backslashes. E.g. you could do this to look for a literal backslash character.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"hello"</span> <span class="op">&gt;</span> file.txt</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"with a \ there"</span> <span class="op">&gt;&gt;</span> file.txt</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span> <span class="st">'\\'</span> file.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>with a \ there</code></pre>
</section>
</section>
<section id="interacting-with-the-operating-system-and-external-code-and-configuring-python" class="level1">
<h1>2. Interacting with the operating system and external code and configuring Python</h1>
<section id="interacting-with-the-operating-system" class="level2">
<h2 class="anchored" data-anchor-id="interacting-with-the-operating-system">Interacting with the operating system</h2>
<p>Scripting languages allow one to interact with the operating system in various ways. Most allow you to call out to the shell to run arbitrary shell code and save results within your session.</p>
<p>I’ll assume everyone knows about the following functions/functionality for interacting with the filesystem and file in Python: <code>os.getcwd</code>, <code>os.chdir</code>, <code>import</code>, <code>pickle.dump</code>, <code>pickle.load</code></p>
<p>Also in IPython there is additional functionality/syntax.</p>
<p>Here are a variety of tools for interacting with the operating system:</p>
<ul>
<li><p>To run UNIX commands from within Python, use <code>subprocess.run()</code>, as follows, noting that we can save the result of a system call to an Python object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess, io</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>subprocess.run([<span class="st">"ls"</span>, <span class="st">"-al"</span>])   <span class="co">## results apparently not shown when compiled...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CompletedProcess(args=['ls', '-al'], returncode=0)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>files <span class="op">=</span> subprocess.run([<span class="st">"ls"</span>, <span class="st">"-al"</span>], capture_output <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>files.stdout</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>b'total 4206\ndrwxr-sr-x 14 paciorek scfstaff      83 Oct  6 08:55 .\ndrwxr-sr-x 15 paciorek scfstaff      51 Oct  6 08:51 ..\n-rw-r--r--  1 paciorek scfstaff    2279 Aug  6 12:23 badCode.R\n-rw-r--r--  1 paciorek scfstaff     803 Aug  6 12:23 book.yml\n-rw-r--r--  1 paciorek scfstaff  117142 Aug  6 12:23 chatgpt-regex-numbers.png\n-rw-r--r--  1 paciorek scfstaff   41130 Sep  4 08:07 cpds.csv\n-rw-r--r--  1 paciorek scfstaff     236 Aug  6 12:23 dummy.py\n-rw-r--r--  1 paciorek scfstaff  175396 Aug  6 12:23 exampleGraphic.png\n-rw-r--r--  1 paciorek scfstaff 1036183 Aug  6 12:23 file_nonascii.txt\n-rw-r--r--  1 paciorek scfstaff   14610 Aug  6 12:23 gauss-seidel.png\n-rw-r--r--  1 paciorek scfstaff      94 Aug 12 12:10 .github-access-token.txt\n-rw-r--r--  1 paciorek scfstaff      41 Aug 12 12:00 .github-access-token.txt~\n-rw-r--r--  1 paciorek scfstaff    4038 Aug  6 12:23 goodCode.R\ndrwxr-sr-x  2 paciorek scfstaff       9 Aug  6 12:23 graphics_files\n-rw-r--r--  1 paciorek scfstaff   20260 Aug  6 12:23 graph.png\n-rw-r--r--  1 paciorek scfstaff    2464 Aug  6 12:23 linked-list.png\n-rw-r--r--  1 paciorek scfstaff      98 Aug  6 12:23 local.py\n-rw-r--r--  1 paciorek scfstaff      79 Aug  6 12:23 mymod.py\ndrwxr-sr-x  4 paciorek scfstaff       7 Aug  6 13:38 mypkg\n-rw-r--r--  1 paciorek scfstaff   27757 Aug  6 12:23 nelder-mead.png\n-rw-r--r--  1 paciorek scfstaff   14575 Aug 12 11:49 newest.json\n-rw-r--r--  1 paciorek scfstaff   22698 Aug 12 11:41 newest.xml\n-rw-r--r--  1 paciorek scfstaff   63998 Aug  6 12:23 normalized_example.png\ndrwxr-sr-x  2 paciorek scfstaff       8 Sep  2 09:55 __pycache__\ndrwxr-xr-x  3 paciorek scfstaff       6 Sep  2 09:53 .pytest_cache\n-rw-r--r--  1 paciorek scfstaff   21871 Oct  6 08:53 regex.html\n-rw-r--r--  1 paciorek scfstaff   23293 Oct  6 08:53 regex.pdf\n-rw-r--r--  1 paciorek scfstaff    2418 Sep  8 09:07 regex.qmd\n-rw-------  1 paciorek scfstaff     118 Aug  6 13:44 .Rhistory\ndrwxr-sr-x  3 paciorek scfstaff       5 Sep  2 09:52 .ruff_cache\n-rw-r--r--  1 paciorek scfstaff     573 Aug  6 12:23 run_no_break.py\n-rw-r--r--  1 paciorek scfstaff     591 Aug  6 12:23 run_with_break.py\n-rw-r--r--  1 paciorek scfstaff   15667 Aug  6 12:23 steep-descent.png\n-rw-r--r--  1 paciorek scfstaff     417 Aug 29 07:52 test_dummy.py\n-rw-r--r--  1 paciorek scfstaff      74 Sep  2 11:21 test.py\n-rw-r--r--  1 paciorek scfstaff      74 Sep  2 11:21 test-save.py\n-rw-r--r--  1 paciorek scfstaff     111 Aug  6 12:23 test_scope.py\n-rw-r--r--  1 paciorek scfstaff       0 Aug 12 14:50 test.sh\n-rw-r--r--  1 paciorek scfstaff      74 Sep  2 10:03 test-unlinted.py\n-rw-r--r--  1 paciorek scfstaff      10 Sep  3 08:56 tmp2.txt\n-rw-r--r--  1 paciorek scfstaff       4 Sep  3 08:56 tmp.txt\n-rw-r--r--  1 paciorek scfstaff       4 Aug 13 08:51 tmp.txt~\n-rw-r--r--  1 paciorek scfstaff     399 Sep 26 09:12 trace.py\n-rw-r--r--  1 paciorek scfstaff    9357 Aug  6 12:23 tree.png\n-rw-r--r--  1 paciorek scfstaff    1776 Sep 22 08:30 tsSimClass.py\ndrwxr-sr-x  4 paciorek scfstaff       4 Aug 11 12:39 unit10-linalg_cache\n-rw-r--r--  1 paciorek scfstaff  202772 Oct  6 08:53 unit10-linalg.html\n-rw-r--r--  1 paciorek scfstaff  193809 Oct  6 08:53 unit10-linalg.pdf\n-rw-r--r--  1 paciorek scfstaff   88399 Aug 26 10:47 unit10-linalg.qmd\n-rw-r--r--  1 paciorek scfstaff  111351 Aug 26 10:47 unit11-optim.qmd\ndrwxr-sr-x  3 paciorek scfstaff       3 Oct  6 08:52 unit12-graphics_files\n-rw-r--r--  1 paciorek scfstaff   77304 Oct  6 08:52 unit12-graphics.html\n-rw-r--r--  1 paciorek scfstaff 1339313 Oct  6 08:52 unit12-graphics.pdf\n-rw-r--r--  1 paciorek scfstaff   16296 Aug 26 10:47 unit12-graphics.qmd\n-rw-r--r--  1 paciorek scfstaff   50734 Oct  6 08:51 unit1-intro.html\n-rw-r--r--  1 paciorek scfstaff   55123 Oct  6 08:51 unit1-intro.pdf\n-rw-r--r--  1 paciorek scfstaff   11498 Aug 26 11:36 unit1-intro.qmd\n-rw-r--r--  1 paciorek scfstaff  195215 Oct  6 08:52 unit2-dataTech.html\n-rw-r--r--  1 paciorek scfstaff  177220 Oct  6 08:52 unit2-dataTech.pdf\n-rw-r--r--  1 paciorek scfstaff   60648 Sep  3 07:51 unit2-dataTech.qmd\n-rw-r--r--  1 paciorek scfstaff   19687 Sep  2 11:16 unit3-bash.qmd\n-rw-r--r--  1 paciorek scfstaff   49636 Sep  2 11:05 unit4-goodPractices.qmd\ndrwxr-sr-x  4 paciorek scfstaff       4 Aug  6 14:55 unit5-programming_cache\ndrwxr-sr-x  6 paciorek scfstaff       6 Oct  6 08:55 unit5-programming_files\n-rw-r--r--  1 paciorek scfstaff     609 Oct  1 08:50 unit5-programming-memsol.txt\n-rw-r--r--  1 paciorek scfstaff  151925 Oct  6 08:50 unit5-programming.qmd\n-rw-r--r--  1 paciorek scfstaff  151926 Oct  6 08:55 unit5-programming.rmarkdown\n-rw-r--r--  1 paciorek scfstaff  295793 Oct  6 08:55 unit5-programming.tex\ndrwxr-sr-x  4 paciorek scfstaff       4 Aug 11 12:35 unit6-parallel_cache\n-rw-r--r--  1 paciorek scfstaff  169642 Oct  6 08:52 unit6-parallel.html\n-rw-r--r--  1 paciorek scfstaff  136475 Oct  6 08:53 unit6-parallel.pdf\n-rw-r--r--  1 paciorek scfstaff   55948 Aug 26 10:47 unit6-parallel.qmd\ndrwxr-sr-x  4 paciorek scfstaff       4 Aug 13 09:00 unit7-bigData_cache\n-rw-r--r--  1 paciorek scfstaff   60874 Aug 26 10:47 unit7-bigData.qmd\n-rw-r--r--  1 paciorek scfstaff  153826 Oct  6 08:53 unit8-numbers.html\n-rw-r--r--  1 paciorek scfstaff  111630 Oct  6 08:53 unit8-numbers.pdf\n-rw-r--r--  1 paciorek scfstaff   31946 Aug 26 10:47 unit8-numbers.qmd\ndrwxr-sr-x  3 paciorek scfstaff       3 Oct  6 08:52 unit9-sim_files\n-rw-r--r--  1 paciorek scfstaff  125181 Oct  6 08:52 unit9-sim.html\n-rw-r--r--  1 paciorek scfstaff  150889 Oct  6 08:52 unit9-sim.pdf\n-rw-r--r--  1 paciorek scfstaff   47693 Aug 26 10:47 unit9-sim.qmd\n-rw-r--r--  1 paciorek scfstaff     142 Aug  6 12:23 vec_orig.py\n-rw-r--r--  1 paciorek scfstaff     142 Oct  6 08:54 vec.py\n'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> io.BytesIO(files.stdout) <span class="im">as</span> stream:  <span class="co"># create a file-like object</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>     content <span class="op">=</span> stream.readlines()</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>content[<span class="dv">2</span>:<span class="dv">4</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[b'drwxr-sr-x 15 paciorek scfstaff      51 Oct  6 08:51 ..\n', b'-rw-r--r--  1 paciorek scfstaff    2279 Aug  6 12:23 badCode.R\n']</code></pre>
</div>
</div></li>
<li><p>There are also a bunch of functions that will do specific queries of the filesystem, including</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>os.path.exists(<span class="st">"unit2-dataTech.qmd"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True</code></pre>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>os.listdir(<span class="st">"../data"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['hivSequ.csv', 'cpds.csv', 'precipData.txt', 'stackoverflow-2021.db', 'coop.txt.gz', 'airline.csv', 'precip.txt', 'test.py', '0', 'test.r', 'co2_annmean_mlo.csv', 'airline.parquet', 'RTADataSub.csv']</code></pre>
</div>
</div></li>
<li><p>There are some tools for dealing with differences between operating systems. <code>os.path.join</code> is a nice example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>os.listdir(os.path.join(<span class="st">".."</span>, <span class="st">"data"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['hivSequ.csv', 'cpds.csv', 'precipData.txt', 'stackoverflow-2021.db', 'coop.txt.gz', 'airline.csv', 'precip.txt', 'test.py', '0', 'test.r', 'co2_annmean_mlo.csv', 'airline.parquet', 'RTADataSub.csv']</code></pre>
</div>
</div>
<p>It’s best if you can to write your code, as shown here with <code>os.path.join</code>, in a way that is <em>agnostic</em> to the underlying operating system (i.e., that works regardless of the operating system).</p></li>
<li><p>To get some info on the system you’re running on:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> platform</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>platform.system()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'Linux'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>os.uname()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>posix.uname_result(sysname='Linux', nodename='smeagol', release='6.8.0-85-generic', version='#85-Ubuntu SMP PREEMPT_DYNAMIC Thu Sep 18 15:26:59 UTC 2025', machine='x86_64')</code></pre>
</div>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>platform.python_version()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'3.13.2'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>sys.version</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'3.13.2 | packaged by conda-forge | (main, Feb 17 2025, 14:40:20) [GCC 13.3.0]'</code></pre>
</div>
</div></li>
<li><p>To retrieve environment variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">'PATH'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'/system/linux/miniforge-3.13/bin:/system/linux/miniforge-3.13/condabin:/system/linux/miniforge-3.13/condabin:/system/linux/miniforge-3.13/bin:/system/linux/miniforge-3.13/condabin:/system/linux/miniforge-3.13/bin:/system/linux/miniforge-3.13/condabin:/system/linux/miniforge-3.13/bin:/usr/local/linux/julia-1.10.4/bin:/usr/local/linux/miniforge-3.13/bin:/accounts/vis/paciorek/bin:/usr/local/linux/bin:/usr/local/bin:/usr/bin:/usr/sbin:/usr/lib/rstudio-server/bin:/accounts/gen/vis/paciorek/.local/bin'</code></pre>
</div>
</div></li>
<li><p>You can have an Python script act as a shell script (like running a bash shell script) as follows.</p>
<ol type="1">
<li>Write your Python code in a text file, say <code>example.py</code></li>
<li>As the first line of the file, include <code>#!/usr/bin/python</code> (like <code>#!/bin/bash</code> in a bash shell file, as seen in Unit 2) or for more portability across machines, include <code>#!/usr/bin/env python</code>.</li>
<li>Make the Python code file executable with <code>chmod</code>: <code>chmod ugo+x example.py</code>.</li>
<li>Run the script from the command line: <code>./example.py</code></li>
</ol>
<p>If you want to pass arguments into your script, you can do so with the <code>argparse</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>parser <span class="op">=</span> argparse.ArgumentParser()</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>parser.add_argument(<span class="st">'-y'</span>, <span class="st">'--year'</span>, default<span class="op">=</span><span class="dv">2002</span>,</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">help</span><span class="op">=</span><span class="st">'year to download'</span>)</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>parser.add_argument(<span class="st">'-m'</span>, <span class="st">'--month'</span>, default<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">help</span><span class="op">=</span><span class="st">'month to download'</span>)</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>args <span class="op">=</span> parse.parse_args()</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>args.year</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>year <span class="op">=</span> <span class="bu">int</span>(args.year)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can run it as follows in the shell:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./example.py</span> 2004 January</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>Use <code>Ctrl-C</code> to interrupt execution. This will generally back out gracefully, returning you to a state as if the command had not been started. Note that if Python is exceeding the amount of memory available, there can be a long delay. This can be frustrating, particularly since a primary reason you would want to interrupt is when Python runs out of memory.</p></li>
</ul>
</section>
<section id="interacting-with-external-code" class="level2">
<h2 class="anchored" data-anchor-id="interacting-with-external-code">Interacting with external code</h2>
<p>Scripting languages such as R, Python, and Julia allow you to call out to “external code”, which often means C or C++ (but also Fortran, Java and other languages).</p>
<p>Calling out to external code is particularly important in languages like R and Python that are often much slower than compiled code and less important in a fast language like Julia (which uses Just-In-Time compilation – more on that later).</p>
<p>In fact, the predecessor language to R, which was called ‘S’ was developed specifically (at AT&amp;T’s Bell Labs in the 1970s and 1980s) as an interactive wrapper around Fortran, the numerical programming language most commonly used at the time (and still widely relied on today in various legacy codes).</p>
<p>In Python, one can <a href="https://docs.python.org/3/extending/extending.html">directly call out to C or C++ code</a> or one can use <em>Cython</em> to interact with C. With Cython, one can:</p>
<ul>
<li>Have Cython automatically translate Python code to C, if you provide type definitions for your variables.</li>
<li>Define C functions that can be called from your Python code.</li>
</ul>
<p>In R, one can call directly out to C or C++ code using <em>.Call</em> or one can use the <a href="https://adv-r.hadley.nz/rcpp.html">Rcpp package</a>. <em>Rcpp</em> is specifically designed to be able to write C++ code that feels somewhat like writing R code and where it is very easy to pass data between R and C++.</p>
</section>
</section>
<section id="modules-and-packages" class="level1">
<h1>3. Modules and packages</h1>
<p>Scripting languages that become popular generally have an extensive collection of add-on packages available online (the causal relationship of the popularity and the extensive add-on packages goes in both directions).</p>
<p>A big part of Python’s popularity is indeed the extensive collection of add-on packages on <a href="https://pypi.org">PyPI</a> (and GitHub and elsewhere) and via <code>Conda</code> that provide much of Python’s functionality (including core numerical capabilities via <code>numpy</code> and <code>scipy</code>).</p>
<p>To make use of a package it needs to be installed on your system (using <code>pip install</code> or <code>conda install</code>) <em>once</em> and loaded into Python (using the <code>import</code> statement) <em>every time you start a new session</em>.</p>
<p>Some modules are <em>installed</em> by default with Python (e.g., <code>os</code> and <code>re</code>), but all need to be loaded by the user in a given Python session.</p>
<section id="modules" class="level2">
<h2 class="anchored" data-anchor-id="modules">Modules</h2>
<p>A <em>module</em> is a collection of related code in a file with the extension <code>.py</code>. The code can include functions, classes, and variables, as well as runnable code. To access the objects in the module, you need to import the module.</p>
<p>Here we’ll create <code>mymod.py</code> from the shell, but of course usually one would create it in an editor.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&lt;&lt; EOF</span> <span class="op">&gt;</span> mymod.py</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="st">x = 7</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="st">range = 3</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a><span class="st">def myfun(x):</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a><span class="st">    print("The arg is: ", str(x), ".", sep = '')</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mymod</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(mymod.x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>mymod.myfun(<span class="dv">99</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The arg is: 99.</code></pre>
</div>
</div>
</section>
<section id="the-import-statement" class="level2">
<h2 class="anchored" data-anchor-id="the-import-statement">The import statement</h2>
<p>The import statement allows one to get access to code in a module. Importantly it associates the names of the objects in the module with a name accessible in the scope in which it was imported (i.e., the current context). The mapping of names (references) to objects is called a <em>namespace</em>. We discuss <a href="#namespaces-and-scopes">scopes and namespaces</a> in more detail later.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> mymod</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:           <span class="co"># Check if `mymod` is in scope.</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>    mymod.x</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> error:</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(error)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>name 'mymod' is not defined</code></pre>
</div>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mymod</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>mymod         <span class="co"># This is essentially a dictionary in the current (global) scope.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;module 'mymod' from '/accounts/vis/paciorek/teaching/243fall25/fall-2025/units/mymod.py'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>x             <span class="co"># This is not a name in the current (global) scope.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NameError: name 'x' is not defined</code></pre>
</div>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="bu">range</span>         <span class="co"># This is a builtin, not from the module.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'range'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>mymod.x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="bu">dir</span>(mymod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['__builtins__', '__cached__', '__doc__', '__file__', '__loader__', '__name__', '__package__', '__spec__', 'myfun', 'range', 'x']</code></pre>
</div>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>mymod.x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>mymod.<span class="bu">range</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3</code></pre>
</div>
</div>
<p>So <code>y</code> and <code>mymod</code> are in the global namespace and <code>range</code> and <code>x</code> are in the module namespace of <code>mymod</code>. You can access the built-in <code>range</code> function from the global namespace but it turns out it’s actually in the built-ins scope (more later).</p>
<p>Note the usefulness of distinguishing the objects in a module from those in the global namespace. We’ll discuss this more in a bit.</p>
<p>That said, we can make an object defined in a module directly accessible in the current scope (adding it to the global namespace in this example) at which point it is distinct from the object in the module:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mymod <span class="im">import</span> x</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>x   <span class="co"># now part of global namespace</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="bu">dir</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['__annotations__', '__builtins__', '__doc__', '__loader__', '__name__', '__package__', '__spec__', 'content', 'files', 'io', 'it', 'm', 'math', 'mymod', 'os', 'pattern', 'platform', 'r', 're', 'return_group', 'st', 'stream', 'subprocess', 'sys', 'text', 'time', 'tmp', 'x', 'y']</code></pre>
</div>
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>mymod.x <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>mymod.x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3</code></pre>
</div>
</div>
<p>But in general we wouldn’t want to use <code>from</code> to import objects in that fashion because we could introduce name <em>conflicts</em> and we reduce modularity.</p>
<p>That said, it can be tedious to always have to type the module name (and in many cases there are multiple submodule names you’d also need to type).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mymod <span class="im">as</span> m</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>m.x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>5</code></pre>
</div>
</div>
</section>
<section id="packages" class="level2">
<h2 class="anchored" data-anchor-id="packages">Packages</h2>
<p>A package is a directory containing one or more modules and with a file named <code>__init__.py</code> that is called when a package is imported and serves to initialize the package.</p>
<p>Let’s create a basic package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> mypkg</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&lt;&lt; EOF</span> <span class="op">&gt;</span> mypkg/__init__.py</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a><span class="st">## Make objects from mymod.py available as mypkg.foo rather than mypkg.mymod.foo.</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a><span class="st">## The "." is a "relative" import that means find "mymod" here in this directory.</span></span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a><span class="st">from .mymod import *</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a><span class="st">print("Welcome to my package.")</span></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&lt;&lt; EOF</span> <span class="op">&gt;</span> mypkg/mymod.py</span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a><span class="st">x = 7</span></span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true" tabindex="-1"></a><span class="st">def myfun(val):</span></span>
<span id="cb141-15"><a href="#cb141-15" aria-hidden="true" tabindex="-1"></a><span class="st">    print(f"Converting {val} to integer: {int(val)}.")</span></span>
<span id="cb141-16"><a href="#cb141-16" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that if there were other modules, we could have imported from those as well.</p>
<p>Now we can use the objects from the module without having to know that it was in a particular module (because of how <code>__init__.py</code> was set up).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mypkg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Welcome to my package.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>mypkg.x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>mypkg.myfun(<span class="fl">7.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Converting 7.3 to integer: 7.</code></pre>
</div>
</div>
<p>Note, one can set <code>__all__</code> in an <code>__init__.py</code> to define what is imported, which makes clear what is publicly available and hides what is considered internal.</p>
<section id="internalprivate-objects" class="level3">
<h3 class="anchored" data-anchor-id="internalprivate-objects">Internal/private objects</h3>
<p>We could add another module that the main module uses but that is not intended for direct use by the user. Here we name the function to start with <code>_</code> following the convention that this indicates a private/internal function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&lt;&lt; EOF</span> <span class="op">&gt;</span> mypkg/auxil.py</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a><span class="st">def _helper(val):</span></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a><span class="st">    return val + 10</span></span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&lt;&lt; EOF</span> <span class="op">&gt;&gt;</span> mypkg/mymod.py</span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a><span class="st">from .auxil import _helper</span></span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-12"><a href="#cb148-12" aria-hidden="true" tabindex="-1"></a><span class="st">def myfun10(val):</span></span>
<span id="cb148-13"><a href="#cb148-13" aria-hidden="true" tabindex="-1"></a><span class="st">    print(f"Converting {val} to integer plus 10: {int(_helper(val))}.")</span></span>
<span id="cb148-14"><a href="#cb148-14" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> mypkg</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mypkg </span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>mypkg.myfun10(<span class="fl">7.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Converting 7.3 to integer plus 10: 17.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> mypkg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="subpackages" class="level3">
<h3 class="anchored" data-anchor-id="subpackages">Subpackages</h3>
<p>Packages can also have modules in nested directories, achieving additional modularity via <em>subpackages</em>. A package can automatically import the subpackages via the main <code>__init__.py</code> or require the user to import them manually, e.g., <code>import mypkg.mysubpkg</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> mypkg/mysubpkg</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&lt;&lt; EOF</span> <span class="op">&gt;</span> mypkg/mysubpkg/__init__.py</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a><span class="st">from .values import *</span></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a><span class="st">print("Welcome to my package's subpackage.")</span></span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&lt;&lt; EOF</span> <span class="op">&gt;</span> mypkg/mysubpkg/values.py</span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a><span class="st">x = 999</span></span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a><span class="st">b = 7</span></span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a><span class="st">_my_internal_var = 9</span></span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mypkg.mysubpkg     <span class="co">## Note that __init__.py is invoked</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Welcome to my package's subpackage.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>mypkg.mysubpkg.b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>mypkg.x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>7</code></pre>
</div>
</div>
<p>Note that a given <code>__init__.py</code> is invoked when importing anything nested within the directory containing the <code>__init__.py</code>; in the case above the <code>__init__.py</code> from <code>mypkg</code> is invoked, though for some reason the “Welcome to my package.” output is not showing up in this rendered document.</p>
<p>If we wanted to automatically import the subpackage we would add <code>from . import mysubpkg</code> to <code>mypkg/__init__.py</code>, which uses <a href="https://docs.python.org/3/reference/import.html">relative imports</a>. The alternative “absolute” import would be <code>import mypkg.mysubpkg</code>, which finds <code>mypkg</code> using <code>sys.path</code> (which specifies a set of paths of where to look).</p>
<p>One would generally not import the items from <code>mysubpkg</code> directly into the <code>mypkg</code> namespace but there may be cases one would do something like this. For example <code>numpy.linspace</code> is actually found in <code>numpy/core/function_base.py</code>, but we don’t need to refer to <code>numpy.core.linspace</code> because of how <code>numpy</code> structures the <code>import</code> statements in <code>__init__.py</code>. In contrast, the linear algebra functions are available via the subpackage namespace as <code>numpy.linalg.&lt;function_name&gt;</code>.</p>
<p>Take a look at <code>dir(numpy)</code>, <code>dir(numpy.linalg)</code>, and <code>dir(numpy.core)</code> to get a better sense for this in a real package.</p>
</section>
</section>
<section id="installing-packages" class="level2">
<h2 class="anchored" data-anchor-id="installing-packages">Installing packages</h2>
<p>If a package is on PyPI or available through Conda but not on your system, you can install it easily (usually). You don’t need root permission on a machine to install a package, though you may need to use <code>pip install --user</code> or set up a new Conda environment.</p>
<p>Packages often depend on other packages. In general, if one package depends on another, pip or conda will generally install the dependency automatically.</p>
<p>One advantage of Conda is that it can also install non-Python packages on which a Python package depends, whereas with pip you sometimes need to install a system package to satisfy a dependency.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Using Mamba/libmamba and the Conda-forge channel">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Using Mamba/libmamba and the Conda-forge channel
</div>
</div>
<div class="callout-body-container callout-body">
<p>It’s not uncommon to run into a case where conda has trouble installing a package because of version inconsistencies amongst the dependencies. <code>mamba</code> is a drop-in replacement for <code>conda</code> and often does a better job of this “dependency resolution”. <a href="https://statistics.berkeley.edu/computing/software/install">We use <code>mamba</code> by default on the SCF</a>. In recent versions of Conda, you can also use the Mamba’s dependency resolver when running <code>conda</code> commands by running <code>conda config --set solver libmamba</code>, which puts <code>solver: libmamba</code> in your <code>.condarc</code> file. It’s also generally recommended to use the <code>conda-forge</code> <em>channel</em> (i.e., location) when installing packages with Conda (this is done automatically when using <code>mamba</code>). <code>conda-forge</code> provides a wide variety of up-to-date packages, maintained by the community.</p>
</div>
</div>
<section id="making-your-package-installable-optional" class="level3">
<h3 class="anchored" data-anchor-id="making-your-package-installable-optional">Making your package installable (optional)</h3>
<p>It’s pretty easy to configure your package so that it can be built and installed via <code>pip</code>. See the structure of <a href="https://github.com/fperez/mytoy">this example repository</a>. In fact, one can install the package with only either <code>setup.py</code> or <code>pyproj.toml</code>, but the other files listed here are recommended:</p>
<ul>
<li><code>pyproj.toml</code> (or <code>pyproject.toml</code>): this is a configuration file used by packaging tools. In the <code>mytoy</code> example it specifies to use <code>setuptools</code> to build and install the package.</li>
<li><code>setup.py</code>: this is run when the package is built and installed when using <code>setuptools</code>. In the example, it simply runs <code>setuptools.setup()</code>. With recent versions of <code>setuptools</code>, you don’t actually need this so long as you have the <code>pyproj.toml</code> file.</li>
<li><code>setup.cfg</code>: provides metadata about the package when using <code>setuptools</code>.</li>
<li><code>environment.yml</code>: provides information about the full environment in which your package should be used (including examples, documentation, etc.). For projects using <code>setuptools</code>, a minimal list of dependencies needed for installation and use of the package can instead be included in the <code>install_requires</code> option of <code>setup.cfg</code>.</li>
<li><code>LICENSE</code>: specifies the license for your package giving the terms under which others can use it.</li>
</ul>
<p>The <code>postBuild</code> file is a completely optional file only needed if you want to use the package with a MyBinder environment.</p>
<p>At the <a href="https://github.com/numpy/numpy">numpy GitHub repository</a>, by looking in <code>pyproject.toml</code>, you can see that <code>numpy</code> is build and installed using a system called <em>Meson</em>, while at the <a href="https://github.com/jupyter/jupyter">Jupyter GitHub repository</a> you can see that the <code>jupyter</code> package is built and installed using <code>setuptools</code>.</p>
<p><em>Building</em> a package usually refers to compiling source code but for a Python package that just has Python code, nothing needs to be compiled. <em>Installing</em> a package means putting the built package into a location on your computer where packages are installed.</p>
<p>You can also make your package public on PyPI or through Conda, but that is not something we’ll cover here.</p>
</section>
<section id="reproducibility-and-package-management" class="level3">
<h3 class="anchored" data-anchor-id="reproducibility-and-package-management">Reproducibility and package management</h3>
<p>For reproducibility, it’s important to know the versions of the packages you use (and the version of Python). <code>pip</code> and <code>conda</code> make it easy to do this. You can create a <em>requirements</em> file that captures the packages you are currently using (and, critically, their versions) and then install exactly that set of packages (and versions) based on that requirements file.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> freeze <span class="op">&gt;</span> requirements.txt</span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env export <span class="at">--no-builds</span> <span class="op">&gt;</span> environment.yml</span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env create <span class="at">-f</span> environment.yml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>--no-builds</code> flag make sure not to include information about the dependencies that are system-specific (e.g., that would only work on MacOS and not on Windows).</p>
<p>Conda is a general package manager. You can use it to manage Python packages but lots of other software as well, including R and Julia.</p>
<p>Conda environments provide an additional layer of modularity/reproducibility, allowing you to set up a fully reproducible environment for your computation. Here (by explicitly giving <code>python=3.13</code>) the Python 3.13 executable and all packages you install in the environment are fully independent of whatever Python executables are installed on the system.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> create <span class="at">-n</span> myenv python=3.13</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> activate myenv</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> install numpy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you use <code>conda activate</code> rather than <code>source activate</code>, Conda will prompt you to run <code>conda init</code>, which will make changes to your <code>~/.bashrc</code> that, for one, activate the Conda base environment automatically when a shell is started. This may be fine, but it’s helpful to be aware.</p>
</div>
</div>
</section>
<section id="package-locations" class="level3">
<h3 class="anchored" data-anchor-id="package-locations">Package locations</h3>
<p>Packages in Python (and in R, Julia, etc.) may be installed in various places on the filesystem, and it sometimes it is helpful (e.g., if you end up with multiple versions of a package installed on your system) to be able to figure out where on the filesystem the package is being loaded from.</p>
<p>We can use the <code>__file__</code> and <code>__version__</code> objects in a package to see where on the filesystem a package is installed and what version it is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>np.<span class="va">__file__</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'/system/linux/miniforge-3.13/lib/python3.13/site-packages/numpy/__init__.py'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>np.__version__</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'2.1.3'</code></pre>
</div>
</div>
<p>(<code>pip list</code> or <code>conda list</code> will also show version numbers, for all packages.)</p>
<p><code>sys.path</code> shows where Python looks for packages on your system.</p>
</section>
<section id="source-vs.-binary-packages" class="level3">
<h3 class="anchored" data-anchor-id="source-vs.-binary-packages">Source vs.&nbsp;binary packages</h3>
<p>The difference between a <em>source</em> package and a <em>binary</em> package is that the source package has the raw Python (and C/C++ and Fortran, in some cases) code as text files, while the binary package has all the non-Python code in a binary/non-text format, with the C/C++ and Fortran code already having been compiled.</p>
<p>If you install a package from source, C/C++/Fortran code will be compiled on your system (if the package has such code). That should mean the compiled code will work on your system, but requires you to have a compiler available and things properly configured. A binary package doesn’t need to be compiled on your system, but in some cases the code may not run on your system because it was compiled in such a way that is not compatible with your system.</p>
<p>Python <em>wheels</em> are a binary package format for Python packages. Wheels for some packages will vary by platform (i.e., operating system) so that the package will install correctly on the system where it is being installed.</p>
</section>
</section>
</section>
<section id="types-and-data-structures" class="level1">
<h1>4. Types and data structures</h1>
<section id="data-structures" class="level2">
<h2 class="anchored" data-anchor-id="data-structures">Data structures</h2>
<p>Please see the <a href="unit2-dataTech.html#data-structures">data structures section of Unit 2</a> for some general discussion of data structures.</p>
<p>We’ll also see more complicated data structures when we consider objects in the <a href="#object-oriented-programming-oop">section on object-oriented programming</a>.</p>
</section>
<section id="types-and-classes" class="level2">
<h2 class="anchored" data-anchor-id="types-and-classes">Types and classes</h2>
<section id="overview-and-static-vs.-dynamic-typing" class="level3">
<h3 class="anchored" data-anchor-id="overview-and-static-vs.-dynamic-typing">Overview and static vs.&nbsp;dynamic typing</h3>
<p>The term ‘type’ refers to how a given piece of information is stored and what operations can be done with the information.</p>
<p>‘Primitive’ types are the most basic types that often relate directly to how data are stored in memory or on disk (e.g., boolean, integer, numeric (real-valued, aka <em>double</em> or <em>floating point</em>), character, pointer (aka <em>address</em>, <em>reference</em>).</p>
<p>In compiled languages like C and C++, one has to define the type of each variable. Such languages are <em>statically</em> typed. Interpreted (or scripting) languages such as Python and R have <em>dynamic</em> types. One can associate different types of information with a given variable name at different times and without declaring the type of the variable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="st">'hello'</span></span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>hello</code></pre>
</div>
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>x<span class="op">*</span><span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'hellohellohello'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>x<span class="op">*</span><span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>21</code></pre>
</div>
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> {<span class="st">'mykey'</span>: <span class="dv">7</span>}</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>x<span class="op">*</span><span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TypeError: unsupported operand type(s) for *: 'dict' and 'int'</code></pre>
</div>
</div>
<p>In contrast in a language like C, one has to declare a variable based on its type before using it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> y<span class="op">;</span></span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> x <span class="op">=</span> <span class="fl">3.1</span><span class="op">;</span></span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> x <span class="op">*</span> <span class="fl">7.1</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Dynamic typing can be quite helpful from the perspective of quick implementation and avoiding tedious type definitions and problems from minor inconsistencies between types (e.g., multiplying an integer by a real-valued number). But static typing has some critical advantages from the perspective of software development, including:</p>
<ul>
<li>protecting against errors from mismatched values and unexpected user inputs, and</li>
<li>generally much faster execution because the type of a variable does not need to be checked (and the location of the value found) when the code is run.</li>
</ul>
<p>More complex types in Python (and in R) often use references (<em>pointers</em>, aka <em>addresses</em>) to the actual locations of the data. We’ll see this in detail when we discuss <a href="#memory-and-copies">Memory</a>.</p>
</section>
<section id="types-in-python" class="level3">
<h3 class="anchored" data-anchor-id="types-in-python">Types in Python</h3>
<p>You should be familiar with the important built-in data types in Python, most importantly lists, tuples, and dictionaries, as well as basic scalar types such as integers, floats, and strings.</p>
<p>Let’s look at the type of various built-in data structures in Python and in numpy, which provides important types for numerical computing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'int'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="fl">3.0</span></span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'float'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="st">'abc'</span></span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'str'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="va">False</span></span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'bool'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> [<span class="dv">3</span>, <span class="fl">3.0</span>, <span class="st">'abc'</span>]</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'list'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.array([<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>])  <span class="co">## array of integers</span></span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'numpy.ndarray'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(x[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'numpy.int64'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">3</span>) <span class="co"># array of floats (aka 'doubles')</span></span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(x[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'numpy.float64'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> (<span class="dv">3</span>,<span class="dv">4</span>)) <span class="co"># multi-dimensional array</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'numpy.ndarray'&gt;</code></pre>
</div>
</div>
<p>Sometimes numpy may modify a type to make things easier for you, which often works well, but you may want to control it yourself to be sure:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.array([<span class="dv">3</span>, <span class="dv">5</span>, <span class="fl">7.3</span>])</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>array([3. , 5. , 7.3])</code></pre>
</div>
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(x[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'numpy.float64'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.array([<span class="fl">3.0</span>, <span class="fl">5.0</span>, <span class="fl">7.0</span>]) <span class="co"># Force use of floats (either `3.0` or `3.`).</span></span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(x[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'numpy.float64'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.array([<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>], dtype <span class="op">=</span> <span class="st">'float64'</span>)</span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(x[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'numpy.float64'&gt;</code></pre>
</div>
</div>
<p>This can come up when working on a GPU, where the default is usually 32-bit (4-byte) numbers instead of 64-bit (8-byte) numbers.</p>
</section>
<section id="composite-objects" class="level3">
<h3 class="anchored" data-anchor-id="composite-objects">Composite objects</h3>
<p>Many objects can be <em>composite</em> (e.g., a list of dictionaries or a dictionary of lists, tuples, and strings).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>mydict <span class="op">=</span> {<span class="st">'a'</span>: <span class="dv">3</span>, <span class="st">'b'</span>: <span class="dv">7</span>}</span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>mylist <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>]</span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>mylist[<span class="dv">1</span>] <span class="op">=</span> mydict</span>
<span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a>mylist</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[3, {'a': 3, 'b': 7}, 7]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>mydict[<span class="st">'a'</span>] <span class="op">=</span> mylist</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="mutable-objects" class="level3">
<h3 class="anchored" data-anchor-id="mutable-objects">Mutable objects</h3>
<p>Most objects in Python can be modified <em>in place</em> (i.e., modifying only some of the object), but tuples, strings, and sets are <em>immutable</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> (<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">7</span>)</span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a>    x[<span class="dv">1</span>] <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb203-4"><a href="#cb203-4" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> error:</span>
<span id="cb203-5"><a href="#cb203-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(error)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'tuple' object does not support item assignment</code></pre>
</div>
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> <span class="st">'abc'</span></span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a>s[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'b'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>    s[<span class="dv">1</span>] <span class="op">=</span> <span class="st">'y'</span></span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> error:</span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(error)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'str' object does not support item assignment</code></pre>
</div>
</div>
</section>
<section id="converting-between-types" class="level3">
<h3 class="anchored" data-anchor-id="converting-between-types">Converting between types</h3>
<p>This also goes by the term <em>coercion</em> and <em>casting</em>. Casting often needs to be done explicitly in compiled languages and somewhat less so in interpreted languages like Python.</p>
<p>We can <em>cast</em> (coerce) between different basic types:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> <span class="bu">str</span>(x[<span class="dv">0</span>])</span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a>y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'3'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> <span class="bu">int</span>(x[<span class="dv">0</span>])</span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'int'&gt;</code></pre>
</div>
</div>
<p>Some common conversions are converting numbers that are being interpreted as strings into actual numbers and converting between booleans and numeric values.</p>
<p>In some cases Python will automatically do conversions behind the scenes in a smart way (or occasionally not so smart way). Consider these attempts/examples of implicit coercion:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.array([<span class="va">False</span>, <span class="va">True</span>, <span class="va">True</span>])</span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>x.<span class="bu">sum</span>()         <span class="co"># What do you think is going to happen?</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>np.int64(2)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb215"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb215-2"><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb215-3"><a href="#cb215-3" aria-hidden="true" tabindex="-1"></a>    x[<span class="dv">3</span>] <span class="op">=</span> <span class="st">'hat'</span>    <span class="co"># What do you think is going to happen?</span></span>
<span id="cb215-4"><a href="#cb215-4" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> error:</span>
<span id="cb215-5"><a href="#cb215-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(error)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>could not convert string to float: 'hat'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a>myList <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">9</span>, <span class="dv">4</span>, <span class="dv">7</span>]</span>
<span id="cb217-3"><a href="#cb217-3" aria-hidden="true" tabindex="-1"></a><span class="co"># myList[2.0]    # What do you think is going to happen?</span></span>
<span id="cb217-4"><a href="#cb217-4" aria-hidden="true" tabindex="-1"></a><span class="co"># myList[2.73]   # What do you think is going to happen?</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>R is less strict and will do conversions in some cases that Python won’t:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">5</span>)</span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>x[<span class="fl">2.0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.147572</code></pre>
</div>
<div class="sourceCode cell-code" id="cb220"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a>x[<span class="fl">2.73</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.147572</code></pre>
</div>
</div>
<p>Question: What are the advantages and disadvantages of the different behaviors of Python and R?</p>
</section>
<section id="dataframes" class="level3">
<h3 class="anchored" data-anchor-id="dataframes">Dataframes</h3>
<p>Hopefully you’re also familiar with the Pandas dataframe type.</p>
<p>Pandas picked up the idea of dataframes from R and functionality is similar in many ways to what you can do with R’s <code>dplyr</code> package.</p>
<p><code>dplyr</code> and <code>pandas</code> provide a lot of functionality for the “split-apply-combine” framework of working with “rectangular” data. Unfortunately, using Pandas can be a bit hard to learn/remember. I suggest looking into learning <a href="unit2-dataTech.html#reading-data-quickly-arrow-and-polars"><code>polars</code></a> as an alternative.</p>
<p>Often analyses are done in a stratified fashion - the same operation or analysis is done on subsets of the data set. The subsets might be different time points, different locations, different hospitals, different people, etc.</p>
<p>The split-apply-combine framework is intended to operate in this kind of context: - first one splits the dataset by one or more variables, - then one does something to each subset, and - then one combines the results.</p>
<p>split-apply-combine is also closely related to the famous Map-Reduce framework underlying big data tools such as Hadoop and Spark.</p>
<p>It’s also very similar to standard SQL queries involving filtering, grouping, and aggregation.</p>
</section>
<section id="python-object-protocols" class="level3">
<h3 class="anchored" data-anchor-id="python-object-protocols">Python object protocols</h3>
<p>There are a number of broad categories of kinds of objects: <code>mapping</code>, <code>number</code>, <code>sequence</code>, <code>iterator</code>. These are called object protocols.</p>
<p>All objects that fall in a given category share key characteristics. For example <code>sequence</code> objects have notions of length and accessing (ordered) elements by index, while <code>iterator</code> objects have notions of “next” and of “stopping”.</p>
<p>Object protocols are implemented based on the <a href="#the-python-object-model-and-dunder-methods">Python object model</a> using <strong>dunder</strong> methods. For a class (such as one you write) to implement an object protocol, it must define a particular set of class methods, discussed at the link above.</p>
</section>
</section>
</section>
<section id="programming-paradigms-object-oriented-and-functional-programming" class="level1">
<h1>5. Programming paradigms: object-oriented and functional programming</h1>
<p>Object-oriented and functional programming are two important approaches to programming.</p>
<p>Functional programming (FP) focuses on writing functions that take inputs and produce outputs. Ideally those functions don’t change the state (i.e., the values) of any variables and can be treated as black boxes. Functions can be treated like other variables, such as passing functions as arguments to another function (as one does with <code>map</code> in Python).</p>
<p>Object-oriented programming (OOP) revolves around objects that belong to classes. The class of an object defines the fields (the data objects) holding information and methods that can be applied to those fields. When one calls a method, it may modify the value of the fields. A statistical analogy is that an object of a class is like the realization (the object) of a random variable (the class).</p>
<p>One can think of functional programming as being focused on actions (or <em>verbs</em> to make an analogy with human language). One carries out a computation as a sequence of function calls. One can think of OOP as being focused on the objects (or <em>nouns</em>). One carries out a computation as a sequence of operations with the objects, using the class methods.</p>
<p>Many languages are multi-paradigm, containing aspects of both approaches and allowing programmers to use either approach. Both R and Python are like this, though one would generally consider R to be more functional and Python to be more object-oriented.</p>
<p>Let’s illustrate the ideas with some numpy and list functionality.</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.array([<span class="fl">1.2</span>, <span class="fl">3.5</span>, <span class="fl">4.2</span>, <span class="fl">9.7</span>])</span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a>x.shape     <span class="co"># field (or attribute) of the numpy array class</span></span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a>x.<span class="bu">sum</span>()     <span class="co"># method of the class</span></span>
<span id="cb222-5"><a href="#cb222-5" aria-hidden="true" tabindex="-1"></a>np.<span class="bu">sum</span>(x)   <span class="co"># equivalent numpy function</span></span>
<span id="cb222-6"><a href="#cb222-6" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(x)      <span class="co"># built-in function</span></span>
<span id="cb222-7"><a href="#cb222-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-8"><a href="#cb222-8" aria-hidden="true" tabindex="-1"></a><span class="co"># functional approach: apply functions sequentially</span></span>
<span id="cb222-9"><a href="#cb222-9" aria-hidden="true" tabindex="-1"></a>x2 <span class="op">=</span> np.reshape(x, (<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb222-10"><a href="#cb222-10" aria-hidden="true" tabindex="-1"></a>x2t <span class="op">=</span> np.transpose(x2)</span>
<span id="cb222-11"><a href="#cb222-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-12"><a href="#cb222-12" aria-hidden="true" tabindex="-1"></a><span class="co"># functional, but using class methods</span></span>
<span id="cb222-13"><a href="#cb222-13" aria-hidden="true" tabindex="-1"></a>x2 <span class="op">=</span> x.reshape(<span class="dv">2</span>,<span class="dv">2</span>)</span>
<span id="cb222-14"><a href="#cb222-14" aria-hidden="true" tabindex="-1"></a>x2t <span class="op">=</span> x2.transpose()</span>
<span id="cb222-15"><a href="#cb222-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-16"><a href="#cb222-16" aria-hidden="true" tabindex="-1"></a><span class="co"># OOP: modify objects using class methods</span></span>
<span id="cb222-17"><a href="#cb222-17" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> <span class="bu">list</span>([<span class="fl">1.2</span>, <span class="fl">3.5</span>, <span class="fl">4.2</span>])</span>
<span id="cb222-18"><a href="#cb222-18" aria-hidden="true" tabindex="-1"></a>y.append(<span class="fl">7.9</span>)  <span class="co"># y modified in place using class method</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Different people have different preferences, but which is better sometimes depends on what you are trying to do. If your computation is a data analysis pipeline that involves a series of transformations of some data, a functional approach might make more sense, since the focus is on a series of actions rather than the state of objects. If your computation involves various operations on fixed objects whose state needs to change, OOP might make more sense. For example, if you were writing code to keep track of student information, it would probably make sense to have each student as an object of a <code>Student</code> class with methods such as <code>register</code> and <code>assign_grade</code>.</p>
</section>
<section id="object-oriented-programming-oop" class="level1">
<h1>6. Object-oriented programming (OOP)</h1>
<p>OOP involves organizing your code around objects that contain information, and methods that operate in specific ways on those objects. Objects belong to classes. A class is made up of fields (the data) that store information and methods (functions) that operate on the fields.</p>
<p>By analogy, OOP focuses on the nouns, with the verbs being part of the nouns, while FP focuses on the verbs (the functions), which operate on the nouns (the arguments).</p>
<p>Most of the things we work with in Python are objects. Functions are also objects, as are classes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb223"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(<span class="bu">len</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'builtin_function_or_method'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb225"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> foo(x):</span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(x)</span>
<span id="cb225-3"><a href="#cb225-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-4"><a href="#cb225-4" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(foo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'function'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb227"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb227-2"><a href="#cb227-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.array([<span class="fl">1.2</span>, <span class="fl">3.4</span>])</span>
<span id="cb227-3"><a href="#cb227-3" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'numpy.ndarray'&gt;</code></pre>
</div>
</div>
<section id="principles" class="level2">
<h2 class="anchored" data-anchor-id="principles">Principles</h2>
<p>Some of the standard concepts in object-oriented programming include <em>encapsulation</em>, <em>inheritance</em>, <em>polymorphism</em>, and <em>abstraction</em>.</p>
<p><em>Encapsulation</em> involves preventing direct access to internal data in an object from outside the object. Instead the class is designed so that access (reading or writing) happens through the interface set up by the programmer (e.g., ‘getter’ and ‘setter’ methods). However, Python actually doesn’t really enforce the notion of internal or private information.</p>
<p><em>Inheritance</em> allows one class to be based on another class, adding more specialized features. For example in the <code>statsmodels</code> package, the OLS class inherits from the WLS class.</p>
<p><em>Polymorphism</em> allows for different behavior of an object or function depending on the context. A polymorphic function behaves differently depending on the input types. For example, think of a print function or an addition operator behaving differently depending on the type of the input argument(s). A polymorphic object is one that can belong to different classes (e.g., based on inheritance), and a given method name can be used with any of the classes. An example would be having a base or super class called ‘algorithm’ and various specific machine learning algorithms inheriting from that class. All of the classes might have a ‘predict’ method.</p>
<p><em>Abstraction</em> involves hiding the details of how something is done (e.g., via the method of a class), giving the user an interface to provide inputs and get outputs. By making the actual computation a black box, the programmer can modify the internals without changing how a user uses the system.</p>
<p>Classes generally have <em>constructors</em> that initialize objects of the class and <em>destructors</em> that remove objects.</p>
</section>
<section id="classes-in-python" class="level2">
<h2 class="anchored" data-anchor-id="classes-in-python">Classes in Python</h2>
<p>Python provides a pretty standard approach to writing object-oriented code focused on classes.</p>
<p>Our example is to create a class for working with random time series. Each object of the class has specific parameter values that control the stochastic behavior of the time series. With a given object we can simulate one or more time series (realizations).</p>
<p>Here’s the initial definition of the class with methods and fields (aka attributes).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb229"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-3"><a href="#cb229-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> tsSimClass:</span>
<span id="cb229-4"><a href="#cb229-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''</span></span>
<span id="cb229-5"><a href="#cb229-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Class definition for time series simulator</span></span>
<span id="cb229-6"><a href="#cb229-6" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb229-7"><a href="#cb229-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">## dunder methods (more later)</span></span>
<span id="cb229-8"><a href="#cb229-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, times, mean <span class="op">=</span> <span class="dv">0</span>, cor_param <span class="op">=</span> <span class="dv">1</span>, seed <span class="op">=</span> <span class="dv">1</span>):</span>
<span id="cb229-9"><a href="#cb229-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">## This is the constructor, called when `tsSimClass(...)` is invoked</span></span>
<span id="cb229-10"><a href="#cb229-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">## to create an instance of the class.</span></span>
<span id="cb229-11"><a href="#cb229-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-12"><a href="#cb229-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">## For robustness, need checks that `cor_param` is numeric of length 1 and `times` is np array.</span></span>
<span id="cb229-13"><a href="#cb229-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">## Public attributes</span></span>
<span id="cb229-14"><a href="#cb229-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n <span class="op">=</span> <span class="bu">len</span>(times)</span>
<span id="cb229-15"><a href="#cb229-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mean <span class="op">=</span> mean</span>
<span id="cb229-16"><a href="#cb229-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cor_param <span class="op">=</span> cor_param</span>
<span id="cb229-17"><a href="#cb229-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">## Private attributes (encapsulation)</span></span>
<span id="cb229-18"><a href="#cb229-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._times <span class="op">=</span> times</span>
<span id="cb229-19"><a href="#cb229-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._current_U <span class="op">=</span> <span class="va">False</span></span>
<span id="cb229-20"><a href="#cb229-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">## Some setup steps</span></span>
<span id="cb229-21"><a href="#cb229-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._calc_mats()</span>
<span id="cb229-22"><a href="#cb229-22" aria-hidden="true" tabindex="-1"></a>        np.random.seed(seed)</span>
<span id="cb229-23"><a href="#cb229-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):    <span class="co"># 'print' method</span></span>
<span id="cb229-24"><a href="#cb229-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"An object of class `tsSimClass` with </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>n<span class="sc">}</span><span class="ss"> time points."</span></span>
<span id="cb229-25"><a href="#cb229-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb229-26"><a href="#cb229-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.n</span>
<span id="cb229-27"><a href="#cb229-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-28"><a href="#cb229-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Public methods: getter and setter (encapsulation)</span></span>
<span id="cb229-29"><a href="#cb229-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> set_times(<span class="va">self</span>, new_times):</span>
<span id="cb229-30"><a href="#cb229-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._times <span class="op">=</span> new_times</span>
<span id="cb229-31"><a href="#cb229-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._current_U <span class="op">=</span> <span class="va">False</span></span>
<span id="cb229-32"><a href="#cb229-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._calc_mats()</span>
<span id="cb229-33"><a href="#cb229-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_times(<span class="va">self</span>):</span>
<span id="cb229-34"><a href="#cb229-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._times</span>
<span id="cb229-35"><a href="#cb229-35" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb229-36"><a href="#cb229-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Main public method</span></span>
<span id="cb229-37"><a href="#cb229-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> simulate(<span class="va">self</span>):</span>
<span id="cb229-38"><a href="#cb229-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>._current_U:    </span>
<span id="cb229-39"><a href="#cb229-39" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._calc_mats()</span>
<span id="cb229-40"><a href="#cb229-40" aria-hidden="true" tabindex="-1"></a>        <span class="co">## analogous to mu+sigma*z for generating N(mu, sigma^2)</span></span>
<span id="cb229-41"><a href="#cb229-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.mean <span class="op">+</span> np.dot(<span class="va">self</span>.U.T, np.random.normal(size <span class="op">=</span> <span class="va">self</span>.n))</span>
<span id="cb229-42"><a href="#cb229-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-43"><a href="#cb229-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Private method.</span></span>
<span id="cb229-44"><a href="#cb229-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _calc_mats(<span class="va">self</span>):</span>
<span id="cb229-45"><a href="#cb229-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">## Calculates correlation matrix and Cholesky factor (caching).</span></span>
<span id="cb229-46"><a href="#cb229-46" aria-hidden="true" tabindex="-1"></a>        lag_mat <span class="op">=</span> np.<span class="bu">abs</span>(<span class="va">self</span>._times[:, np.newaxis] <span class="op">-</span> <span class="va">self</span>._times)</span>
<span id="cb229-47"><a href="#cb229-47" aria-hidden="true" tabindex="-1"></a>        cor_mat <span class="op">=</span> np.exp(<span class="op">-</span>lag_mat <span class="op">**</span> <span class="dv">2</span> <span class="op">/</span> <span class="va">self</span>.cor_param <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb229-48"><a href="#cb229-48" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.U <span class="op">=</span> np.linalg.cholesky(cor_mat)</span>
<span id="cb229-49"><a href="#cb229-49" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Done updating correlation matrix and Cholesky factor."</span>)</span>
<span id="cb229-50"><a href="#cb229-50" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._current_U <span class="op">=</span> <span class="va">True</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s see how we would use the class.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb230"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a>myts <span class="op">=</span> tsSimClass(np.arange(<span class="dv">1</span>, <span class="dv">101</span>), <span class="dv">2</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Done updating correlation matrix and Cholesky factor.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb232"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(myts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>An object of class `tsSimClass` with 100 time points.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb234"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">1</span>)</span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a><span class="co">## Here's a simulated time series.</span></span>
<span id="cb234-3"><a href="#cb234-3" aria-hidden="true" tabindex="-1"></a>y1 <span class="op">=</span> myts.simulate()</span>
<span id="cb234-4"><a href="#cb234-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-5"><a href="#cb234-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb234-6"><a href="#cb234-6" aria-hidden="true" tabindex="-1"></a>plt.plot(myts.get_times(), y1, <span class="st">'-'</span>)</span>
<span id="cb234-7"><a href="#cb234-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'time'</span>)</span>
<span id="cb234-8"><a href="#cb234-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'process values'</span>)</span>
<span id="cb234-9"><a href="#cb234-9" aria-hidden="true" tabindex="-1"></a><span class="co">## Simulate a second series.</span></span>
<span id="cb234-10"><a href="#cb234-10" aria-hidden="true" tabindex="-1"></a>y2 <span class="op">=</span> myts.simulate()</span>
<span id="cb234-11"><a href="#cb234-11" aria-hidden="true" tabindex="-1"></a>plt.plot(myts.get_times(), y2, <span class="st">'--'</span>)</span>
<span id="cb234-12"><a href="#cb234-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="unit5-programming_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid figure-img" alt="Randomly-generated time series from our object" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We could set up a different object that has different parameter values. That new simulated time series is less wiggly because the <code>cor_param</code> value is larger than before.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb235"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a>myts2 <span class="op">=</span> tsSimClass(np.arange(<span class="dv">1</span>, <span class="dv">101</span>), <span class="dv">2</span>, <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Done updating correlation matrix and Cholesky factor.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb237"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">1</span>)</span>
<span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a><span class="co">## Here's a simulated time series with a different value of</span></span>
<span id="cb237-3"><a href="#cb237-3" aria-hidden="true" tabindex="-1"></a><span class="co">## the correlation parameter (cor_param).</span></span>
<span id="cb237-4"><a href="#cb237-4" aria-hidden="true" tabindex="-1"></a>y3 <span class="op">=</span> myts2.simulate()</span>
<span id="cb237-5"><a href="#cb237-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-6"><a href="#cb237-6" aria-hidden="true" tabindex="-1"></a>plt.plot(myts2.get_times(), y3, <span class="st">'-'</span>, color <span class="op">=</span> <span class="st">'red'</span>)</span>
<span id="cb237-7"><a href="#cb237-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'time'</span>)</span>
<span id="cb237-8"><a href="#cb237-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'process values'</span>)</span>
<span id="cb237-9"><a href="#cb237-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="unit5-programming_files/figure-html/unnamed-chunk-60-3.png" class="img-fluid figure-img" alt="Another randomly-generated time series" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="copies-and-references" class="level4">
<h4 class="anchored" data-anchor-id="copies-and-references">Copies and references</h4>
<p>Next let’s think about when copies are made. In the next example <code>myts_ref</code> is a copy of <code>myts</code> in the sense that both names point to the same underlying object. But no data were copied when the assignment to <code>myts_ref</code> was done.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb238"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a>myts_ref <span class="op">=</span> myts</span>
<span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a><span class="co">## 'myts_ref' and 'myts' are names for the same underlying object.</span></span>
<span id="cb238-3"><a href="#cb238-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> copy</span>
<span id="cb238-4"><a href="#cb238-4" aria-hidden="true" tabindex="-1"></a>myts_full_copy <span class="op">=</span> copy.deepcopy(myts)</span>
<span id="cb238-5"><a href="#cb238-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-6"><a href="#cb238-6" aria-hidden="true" tabindex="-1"></a><span class="co">## Now let's change the values of a field.</span></span>
<span id="cb238-7"><a href="#cb238-7" aria-hidden="true" tabindex="-1"></a>myts.set_times(np.arange(<span class="dv">1</span>,<span class="dv">1001</span>,<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Done updating correlation matrix and Cholesky factor.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb240"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a>myts.get_times()[<span class="dv">0</span>:<span class="dv">4</span>] </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>array([ 1, 11, 21, 31])</code></pre>
</div>
<div class="sourceCode cell-code" id="cb242"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>myts_ref.get_times()[<span class="dv">0</span>:<span class="dv">4</span>] <span class="co"># the same as `myts`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>array([ 1, 11, 21, 31])</code></pre>
</div>
<div class="sourceCode cell-code" id="cb244"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a>myts_full_copy.get_times()[<span class="dv">0</span>:<span class="dv">4</span>] <span class="co"># different from `myts`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>array([1, 2, 3, 4])</code></pre>
</div>
</div>
<p>In contrast <code>myts_full_copy</code> is a reference to a different object, and all the data from <code>myts</code> had to be copied over to <code>myts_full_copy</code>. This takes additional memory (and time), but is also safer, as it avoids the possibility that the user might modify <code>myts</code> and not realize that they were also affecting <code>myts_ref</code>. We’ll discuss this more when we discuss copying in the <a href="#memory-and-copies">section on memory use</a>.</p>
</section>
<section id="encapsulation" class="level4">
<h4 class="anchored" data-anchor-id="encapsulation">Encapsulation</h4>
<p>Those of you familiar with OOP will probably be familiar with the idea of public and private fields and methods.</p>
<p>Why have private fields (i.e., <em>encapsulation</em>)? The use of private fields shields them from modification by users. Python doesn’t really provide this functionality but by convention, attributes whose name starts with <code>_</code> are considered private. In this case, we don’t want users to modify the <code>times</code> field. Why is this important? In this example, the correlation matrix and the Cholesky factor U are both functions of the array of times. So we don’t want to allow a user to directly modify <code>times</code>. If they did, it would leave the fields of the object in inconsistent states. Instead we want them to use <code>set_times</code>, which correctly keeps all the fields in the object internally consistent (by calling <code>_calc_mats</code>). It also allows us to improve efficiency by controlling when computationally expensive operations are carried out.</p>
<p>In a module, objects that start with <code>_</code> are a weak form of private attributes. Users can access them, but <code>from foo import *</code> does not import them.</p>
</section>
<section id="inheritance" class="level3">
<h3 class="anchored" data-anchor-id="inheritance">Inheritance</h3>
<p>Inheritance can be a powerful way to reduce code duplication and keep your code organized in a logical (nested) fashion. Special cases can be simple extensions of more general classes. A good example of inheritance in Python and R is how regression models are handled. E.g., in Python’s <code>statsmodels</code> package, the <a href="https://www.statsmodels.org/stable/_modules/statsmodels/regression/linear_model.html#OLS"><code>OLS</code> class inherits from the <code>WLS</code> class</a>. Or if we think back to the random time series example and generalize it, one might have a <code>StochasticProcess</code> class, with a <code>GaussianProcess</code> class that inherits from it, and a <code>ExpGaussianProcess</code> class (implementing a Gaussian process with an exponential covariance<code>inheriting from the</code>GaussianProcess` class.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Bear:</span>
<span id="cb246-2"><a href="#cb246-2" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, name, age):</span>
<span id="cb246-3"><a href="#cb246-3" aria-hidden="true" tabindex="-1"></a>          <span class="va">self</span>.name <span class="op">=</span> name</span>
<span id="cb246-4"><a href="#cb246-4" aria-hidden="true" tabindex="-1"></a>          <span class="va">self</span>.age <span class="op">=</span> age</span>
<span id="cb246-5"><a href="#cb246-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb246-6"><a href="#cb246-6" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> <span class="ss">f"A bear named '</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>name<span class="sc">}</span><span class="ss">' of age </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>age<span class="sc">}</span><span class="ss">."</span></span>
<span id="cb246-7"><a href="#cb246-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> color(<span class="va">self</span>):</span>
<span id="cb246-8"><a href="#cb246-8" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> <span class="st">"unknown"</span></span>
<span id="cb246-9"><a href="#cb246-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-10"><a href="#cb246-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GrizzlyBear(Bear):</span>
<span id="cb246-11"><a href="#cb246-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, name, age, num_people_killed <span class="op">=</span> <span class="dv">0</span>):</span>
<span id="cb246-12"><a href="#cb246-12" aria-hidden="true" tabindex="-1"></a>          <span class="bu">super</span>().<span class="fu">__init__</span>(name, age)</span>
<span id="cb246-13"><a href="#cb246-13" aria-hidden="true" tabindex="-1"></a>          <span class="va">self</span>.num_people_killed <span class="op">=</span> num_people_killed</span>
<span id="cb246-14"><a href="#cb246-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> color(<span class="va">self</span>):  </span>
<span id="cb246-15"><a href="#cb246-15" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> <span class="st">"brown"</span></span>
<span id="cb246-16"><a href="#cb246-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-17"><a href="#cb246-17" aria-hidden="true" tabindex="-1"></a>yog <span class="op">=</span> Bear(<span class="st">"Yogi the Bear"</span>, <span class="dv">23</span>)</span>
<span id="cb246-18"><a href="#cb246-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(yog)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A bear named 'Yogi the Bear' of age 23.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb248"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a>yog.color()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'unknown'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb250"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a>num399 <span class="op">=</span> GrizzlyBear(<span class="st">"Jackson Hole Grizzly 399"</span>, <span class="dv">35</span>)</span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(num399)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A bear named 'Jackson Hole Grizzly 399' of age 35.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb252"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a>num399.color()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'brown'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>num399.num_people_killed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0</code></pre>
</div>
</div>
<p>Here the <code>GrizzlyBear</code> class has additional fields/methods beyond those inherited from the base class (the <code>Bear</code> class), i.e., <code>num_people_killed</code> (since grizzly bears are much more dangerous than some other kinds of bears), and perhaps additional or modified methods. Python uses the methods specific to the <code>GrizzlyBear</code> class if present before falling back to methods of the <code>Bear</code> class if not present in the <code>GrizzlyBear</code> class.</p>
<p>The above is an example of polymorphism. Instances of the <code>GrizzlyBear</code> class are polymorphic because they can have behavior from both the <code>GrizzlyBear</code> and <code>Bear</code> classes. The <code>color</code> method is polymorphic in that it can be used for both classes but is defined to behave differently depending on the class.</p>
</section>
</section>
<section id="attributes" class="level2">
<h2 class="anchored" data-anchor-id="attributes">Attributes</h2>
<p>Both fields and methods are <em>attributes</em>.</p>
<p>We saw the notion of attributes when looking at HTML and XML, where the information was stored as key-value pairs that in many cases had additional information in the form of attributes.</p>
<section id="class-attributes-vs.-instance-attributes" class="level3">
<h3 class="anchored" data-anchor-id="class-attributes-vs.-instance-attributes">Class attributes vs.&nbsp;instance attributes</h3>
<p>Here <code>count</code> is a class attribute while <code>name</code> and <code>age</code> are instance attributes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb256"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Bear:</span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a>      count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb256-3"><a href="#cb256-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, name, age):</span>
<span id="cb256-4"><a href="#cb256-4" aria-hidden="true" tabindex="-1"></a>          <span class="va">self</span>.name <span class="op">=</span> name</span>
<span id="cb256-5"><a href="#cb256-5" aria-hidden="true" tabindex="-1"></a>          <span class="va">self</span>.age <span class="op">=</span> age</span>
<span id="cb256-6"><a href="#cb256-6" aria-hidden="true" tabindex="-1"></a>          Bear.count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb256-7"><a href="#cb256-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-8"><a href="#cb256-8" aria-hidden="true" tabindex="-1"></a>yog <span class="op">=</span> Bear(<span class="st">"Yogi the Bear"</span>, <span class="dv">23</span>)</span>
<span id="cb256-9"><a href="#cb256-9" aria-hidden="true" tabindex="-1"></a>yog.count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb258"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a>smokey <span class="op">=</span> Bear(<span class="st">"Smokey the Bear"</span>, <span class="dv">77</span>)</span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a>smokey.count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2</code></pre>
</div>
</div>
<p>The class attribute allows us to manipulate information relating to all instances of the class, as seen here where we keep track of the number of bears that have been created.</p>
</section>
<section id="adding-attributes" class="level3">
<h3 class="anchored" data-anchor-id="adding-attributes">Adding attributes</h3>
<p>What do you think will happen if we do the following?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a>yog.bizarre <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a>yog.bizarre</span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-4"><a href="#cb260-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> foo(x):</span>
<span id="cb260-5"><a href="#cb260-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(x)</span>
<span id="cb260-6"><a href="#cb260-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-7"><a href="#cb260-7" aria-hidden="true" tabindex="-1"></a>foo.bizarre <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb260-8"><a href="#cb260-8" aria-hidden="true" tabindex="-1"></a>foo.bizarre</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It turns out we can add instance attributes on the fly in some cases, which is a bit disconcerting in some ways.</p>
</section>
</section>
<section id="generic-function-oop" class="level2">
<h2 class="anchored" data-anchor-id="generic-function-oop">Generic function OOP</h2>
<p>Let’s consider the <code>len</code> function in Python. It seems to work magically on various kinds of objects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb261"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>]</span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb263"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb265"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> {<span class="st">'a'</span>: <span class="dv">2</span>, <span class="st">'b'</span>: <span class="dv">3</span>}</span>
<span id="cb265-2"><a href="#cb265-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2</code></pre>
</div>
</div>
<p>Suppose you were writing the <code>len</code> function. What would you have to do to make it work as it did above? What would happen if a user wants to use <code>len</code> with a class that they define?</p>
<p>Instead, Python implements the <code>len</code> function by calling the <code>__len__</code> method of the class that the argument belongs to.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb267"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> {<span class="st">'a'</span>: <span class="dv">2</span>, <span class="st">'b'</span>: <span class="dv">3</span>}</span>
<span id="cb267-2"><a href="#cb267-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb269"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a>x.<span class="fu">__len__</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2</code></pre>
</div>
</div>
<p><code>__len__</code> is a <em>dunder</em> method (a “Double-UNDERscore” method), which we’ll discuss more in a bit.</p>
<p>Something similar occurs with operators:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb271"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb271-2"><a href="#cb271-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">+</span> <span class="dv">5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>8</code></pre>
</div>
<div class="sourceCode cell-code" id="cb273"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="st">'abc'</span></span>
<span id="cb273-2"><a href="#cb273-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">+</span> <span class="st">'xyz'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'abcxyz'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb275"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a>x.<span class="fu">__add__</span>(<span class="st">'xyz'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'abcxyz'</code></pre>
</div>
</div>
<p>This use of generic functions is convenient in that it allows us to work with a variety of kinds of objects using familiar functions.</p>
<p>The use of such generic functions and operators is similar in spirit to function or method <em>overloading</em> in C++ and Java. It is also how the (very) old S3 system in R works. And it’s a key part of the (fairly) new Julia language.</p>
<section id="why-use-generic-functions" class="level3">
<h3 class="anchored" data-anchor-id="why-use-generic-functions">Why use generic functions?</h3>
<p>The Python developers could have written <code>len</code> as a regular function with a bunch of <code>if</code> statements so that it can handle different kinds of input objects.</p>
<p>This has some disadvantages:</p>
<ol type="1">
<li>We need to write the code that does the checking.</li>
<li>Furthermore, all the code for the different cases all lives inside one potentially very long function, unless we create class-specific helper functions.</li>
<li>Most importantly, <code>len</code> will only work for existing classes. And users can’t easily extend it for new classes that they create because they don’t control the <code>len</code> (built-in) function. So a user could not add the additional conditions/classes in a big if-else statement. The generic function approach makes the system <em>extensible</em> – we can build our own new functionality on top of what is already in Python.</li>
</ol>
</section>
<section id="multiple-dispatch-oop" class="level3">
<h3 class="anchored" data-anchor-id="multiple-dispatch-oop">Multiple dispatch OOP</h3>
<p>The dispatch system involved in <code>len</code> and <code>+</code> involves only the first argument to the function (or operator). In contrast, <a href="https://docs.julialang.org/en/v1/manual/methods">Julia emphasizes the importance of multiple dispatch</a> as particularly important for mathematical computation. With multiple dispatch, the specific method can be chosen based on more than one argument.</p>
<p>In R, the old (but still used in some contexts) <a href="http://adv-r.had.co.nz/S4.html">S4</a> system in R and the new <a href="https://rconsortium.github.io/OOP-WG">R7</a> system both provide for multiple dispatch.</p>
<p>As a very simple example unrelated to any specific language, multiple dispatch would allow one to do the following with the addition operator:</p>
<pre><code>3 + 7    # 10
3 + 'a'  # '3a'
'hi' +  ' there'  # 'hi there'</code></pre>
<p>The idea of having the behavior of an operator or function adapt to the type of the input(s) is one aspect of <em>polymorphism</em>.</p>
</section>
</section>
<section id="the-python-object-model-and-dunder-methods" class="level2">
<h2 class="anchored" data-anchor-id="the-python-object-model-and-dunder-methods">The Python object model and <em>dunder</em> methods</h2>
<p>Now that we’ve seen the basics of classes, as well as generic function OOP, we’re in a good position to understand the Python object model.</p>
<p>Objects are dictionaries that provide a mapping from attribute names to their values, either fields or methods.</p>
<p><em>dunder</em> methods are special methods that Python will invoke when various functions are called on instances of the class or other standard operations are invoked. They allow classes to interact with Python’s built-ins.</p>
<p>Here are some important dunder methods:</p>
<ul>
<li><code>__init__</code> is the constructor (initialization) function that is called when the class name is invoked (e.g., <code>Bear(...)</code>)</li>
<li><code>__len__</code> is called by <code>len()</code></li>
<li><code>__str__</code> is called by <code>print()</code></li>
<li><code>__repr__</code> is called when an object’s name is invoked</li>
<li><code>__call__</code> is called if the instance is invoked as a function call (e.g., <code>yog()</code> in the <code>Bear</code> case)</li>
<li><code>__add__</code> is called by the <code>+</code> operator.</li>
<li><code>__getitem__</code> is called by the <code>[</code> slicing operator.</li>
</ul>
<section id="the-print-function" class="level3">
<h3 class="anchored" data-anchor-id="the-print-function">The print function</h3>
<p>Like <code>len</code>, <code>print</code> is a generic function, with various class-specific methods.</p>
<p>We can write a print method for our own class by defining the <code>__str__</code> method. One generally also defines a <code>__repr__</code> method giving what to display when the name of an object is typed.</p>
</section>
<section id="dunder-methods-example" class="level3">
<h3 class="anchored" data-anchor-id="dunder-methods-example">Dunder methods: example</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb278"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Basic class definition</span></span>
<span id="cb278-2"><a href="#cb278-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Bear:</span>
<span id="cb278-3"><a href="#cb278-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, name, age):</span>
<span id="cb278-4"><a href="#cb278-4" aria-hidden="true" tabindex="-1"></a>          <span class="va">self</span>.name <span class="op">=</span> name</span>
<span id="cb278-5"><a href="#cb278-5" aria-hidden="true" tabindex="-1"></a>          <span class="va">self</span>.age <span class="op">=</span> age</span>
<span id="cb278-6"><a href="#cb278-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-7"><a href="#cb278-7" aria-hidden="true" tabindex="-1"></a>yog <span class="op">=</span> Bear(<span class="st">"Yogi the Bear"</span>, <span class="dv">23</span>)</span>
<span id="cb278-8"><a href="#cb278-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(yog)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;__main__.Bear object at 0x74a03977ba10&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb280"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Class definition with various dunder methods</span></span>
<span id="cb280-2"><a href="#cb280-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Bear:</span>
<span id="cb280-3"><a href="#cb280-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, name, age):</span>
<span id="cb280-4"><a href="#cb280-4" aria-hidden="true" tabindex="-1"></a>          <span class="va">self</span>.name <span class="op">=</span> name</span>
<span id="cb280-5"><a href="#cb280-5" aria-hidden="true" tabindex="-1"></a>          <span class="va">self</span>.age <span class="op">=</span> age</span>
<span id="cb280-6"><a href="#cb280-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb280-7"><a href="#cb280-7" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> <span class="ss">f"A bear named </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>name<span class="sc">}</span><span class="ss"> of age </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>age<span class="sc">}</span><span class="ss">."</span></span>
<span id="cb280-8"><a href="#cb280-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>):</span>
<span id="cb280-9"><a href="#cb280-9" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> <span class="ss">f"Bear(name=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>name<span class="sc">}</span><span class="ss">, age=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>age<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb280-10"><a href="#cb280-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> <span class="fu">__add__</span>(<span class="va">self</span>, value):</span>
<span id="cb280-11"><a href="#cb280-11" aria-hidden="true" tabindex="-1"></a>          <span class="va">self</span>.age <span class="op">+=</span> value</span>
<span id="cb280-12"><a href="#cb280-12" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb280-13"><a href="#cb280-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb280-14"><a href="#cb280-14" aria-hidden="true" tabindex="-1"></a>yogi <span class="op">=</span> Bear(<span class="st">"Yogi the Bear"</span>, <span class="dv">23</span>)</span>
<span id="cb280-15"><a href="#cb280-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(yogi)   <span class="co"># Invokes __str__</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A bear named Yogi the Bear of age 23.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb282"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a>yogi          <span class="co"># Invokes __repr__</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Bear(name=Yogi the Bear, age=23)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb284"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a>yogi <span class="op">+</span> <span class="dv">12</span></span>
<span id="cb284-2"><a href="#cb284-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(yogi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A bear named Yogi the Bear of age 35.</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Challenge">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge
</div>
</div>
<div class="callout-body-container callout-body">
<p>Let’s check our understanding of the object model.</p>
<p>How would you get Python to quit immediately, without asking for any more information, when you simply type <code>q</code> (no parentheses!) instead of <code>quit()</code>? (Hint: you can do this by understanding what happens when you type <code>q</code> and how to exploit the characteristics of Python classes.)</p>
</div>
</div>
</section>
<section id="python-object-protocols-example-1-iterators" class="level3">
<h3 class="anchored" data-anchor-id="python-object-protocols-example-1-iterators">Python object protocols: Example 1 – iterators</h3>
<p>A container class that supports iteration should provide the <code>__iter__</code> and <code>__next__</code> methods to implement the iterator protocol.</p>
<p>Here we see that <code>tuple</code>s are iterable containers (although they are not iterators themselves):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb286"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a>mytuple <span class="op">=</span> (<span class="st">"apple"</span>, <span class="st">"banana"</span>, <span class="st">"cherry"</span>)</span>
<span id="cb286-2"><a href="#cb286-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb286-3"><a href="#cb286-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> item <span class="kw">in</span> mytuple:</span>
<span id="cb286-4"><a href="#cb286-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(item)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>apple
banana
cherry</code></pre>
</div>
<div class="sourceCode cell-code" id="cb288"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a><span class="co">## We can manually create the iterator and iterate through it.</span></span>
<span id="cb288-2"><a href="#cb288-2" aria-hidden="true" tabindex="-1"></a>myit <span class="op">=</span> <span class="bu">iter</span>(mytuple)</span>
<span id="cb288-3"><a href="#cb288-3" aria-hidden="true" tabindex="-1"></a><span class="co">## myit = mytuple.__iter__()  ## This is equivalent to using `iter(mytuple)`.</span></span>
<span id="cb288-4"><a href="#cb288-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-5"><a href="#cb288-5" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(myit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'tuple_iterator'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb290"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">next</span>(myit))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>apple</code></pre>
</div>
<div class="sourceCode cell-code" id="cb292"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">next</span>(myit))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>banana</code></pre>
</div>
<div class="sourceCode cell-code" id="cb294"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a>myit.<span class="fu">__next__</span>()   <span class="co">## This is equivalent to using `next(myit)`.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'cherry'</code></pre>
</div>
</div>
<p>I think it makes sense that tuples are iterable containers but they are not iterators themselves, because we wouldn’t want to “consume” our tuple (leaving it empty) by iterating over it.</p>
<p>Here’s another iterator example. <code>zip</code> objects are iterators themselves (and we can see them being consumed).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb296"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="bu">zip</span>([<span class="st">'clinton'</span>, <span class="st">'bush'</span>, <span class="st">'obama'</span>, <span class="st">'trump'</span>], [<span class="st">'Dem'</span>, <span class="st">'Rep'</span>, <span class="st">'Dem'</span>, <span class="st">'Rep'</span>])</span>
<span id="cb296-2"><a href="#cb296-2" aria-hidden="true" tabindex="-1"></a><span class="bu">next</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>('clinton', 'Dem')</code></pre>
</div>
<div class="sourceCode cell-code" id="cb298"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb298-1"><a href="#cb298-1" aria-hidden="true" tabindex="-1"></a><span class="bu">next</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>('bush', 'Rep')</code></pre>
</div>
<div class="sourceCode cell-code" id="cb300"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a><span class="bu">next</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>('obama', 'Dem')</code></pre>
</div>
<div class="sourceCode cell-code" id="cb302"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a><span class="bu">next</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>('trump', 'Rep')</code></pre>
</div>
<div class="sourceCode cell-code" id="cb304"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a><span class="bu">next</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>StopIteration</code></pre>
</div>
</div>
<p>We can also go from an iterable object to a standard list:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb306"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="bu">zip</span>([<span class="st">'clinton'</span>, <span class="st">'bush'</span>, <span class="st">'obama'</span>, <span class="st">'trump'</span>], [<span class="st">'Dem'</span>, <span class="st">'Rep'</span>, <span class="st">'Dem'</span>, <span class="st">'Rep'</span>])</span>
<span id="cb306-2"><a href="#cb306-2" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[('clinton', 'Dem'), ('bush', 'Rep'), ('obama', 'Dem'), ('trump', 'Rep')]</code></pre>
</div>
</div>
</section>
<section id="python-object-protocols-example-2-context-managers-using-with" class="level3">
<h3 class="anchored" data-anchor-id="python-object-protocols-example-2-context-managers-using-with">Python object protocols: Example 2 – context managers using <code>with</code></h3>
<p>We’ve seen that the standard way to read/write to a file in Python uses <code>with</code>, like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb308"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb308-1"><a href="#cb308-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'myfile.txt'</span>, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb308-2"><a href="#cb308-2" aria-hidden="true" tabindex="-1"></a>     lines <span class="op">=</span> <span class="bu">file</span>.readlines()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This creates a “context manager” that is equivalent to:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb309"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a><span class="bu">file</span> <span class="op">=</span> <span class="bu">open</span>(<span class="st">'myfile.txt'</span>, <span class="st">'r'</span>)</span>
<span id="cb309-2"><a href="#cb309-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb309-3"><a href="#cb309-3" aria-hidden="true" tabindex="-1"></a>    lines <span class="op">=</span> <span class="bu">file</span>.readlines()</span>
<span id="cb309-4"><a href="#cb309-4" aria-hidden="true" tabindex="-1"></a><span class="cf">finally</span>:</span>
<span id="cb309-5"><a href="#cb309-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">file</span>.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With either approach, we get (1) exception handling in case something goes wrong with the read/write (in this case <code>readlines</code>) and (2) automatic closing of the file, regardless of what happens in the execution of the code, based on the <code>finally</code> block that does any needed cleanup.</p>
<p>What does this have to do with <em>dunder</em> methods and object protocols?</p>
<p>Well, one can use <code>with</code> with any class for which one wants to implements the context manager protocol by providing <code>__enter__</code> and <code>__exit__</code> methods. These are invoked before and after the code in the scope of the <code>with</code> block is run.</p>
<p>Here’s a basic example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb310"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb310-2"><a href="#cb310-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb310-3"><a href="#cb310-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyTimer(<span class="bu">object</span>):</span>
<span id="cb310-4"><a href="#cb310-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__enter__</span>(<span class="va">self</span>):</span>
<span id="cb310-5"><a href="#cb310-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Starting at </span><span class="sc">{</span>time<span class="sc">.</span>ctime()<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb310-6"><a href="#cb310-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb310-7"><a href="#cb310-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__exit__</span>(<span class="va">self</span>, exception_type, exception_value, traceback):</span>
<span id="cb310-8"><a href="#cb310-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Ending at </span><span class="sc">{</span>time<span class="sc">.</span>ctime()<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb310-9"><a href="#cb310-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb310-10"><a href="#cb310-10" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> MyTimer():</span>
<span id="cb310-11"><a href="#cb310-11" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.random.normal(size<span class="op">=</span><span class="dv">50000000</span>)</span>
<span id="cb310-12"><a href="#cb310-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">del</span> x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Starting at Mon Oct  6 08:56:13 2025.
Ending at Mon Oct  6 08:56:15 2025.</code></pre>
</div>
</div>
<p>A more useful example would be setting up a context manager to handle database queries by connecting to the database via <code>__enter__</code> and disconnecting via <code>__exit__</code>.</p>
</section>
</section>
</section>
<section id="functional-programming" class="level1">
<h1>7. Functional programming</h1>
<p>This section covers an approach to programming called <em>functional programming</em> as well as various concepts related to writing and using functions.</p>
<section id="functional-programming-in-python" class="level2">
<h2 class="anchored" data-anchor-id="functional-programming-in-python">Functional programming (in Python)</h2>
<section id="overview-of-functional-programming" class="level3">
<h3 class="anchored" data-anchor-id="overview-of-functional-programming">Overview of functional programming</h3>
<p>Functional programming is an approach to programming that emphasizes the use of modular, self-contained functions. Such functions should operate only on arguments provided to them (avoiding global variables), and <strong>produce no side effects</strong>, although in some cases there are good reasons for making an exception. Another aspect of functional programming is that functions are considered ‘first-class’ citizens in that they can be passed as arguments to another function, returned as the result of a function, and assigned to variables. In other words, a function can be treated as any other variable.</p>
<p>In many cases (including Python and R), anonymous functions (also called ‘lambda functions’) can be created on-the-fly for use in various circumstances.</p>
<p>One can do functional programming in Python by focusing on writing modular, self-contained functions rather than classes. And functions are first-class citizens. However, there are aspects of Python that do not align with the principles mentioned above.</p>
<ul>
<li>Python’s pass-by-reference behavior causes functions to potentially have the important side effects of modifying arguments that are mutable (e.g., lists and numpy arrays but not tuples) if the programmer is not careful about not modifying arguments within functions.</li>
<li>Some operations are carried out by statements (e.g., <code>import</code>, <code>def</code>) rather than functions.</li>
</ul>
<p>In contrast, R functions have pass-by-value behavior, which is more consistent with a pure functional programming approach.</p>
</section>
<section id="the-principle-of-no-side-effects" class="level3">
<h3 class="anchored" data-anchor-id="the-principle-of-no-side-effects">The principle of no side effects</h3>
<p>Before we discuss Python further, let’s consider how R behaves in more detail as R conforms more strictly to a functional programming perspective.</p>
<p>Most functions available in R (and ideally functions that you write as well) operate by taking in arguments and producing output that is then (presumably) used subsequently. The functions generally don’t have any effect on the state of your R environment/session other than the output they produce.</p>
<p>An important reason for this (plus for not using global variables) is that it means that it is easy for people using the language to understand what code does. Every function can be treated a black box – you don’t need to understand what happens in the function or worry that the function might do something unexpected (such as changing the value of one of your variables). The result of running code is simply the result of a composition of functions, as in mathematical function composition.</p>
<p>One aspect of this is that R uses a <em>pass-by-value</em> approach to function arguments. In R (but not Python), when you pass an object in as an argument and then modify it in the function, you are modifying a local copy of the variable that exists in the context (the <em>frame</em>) of the function and is deleted when the function call finishes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb312"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span></span>
<span id="cb312-2"><a href="#cb312-2" aria-hidden="true" tabindex="-1"></a>myfun <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb312-3"><a href="#cb312-3" aria-hidden="true" tabindex="-1"></a>      x[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb312-4"><a href="#cb312-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(x)</span>
<span id="cb312-5"><a href="#cb312-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(x)</span>
<span id="cb312-6"><a href="#cb312-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb312-7"><a href="#cb312-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-8"><a href="#cb312-8" aria-hidden="true" tabindex="-1"></a>new_x <span class="ot">&lt;-</span> <span class="fu">myfun</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 7 3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb314"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb314-1"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a>x   <span class="co"># unmodified</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 2 3</code></pre>
</div>
</div>
<p>In contrast, Python uses a <em>pass-by-reference</em> approach, seen here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb316"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb316-1"><a href="#cb316-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.array([<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>])</span>
<span id="cb316-2"><a href="#cb316-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> myfun(x):</span>
<span id="cb316-3"><a href="#cb316-3" aria-hidden="true" tabindex="-1"></a>  x[<span class="dv">1</span>] <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb316-4"><a href="#cb316-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> x</span>
<span id="cb316-5"><a href="#cb316-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb316-6"><a href="#cb316-6" aria-hidden="true" tabindex="-1"></a>new_x <span class="op">=</span> myfun(x)</span>
<span id="cb316-7"><a href="#cb316-7" aria-hidden="true" tabindex="-1"></a>x   <span class="co"># modified!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>array([1, 7, 3])</code></pre>
</div>
</div>
<p>And actually, given the pass-by-reference behavior, we would probably use a version of <code>myfun</code> that looks like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb318"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb318-1"><a href="#cb318-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.array([<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>])</span>
<span id="cb318-2"><a href="#cb318-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> myfun(x):</span>
<span id="cb318-3"><a href="#cb318-3" aria-hidden="true" tabindex="-1"></a>  x[<span class="dv">1</span>] <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb318-4"><a href="#cb318-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb318-5"><a href="#cb318-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb318-6"><a href="#cb318-6" aria-hidden="true" tabindex="-1"></a>myfun(x)</span>
<span id="cb318-7"><a href="#cb318-7" aria-hidden="true" tabindex="-1"></a>x   <span class="co"># modified!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>array([1, 7, 3])</code></pre>
</div>
</div>
<p>Note how easy it would be for a Python programmer to violate the ‘no side effects’ principle. In fact to avoid it, we need to do some additional work in terms of making a copy of <code>x</code> to a new location in memory before modifying it in the function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb320"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb320-1"><a href="#cb320-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.array([<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>])</span>
<span id="cb320-2"><a href="#cb320-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> myfun(x):</span>
<span id="cb320-3"><a href="#cb320-3" aria-hidden="true" tabindex="-1"></a>  y <span class="op">=</span> x.copy()</span>
<span id="cb320-4"><a href="#cb320-4" aria-hidden="true" tabindex="-1"></a>  y[<span class="dv">1</span>] <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb320-5"><a href="#cb320-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> y</span>
<span id="cb320-6"><a href="#cb320-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb320-7"><a href="#cb320-7" aria-hidden="true" tabindex="-1"></a>new_x <span class="op">=</span> myfun(x)</span>
<span id="cb320-8"><a href="#cb320-8" aria-hidden="true" tabindex="-1"></a>x   <span class="co"># no side effects!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>array([1, 2, 3])</code></pre>
</div>
</div>
<p>More on <a href="#pass-by-value-vs.-pass-by-reference">pass-by-value vs.&nbsp;pass-by-reference</a> later.</p>
<p>Even in R, there are some (necessary) exceptions to the idea of no side effects, such as <code>par()</code>, <code>library()</code>, and <code>plot()</code>.</p>
</section>
<section id="functions-are-first-class-objects" class="level3">
<h3 class="anchored" data-anchor-id="functions-are-first-class-objects">Functions are first-class objects</h3>
<p>Everything in Python is an object, including functions and classes. We can assign functions to variables in the same way we assign numeric and other values.</p>
<p>When we make an assignment we associate a name (a ‘reference’) with an object in memory. Python can find the object by using the name to look up the object in the namespace.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb322"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb322-1"><a href="#cb322-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb322-2"><a href="#cb322-2" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'int'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb324"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb324-1"><a href="#cb324-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb324-2"><a href="#cb324-2" aria-hidden="true" tabindex="-1"></a>    x([<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">5</span>])  <span class="co"># x is not a function (yet)</span></span>
<span id="cb324-3"><a href="#cb324-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> error:</span>
<span id="cb324-4"><a href="#cb324-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(error)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'int' object is not callable</code></pre>
</div>
<div class="sourceCode cell-code" id="cb326"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb326-1"><a href="#cb326-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="bu">sum</span></span>
<span id="cb326-2"><a href="#cb326-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb326-3"><a href="#cb326-3" aria-hidden="true" tabindex="-1"></a>x([<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb328"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb328-1"><a href="#cb328-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'builtin_function_or_method'&gt;</code></pre>
</div>
</div>
<p>We can call a function based on the text name of the function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb330"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb330-1"><a href="#cb330-1" aria-hidden="true" tabindex="-1"></a>function <span class="op">=</span> <span class="bu">getattr</span>(np, <span class="st">"mean"</span>)</span>
<span id="cb330-2"><a href="#cb330-2" aria-hidden="true" tabindex="-1"></a>function(np.array([<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>np.float64(2.0)</code></pre>
</div>
</div>
<p>We can also pass a function into another function as the actual function object. This is an important aspect of functional programming. We can do it with our own function or (as we’ll see shortly) with various built-in functions, such as <code>map</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb332"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb332-1"><a href="#cb332-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_fun(fun, a):</span>
<span id="cb332-2"><a href="#cb332-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fun(a)</span>
<span id="cb332-3"><a href="#cb332-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb332-4"><a href="#cb332-4" aria-hidden="true" tabindex="-1"></a>apply_fun(<span class="bu">round</span>, <span class="fl">3.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>4</code></pre>
</div>
</div>
<p>A function that takes a function as an argument, returns a function as a result, or both is known as a <em>higher-order function</em>.</p>
</section>
<section id="which-operations-are-function-calls" class="level3">
<h3 class="anchored" data-anchor-id="which-operations-are-function-calls">Which operations are function calls?</h3>
<p>Python provides various statements that are not formal function calls but allow one to modify the current Python session:</p>
<ul>
<li><code>import</code>: import modules or packages</li>
<li><code>def</code>: define functions or classes</li>
<li><code>return</code>: return results from a function</li>
<li><code>del</code>: remove an object</li>
</ul>
<p>As we saw earlier with <code>+</code> (<code>__add__</code>), operators are examples of generic function OOP, where the appropriate method of the class of the first operand is called.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb334"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb334-1"><a href="#cb334-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.array([<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>])</span>
<span id="cb334-2"><a href="#cb334-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">-</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>array([-1,  0,  1])</code></pre>
</div>
<div class="sourceCode cell-code" id="cb336"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb336-1"><a href="#cb336-1" aria-hidden="true" tabindex="-1"></a>x.<span class="fu">__sub__</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>array([-1,  0,  1])</code></pre>
</div>
<div class="sourceCode cell-code" id="cb338"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb338-1"><a href="#cb338-1" aria-hidden="true" tabindex="-1"></a>x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>array([0, 1, 2])</code></pre>
</div>
</div>
<p>Note that the use of the operator does not modify the object.</p>
<p>(Note that you can use <code>return(x)</code> and <code>del(x)</code> but behind the scenes the Python interpreter is intepreting those as <code>return x</code> and <code>del x</code>.)</p>
</section>
<section id="map-operations" class="level3">
<h3 class="anchored" data-anchor-id="map-operations">Map operations</h3>
<p>A <em>map</em> operation takes a function and runs the function on each element of some collection of items, analogous to a mathematical map. This kind of operation is very commonly used in programming, particularly functional programming, and often makes for clean, concise, and readable code.</p>
<p>Python provides a variety of map-type functions: <code>map</code> (a built-in) and <code>pandas.apply</code>. These are examples of higher-order functions – functions that take a function as an argument. Another map-type operation is <em>list comprehension</em>, shown here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb340"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb340-1"><a href="#cb340-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]</span>
<span id="cb340-2"><a href="#cb340-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> [<span class="bu">pow</span>(val, <span class="dv">2</span>) <span class="cf">for</span> val <span class="kw">in</span> x]</span>
<span id="cb340-3"><a href="#cb340-3" aria-hidden="true" tabindex="-1"></a>y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1, 4, 9]</code></pre>
</div>
</div>
<p>In Python, <code>map</code> is run on the elements of an <em>iterable</em> object. Such objects include lists as well as the result of <code>range()</code> and other functions that produce iterables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb342"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb342-1"><a href="#cb342-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> [<span class="fl">1.0</span>, <span class="op">-</span><span class="fl">2.7</span>, <span class="fl">3.5</span>, <span class="op">-</span><span class="fl">5.1</span>]</span>
<span id="cb342-2"><a href="#cb342-2" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(<span class="bu">map</span>(<span class="bu">abs</span>, x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1.0, 2.7, 3.5, 5.1]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb344"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb344-1"><a href="#cb344-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(<span class="bu">map</span>(<span class="bu">pow</span>, x, [<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1.0, 7.290000000000001, 12.25, 26.009999999999998]</code></pre>
</div>
</div>
<p>Or we can use <em>lambda</em> functions to define a function on the fly:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb346"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb346-1"><a href="#cb346-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> [<span class="fl">1.0</span>, <span class="op">-</span><span class="fl">2.7</span>, <span class="fl">3.5</span>, <span class="op">-</span><span class="fl">5.1</span>]</span>
<span id="cb346-2"><a href="#cb346-2" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> vals: vals <span class="op">*</span> <span class="dv">2</span>, x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A lambda function is a temporary function that is defined “on-the-fly” rather than in advance and is never given a name. (These are also sometimes called <em>anonymous</em> functions.)</p>
<p>If you need to pass another argument to the function you can use a lambda function as above or <code>functools.partial</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb347"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb347-1"><a href="#cb347-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb347-2"><a href="#cb347-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-3"><a href="#cb347-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new round function with 'ndigits' argument pre-set</span></span>
<span id="cb347-4"><a href="#cb347-4" aria-hidden="true" tabindex="-1"></a>round3 <span class="op">=</span> partial(<span class="bu">round</span>, ndigits <span class="op">=</span> <span class="dv">3</span>)</span>
<span id="cb347-5"><a href="#cb347-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-6"><a href="#cb347-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to a list of numbers</span></span>
<span id="cb347-7"><a href="#cb347-7" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(<span class="bu">map</span>(round3, [<span class="fl">32.134234</span>, <span class="fl">7.1</span>, <span class="fl">343.7775</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[32.134, 7.1, 343.777]</code></pre>
</div>
</div>
<p>Let’s compare using a map-style operation (with Pandas) to using a for loop to run a stratified analysis for a generic example (this code won’t run because the variables don’t exist):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb349"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb349-1"><a href="#cb349-1" aria-hidden="true" tabindex="-1"></a><span class="co"># stratification </span></span>
<span id="cb349-2"><a href="#cb349-2" aria-hidden="true" tabindex="-1"></a>subsets <span class="op">=</span> df.groupby(<span class="st">'grouping_variable'</span>)</span>
<span id="cb349-3"><a href="#cb349-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb349-4"><a href="#cb349-4" aria-hidden="true" tabindex="-1"></a><span class="co"># map using pandas.apply: one line, easy to understand</span></span>
<span id="cb349-5"><a href="#cb349-5" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> subsets.<span class="bu">apply</span>(analysis_function)</span>
<span id="cb349-6"><a href="#cb349-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb349-7"><a href="#cb349-7" aria-hidden="true" tabindex="-1"></a><span class="co"># for loop: needs storage set up and multiple lines</span></span>
<span id="cb349-8"><a href="#cb349-8" aria-hidden="true" tabindex="-1"></a>results <span class="op">&lt;-</span> []</span>
<span id="cb349-9"><a href="#cb349-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _,subset <span class="kw">in</span> subsets:   <span class="co"># iterate over the key-value pairs (the subsets)</span></span>
<span id="cb349-10"><a href="#cb349-10" aria-hidden="true" tabindex="-1"></a>  results.append(analysis_function(subset))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Map operations are also at the heart of the famous <em>MapReduce</em> framework, used in Hadoop and Spark for big data processing.</p>
</section>
</section>
<section id="function-evaluation-frames-and-the-call-stack" class="level2">
<h2 class="anchored" data-anchor-id="function-evaluation-frames-and-the-call-stack">Function evaluation, frames, and the call stack</h2>
<section id="overview-1" class="level3">
<h3 class="anchored" data-anchor-id="overview-1">Overview</h3>
<p>When we run code, we end up calling functions inside of other function calls. This leads to a nested series of function calls. The series of calls is the <em>call stack</em>. The stack operates like a stack of cafeteria trays - when a function is called, it is added to the stack (pushed) and when it finishes, it is removed (popped).</p>
<p>Understanding the series of calls is important when reading error messages and debugging. In Python, when an error occurs, the call stack is shown, which has the advantage of giving the complete history of what led to the error and the disadvantage of producing often very verbose output that can be hard to understand. (In contrast, in R, only the function in which the error occurs is shown, but you can see the full call stack by invoking <code>traceback()</code>.)</p>
<p>What happens when an Python function is evaluated?</p>
<ul>
<li>The user-provided function arguments are evaluated in the calling scope and the results are matched to the argument names in the function definition.</li>
<li>A new frame containing a new namespace is created to store information related to the function call and placed on the stack. Assignment to the argument names is done in the namespace, including any default arguments.</li>
<li>The function is evaluated in the (new) local scope. Any look-up of variables not found in the local scope (using the namespace that was created) is done using the lexical scoping rules to look in the series of enclosing scopes (if any exist), then in the global/module scope, and then in the built-ins scope.</li>
<li>When the function finishes, the return value is passed back to the calling scope and the frame is taken off the stack. The namespace is removed, unless the namespace is the enclosing scope for an existing namespace.</li>
</ul>
<p>I’m not expecting you to fully understand that previous paragraph and all the terms in it yet. We’ll see all the details as we proceed through this Unit.</p>
</section>
<section id="frames-and-the-call-stack" class="level3">
<h3 class="anchored" data-anchor-id="frames-and-the-call-stack">Frames and the call stack</h3>
<p>Python keeps track of the call stack. Each function call is associated with a frame that has a <em>namespace</em> that contains the local variables for that function call.</p>
<p>There are a bunch of functions that let us query what frames are on the stack and access objects in particular frames of interest. This gives us the ability to work with objects in the frame from which a function was called.</p>
<p>We can use functions from the <code>traceback</code> package to query the call stack.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb350"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb350-1"><a href="#cb350-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> traceback</span>
<span id="cb350-2"><a href="#cb350-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb350-3"><a href="#cb350-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> function_a():</span>
<span id="cb350-4"><a href="#cb350-4" aria-hidden="true" tabindex="-1"></a>    function_b()  <span class="co"># line 2 within function, line 4 overall</span></span>
<span id="cb350-5"><a href="#cb350-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb350-6"><a href="#cb350-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> function_b():</span>
<span id="cb350-7"><a href="#cb350-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># some comment</span></span>
<span id="cb350-8"><a href="#cb350-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># another comment</span></span>
<span id="cb350-9"><a href="#cb350-9" aria-hidden="true" tabindex="-1"></a>    function_c()  <span class="co"># line 4 within function, line 9 overall</span></span>
<span id="cb350-10"><a href="#cb350-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb350-11"><a href="#cb350-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> function_c():</span>
<span id="cb350-12"><a href="#cb350-12" aria-hidden="true" tabindex="-1"></a>    traceback.print_stack() <span class="co"># line 2 within, line 12 overall</span></span>
<span id="cb350-13"><a href="#cb350-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># raise RuntimeError("A fake error")</span></span>
<span id="cb350-14"><a href="#cb350-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb350-15"><a href="#cb350-15" aria-hidden="true" tabindex="-1"></a>function_a()    <span class="co"># line 1 relative to the call, line 15 overall</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we run that in Python (not via rendering the qmd file directly, because the line numbering shown is strange when things go through the quarto rendering process), we see this:</p>
<pre><code>  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
  File "&lt;stdin&gt;", line 2, in function_a
  File "&lt;stdin&gt;", line 4, in function_b
  File "&lt;stdin&gt;", line 2, in function_c</code></pre>
<p>If we run the code by putting it in a module, say <code>trace.py</code> and running <code>python trace.py</code>, we see this, with the line numbering relative to the overall file, but showing the same stack of function calls:</p>
<pre><code>  File "file.py", line 15, in &lt;module&gt;
    function_a()    # line 1 relative to the call, line 15 overall
  File "file.py", line 4, in function_a
    function_b()  # line 2 within function, line 4 overall
  File "file.py", line 9, in function_b
    function_c()  # line 4 within function, line 9 overall
  File "file.py", line 12, in function_c
    traceback.print_stack() # line 2 within, line 12 overall</code></pre>
<p>If we comment out the <code>print_stack()</code> call and uncomment the error, we see the same traceback information. That’s exactly what is happening when you get a long series of information when Python stops with an error.</p>
</section>
</section>
<section id="function-inputs-and-outputs" class="level2">
<h2 class="anchored" data-anchor-id="function-inputs-and-outputs">Function inputs and outputs</h2>
<section id="arguments" class="level3">
<h3 class="anchored" data-anchor-id="arguments">Arguments</h3>
<p>You can see the arguments (and any default values) for a function using the help system.</p>
<p>Let’s create an example function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb353"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add(x, y, z<span class="op">=</span><span class="dv">1</span>, absol<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb353-2"><a href="#cb353-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> absol:</span>
<span id="cb353-3"><a href="#cb353-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">abs</span>(x<span class="op">+</span>y<span class="op">+</span>z)</span>
<span id="cb353-4"><a href="#cb353-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb353-5"><a href="#cb353-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x<span class="op">+</span>y<span class="op">+</span>z</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When defining a function, arguments without defaults must come first.</p>
<p>When using a function, there are some rules that must be followed.</p>
<p>First, users must provide values for arguments without defaults.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb354"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb354-1"><a href="#cb354-1" aria-hidden="true" tabindex="-1"></a>add(<span class="dv">3</span>, <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb356"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb356-1"><a href="#cb356-1" aria-hidden="true" tabindex="-1"></a>add(<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>15</code></pre>
</div>
<div class="sourceCode cell-code" id="cb358"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb358-1"><a href="#cb358-1" aria-hidden="true" tabindex="-1"></a>add(<span class="dv">3</span>, <span class="dv">5</span>, absol<span class="op">=</span><span class="va">True</span>, z<span class="op">=-</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb360"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb360-1"><a href="#cb360-1" aria-hidden="true" tabindex="-1"></a>add(z<span class="op">=-</span><span class="dv">5</span>, x<span class="op">=</span><span class="dv">3</span>, y<span class="op">=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb362"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb362-1"><a href="#cb362-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb362-2"><a href="#cb362-2" aria-hidden="true" tabindex="-1"></a>    add(<span class="dv">3</span>)</span>
<span id="cb362-3"><a href="#cb362-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> error:</span>
<span id="cb362-4"><a href="#cb362-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(error)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>add() missing 1 required positional argument: 'y'</code></pre>
</div>
</div>
<p>Second, arguments can be specified by position (based on the order of the inputs) or by name (keyword), using <code>name=value</code>. The user needs to provide positional arguments first.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb364"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb364-1"><a href="#cb364-1" aria-hidden="true" tabindex="-1"></a>add(z<span class="op">=-</span><span class="dv">5</span>, <span class="dv">3</span>, <span class="dv">5</span>)  <span class="co">## Can't trap `SyntaxError` with `try`</span></span>
<span id="cb364-2"><a href="#cb364-2" aria-hidden="true" tabindex="-1"></a><span class="co"># SyntaxError: positional argument follows keyword argument  </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Functions may have unspecified arguments, which are designated using <code>*args</code>. (‘args’ is a convention - you can call it something else). Unspecified arguments occurring at the beginning of the argument list are generally a collection of like objects that will be manipulated (consider <code>print</code>).</p>
<p>Here’s an example where we see that we can manipulate <em>args</em>, which is a tuple, as desired.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb365"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb365-1"><a href="#cb365-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sum_args(<span class="op">*</span>args):</span>
<span id="cb365-2"><a href="#cb365-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(args[<span class="dv">2</span>])</span>
<span id="cb365-3"><a href="#cb365-3" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> <span class="bu">sum</span>(args)</span>
<span id="cb365-4"><a href="#cb365-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> total</span>
<span id="cb365-5"><a href="#cb365-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-6"><a href="#cb365-6" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> sum_args(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb367"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb367-1"><a href="#cb367-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(result)  <span class="co"># Output: 15</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>15</code></pre>
</div>
</div>
<p>This syntax also comes in handy for some existing functions, such as <code>os.path.join</code>, which can take either an arbitrary number of inputs or a list.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb369"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a>os.path.join(<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'c'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'a/b/c'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb371"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb371-1"><a href="#cb371-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> [<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'c'</span>]</span>
<span id="cb371-2"><a href="#cb371-2" aria-hidden="true" tabindex="-1"></a>os.path.join(<span class="op">*</span>x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'a/b/c'</code></pre>
</div>
</div>
<p><code>*args</code> only handles positional arguments. You’d need to also have <code>**kwargs</code> as an argument to handle keyword arguments. In the function, <code>args</code> will be a tuple while <code>kwargs</code> will be a dictionary.</p>
</section>
<section id="function-outputs" class="level3">
<h3 class="anchored" data-anchor-id="function-outputs">Function outputs</h3>
<p><code>return x</code> will specify <code>x</code> as the output of the function. <code>return</code> can occur anywhere in the function, and allows the function to exit as soon as it is done.</p>
<p>We can return multiple outputs using <code>return</code> - the return value will then be a tuple.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb373"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb373-1"><a href="#cb373-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f(x):</span>
<span id="cb373-2"><a href="#cb373-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb373-3"><a href="#cb373-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>x<span class="op">**</span><span class="dv">2</span></span>
<span id="cb373-4"><a href="#cb373-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb373-5"><a href="#cb373-5" aria-hidden="true" tabindex="-1"></a>        res <span class="op">=</span> x<span class="op">^</span><span class="dv">2</span></span>
<span id="cb373-6"><a href="#cb373-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x, res</span>
<span id="cb373-7"><a href="#cb373-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb373-8"><a href="#cb373-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb373-9"><a href="#cb373-9" aria-hidden="true" tabindex="-1"></a>f(<span class="op">-</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb375"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb375-1"><a href="#cb375-1" aria-hidden="true" tabindex="-1"></a>f(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(3, 1)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb377"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb377-1"><a href="#cb377-1" aria-hidden="true" tabindex="-1"></a>out1,out2 <span class="op">=</span> f(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you want a function to be invoked for its side effects, you can omit <code>return</code> or explicitly have <code>return None</code> or simply <code>return</code>.</p>
</section>
</section>
<section id="pass-by-value-vs.-pass-by-reference" class="level2">
<h2 class="anchored" data-anchor-id="pass-by-value-vs.-pass-by-reference">Pass by value vs.&nbsp;pass by reference</h2>
<p>When talking about programming languages, one often distinguishes <em>pass-by-value</em> and <em>pass-by-reference</em>.</p>
<p><em>Pass-by-value</em> means that when a function is called with one or more arguments, a copy is made of each argument and the function operates on those copies. In pass-by-value, changes to an argument made within a function do not affect the value of the argument in the calling environment.</p>
<p><em>Pass-by-reference</em> means that the arguments are not copied, but rather that information is passed allowing the function to find and modify the original value of the objects passed into the function. In pass-by-reference changes inside a function can affect the object outside of the function.</p>
<p>Pass-by-value is elegant and modular in that functions do not have side effects - the effect of the function occurs only through the return value of the function. However, it can be inefficient in terms of the amount of computation and of memory used. In contrast, pass-by-reference is more efficient, but also more dangerous and less modular. It’s more difficult to reason about code that uses pass-by-reference because effects of calling a function can be hidden inside the function. Thus pass-by-value is directly related to functional programming.</p>
<p>Arrays and other non-scalar objects in Python are pass-by-reference (but note that tuples are immutable, so one could not modify a tuple that is passed as an argument).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb378"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb378-1"><a href="#cb378-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> myfun(x):</span>
<span id="cb378-2"><a href="#cb378-2" aria-hidden="true" tabindex="-1"></a>    x[<span class="dv">1</span>] <span class="op">=</span> <span class="dv">99</span></span>
<span id="cb378-3"><a href="#cb378-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-4"><a href="#cb378-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb378-5"><a href="#cb378-5" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> myfun(y)</span>
<span id="cb378-6"><a href="#cb378-6" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(z)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'NoneType'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb380"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb380-1"><a href="#cb380-1" aria-hidden="true" tabindex="-1"></a>y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[0, 99, 2]</code></pre>
</div>
</div>
<p>Let’s see what operations cause arguments modified in a function to affect state outside of the function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb382"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb382-1"><a href="#cb382-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> myfun(f_scalar, f_x, f_x_new, f_x_newid, f_x_copy):</span>
<span id="cb382-2"><a href="#cb382-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="bu">id</span>(f_scalar))</span>
<span id="cb382-3"><a href="#cb382-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="bu">id</span>(f_x))</span>
<span id="cb382-4"><a href="#cb382-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `scalar` in global unaffected, as `f_scalar` is redefined.</span></span>
<span id="cb382-5"><a href="#cb382-5" aria-hidden="true" tabindex="-1"></a>    f_scalar <span class="op">=</span> <span class="dv">99</span>              </span>
<span id="cb382-6"><a href="#cb382-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-7"><a href="#cb382-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `x` in global is MODIFIED, as `x` and `f_x` have same id.</span></span>
<span id="cb382-8"><a href="#cb382-8" aria-hidden="true" tabindex="-1"></a>    f_x[<span class="dv">0</span>] <span class="op">=</span> <span class="dv">99</span>                 </span>
<span id="cb382-9"><a href="#cb382-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-10"><a href="#cb382-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `x_new` in global unaffected as `f_x_new` is redefined.</span></span>
<span id="cb382-11"><a href="#cb382-11" aria-hidden="true" tabindex="-1"></a>    f_x_new <span class="op">=</span> [<span class="dv">99</span>,<span class="dv">2</span>,<span class="dv">3</span>]        </span>
<span id="cb382-12"><a href="#cb382-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-13"><a href="#cb382-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `x_newid` in global is MODIFIED as `x_newid` and `y` have same id.</span></span>
<span id="cb382-14"><a href="#cb382-14" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> f_x_newid</span>
<span id="cb382-15"><a href="#cb382-15" aria-hidden="true" tabindex="-1"></a>    y[<span class="dv">0</span>] <span class="op">=</span> <span class="dv">99</span>              </span>
<span id="cb382-16"><a href="#cb382-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-17"><a href="#cb382-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `x_copy` in global is unaffected as `x_copy` has different id from `z`</span></span>
<span id="cb382-18"><a href="#cb382-18" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> f_x_copy.copy() </span>
<span id="cb382-19"><a href="#cb382-19" aria-hidden="true" tabindex="-1"></a>    z[<span class="dv">0</span>] <span class="op">=</span> <span class="dv">99</span>              </span>
<span id="cb382-20"><a href="#cb382-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-21"><a href="#cb382-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-22"><a href="#cb382-22" aria-hidden="true" tabindex="-1"></a>scalar <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb382-23"><a href="#cb382-23" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]</span>
<span id="cb382-24"><a href="#cb382-24" aria-hidden="true" tabindex="-1"></a>x_new <span class="op">=</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]</span>
<span id="cb382-25"><a href="#cb382-25" aria-hidden="true" tabindex="-1"></a>x_newid <span class="op">=</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]</span>
<span id="cb382-26"><a href="#cb382-26" aria-hidden="true" tabindex="-1"></a>x_copy <span class="op">=</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]</span>
<span id="cb382-27"><a href="#cb382-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-28"><a href="#cb382-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">id</span>(scalar))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231741070128</code></pre>
</div>
<div class="sourceCode cell-code" id="cb384"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb384-1"><a href="#cb384-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">id</span>(x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231505646144</code></pre>
</div>
<div class="sourceCode cell-code" id="cb386"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb386-1"><a href="#cb386-1" aria-hidden="true" tabindex="-1"></a>myfun(scalar, x, x_new, x_newid, x_copy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231741070128
128231505646144</code></pre>
</div>
</div>
<p>Here are the cases where state is preserved:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb388"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb388-1"><a href="#cb388-1" aria-hidden="true" tabindex="-1"></a>scalar</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb390"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb390-1"><a href="#cb390-1" aria-hidden="true" tabindex="-1"></a>x_new</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1, 2, 3]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb392"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb392-1"><a href="#cb392-1" aria-hidden="true" tabindex="-1"></a>x_copy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1, 2, 3]</code></pre>
</div>
</div>
<p>And here are the cases where state is modified:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb394"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb394-1"><a href="#cb394-1" aria-hidden="true" tabindex="-1"></a>x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[99, 2, 3]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb396"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb396-1"><a href="#cb396-1" aria-hidden="true" tabindex="-1"></a>x_newid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[99, 2, 3]</code></pre>
</div>
</div>
<p>Basically if you replace the reference (object name) then the state outside the function is preserved. That’s because a new local variable in the function scope is created. If you modify part of the object, state is not preserved.</p>
<p>The same behavior occurs with other mutable objects such as numpy arrays.</p>
<section id="pointers-optional" class="level3">
<h3 class="anchored" data-anchor-id="pointers-optional">Pointers (optional)</h3>
<p>To put pass-by-value vs.&nbsp;pass-by-reference in a broader context, I want to briefly discuss the idea of a pointer, common in compiled languages such as C.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb398"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb398-1"><a href="#cb398-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> x <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb398-2"><a href="#cb398-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span><span class="op">*</span> ptr<span class="op">;</span></span>
<span id="cb398-3"><a href="#cb398-3" aria-hidden="true" tabindex="-1"></a>ptr <span class="op">=</span> <span class="op">&amp;</span>x<span class="op">;</span></span>
<span id="cb398-4"><a href="#cb398-4" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>ptr <span class="op">*</span> <span class="dv">7</span><span class="op">;</span> <span class="co">// returns 21</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><code>int x=3</code> declares <code>x</code> to be an int and immediately defines it to have the value 3.</li>
<li>The <code>int*</code> declares <code>ptr</code> to be a pointer to (the address of) the integer <code>x</code>.</li>
<li><code>&amp;x</code> gets the address where <code>x</code> is stored.</li>
<li><code>*ptr</code> dereferences <code>ptr</code>, returning the value in that address (which is 3 since <code>ptr</code> is the address of <code>x</code>.</li>
</ul>
<p>Arrays in C are really pointers to a block of memory:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb399"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb399-1"><a href="#cb399-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> x<span class="op">[</span><span class="dv">10</span><span class="op">];</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this case <code>x</code> will be the address of the first element of the array. We can access the first element as <code>x[0]</code> or <code>*x</code>.</p>
<p>Why have we gone into this? In C, you can pass a pointer as an argument to a function. The result is that only the scalar address is copied and not the entire object, and inside the function, one can modify the original object, with the new value persisting on exit from the function. For example in the following example one passes in the address of an object and that object is then modified in place, affecting its value when the function call finishes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb400"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb400-1"><a href="#cb400-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> myCal<span class="op">(</span><span class="dt">int</span><span class="op">*</span> ptr<span class="op">){</span></span>
<span id="cb400-2"><a href="#cb400-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>ptr <span class="op">=</span> <span class="op">*</span>ptr <span class="op">+</span> <span class="op">*</span>ptr<span class="op">;</span></span>
<span id="cb400-3"><a href="#cb400-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb400-4"><a href="#cb400-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb400-5"><a href="#cb400-5" aria-hidden="true" tabindex="-1"></a>myCal<span class="op">(&amp;</span>x<span class="op">)</span>  # x itself will be modified</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So Python behaves similarly to the use of pointers in C.</p>
</section>
</section>
<section id="namespaces-and-scopes" class="level2">
<h2 class="anchored" data-anchor-id="namespaces-and-scopes">Namespaces and scopes</h2>
<p>As discussed <a href="https://docs.python.org/3/tutorial/classes.html#python-scopes-and-namespaces">here in the Python docs</a>, a <em>namespace</em> is a mapping from names to objects that allows Python to find objects by name via clear rules that enforce modularity and avoid name conflicts.</p>
<p>Namespaces are created and removed through the course of executing Python code. When a function is run, a namespace for the local variables in the function is created, and then deleted when the function finishes executing. Separate function calls (including recursive calls) have separate namespaces.</p>
<p><em>Scope</em> is closely related concept – a scope determines what namespaces are accessible from a given place in one’s code. Scopes are nested and determine where and in what order Python searches the various namespaces for objects.</p>
<p>Note that the ideas of namespaces and scopes are relevant in most other languages, though the details of how they work can differ.</p>
<p>These ideas are very important for modularity, isolating the names of objects to avoid conflicts.</p>
<p>This allows you to use the same name in different modules or submodules, as well as different packages using the same name.</p>
<p>Of course to make the objects in a module or package available we need to use <code>import</code>.</p>
<p>Consider what happens if you have two modules that both use <code>x</code> and you import <code>x</code> using <code>from</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb401"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb401-1"><a href="#cb401-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mypkg.mymod <span class="im">import</span> x</span>
<span id="cb401-2"><a href="#cb401-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mypkg.mysubpkg <span class="im">import</span> x</span>
<span id="cb401-3"><a href="#cb401-3" aria-hidden="true" tabindex="-1"></a>x  <span class="co"># which x is used?</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ve added <code>x</code> twice to the namespace of the global scope. Are both available? Did one ‘overwrite’ the other? How do I access the other one?</p>
<p>This is much better:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb402"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb402-1"><a href="#cb402-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mypkg</span>
<span id="cb402-2"><a href="#cb402-2" aria-hidden="true" tabindex="-1"></a>mypkg.x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb404"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb404-1"><a href="#cb404-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mypkg.mysubpkg</span>
<span id="cb404-2"><a href="#cb404-2" aria-hidden="true" tabindex="-1"></a>mypkg.mysubpkg.x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>999</code></pre>
</div>
</div>
<p>Side note: notice that <code>import mypkg</code> causes the name <code>mypkg</code> itself to be in the current (global) scope.</p>
<p>We can see the objects in a given namespace/scope using <code>dir()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb406"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb406-1"><a href="#cb406-1" aria-hidden="true" tabindex="-1"></a>xyz <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb406-2"><a href="#cb406-2" aria-hidden="true" tabindex="-1"></a><span class="bu">dir</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['Bear', 'GrizzlyBear', 'MyTimer', '__annotations__', '__builtins__', '__doc__', '__loader__', '__name__', '__package__', '__spec__', 'add', 'apply_fun', 'content', 'copy', 'f', 'files', 'foo', 'function', 'io', 'it', 'item', 'm', 'math', 'myList', 'mydict', 'myfun', 'myit', 'mylist', 'mymod', 'mypkg', 'myts', 'myts2', 'myts_full_copy', 'myts_ref', 'mytuple', 'new_x', 'np', 'num399', 'os', 'out1', 'out2', 'partial', 'pattern', 'platform', 'plt', 'r', 're', 'result', 'return_group', 'round3', 's', 'scalar', 'smokey', 'st', 'stream', 'subprocess', 'sum_args', 'sys', 'text', 'time', 'tmp', 'tsSimClass', 'x', 'x_copy', 'x_new', 'x_newid', 'xyz', 'y', 'y1', 'y2', 'y3', 'yog', 'yogi', 'z']</code></pre>
</div>
<div class="sourceCode cell-code" id="cb408"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb408-1"><a href="#cb408-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mypkg</span>
<span id="cb408-2"><a href="#cb408-2" aria-hidden="true" tabindex="-1"></a><span class="bu">dir</span>(mypkg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['__builtins__', '__cached__', '__doc__', '__file__', '__loader__', '__name__', '__package__', '__path__', '__spec__', 'auxil', 'myfun', 'myfun10', 'mymod', 'mysubpkg', 'x']</code></pre>
</div>
<div class="sourceCode cell-code" id="cb410"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb410-1"><a href="#cb410-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mypkg.mymod</span>
<span id="cb410-2"><a href="#cb410-2" aria-hidden="true" tabindex="-1"></a><span class="bu">dir</span>(mypkg.mymod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['__builtins__', '__cached__', '__doc__', '__file__', '__loader__', '__name__', '__package__', '__spec__', '_helper', 'myfun', 'myfun10', 'x']</code></pre>
</div>
<div class="sourceCode cell-code" id="cb412"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb412-1"><a href="#cb412-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> builtins</span>
<span id="cb412-2"><a href="#cb412-2" aria-hidden="true" tabindex="-1"></a><span class="bu">dir</span>(builtins)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['ArithmeticError', 'AssertionError', 'AttributeError', 'BaseException', 'BaseExceptionGroup', 'BlockingIOError', 'BrokenPipeError', 'BufferError', 'BytesWarning', 'ChildProcessError', 'ConnectionAbortedError', 'ConnectionError', 'ConnectionRefusedError', 'ConnectionResetError', 'DeprecationWarning', 'EOFError', 'Ellipsis', 'EncodingWarning', 'EnvironmentError', 'Exception', 'ExceptionGroup', 'False', 'FileExistsError', 'FileNotFoundError', 'FloatingPointError', 'FutureWarning', 'GeneratorExit', 'IOError', 'ImportError', 'ImportWarning', 'IndentationError', 'IndexError', 'InterruptedError', 'IsADirectoryError', 'KeyError', 'KeyboardInterrupt', 'LookupError', 'MemoryError', 'ModuleNotFoundError', 'NameError', 'None', 'NotADirectoryError', 'NotImplemented', 'NotImplementedError', 'OSError', 'OverflowError', 'PendingDeprecationWarning', 'PermissionError', 'ProcessLookupError', 'PythonFinalizationError', 'RecursionError', 'ReferenceError', 'ResourceWarning', 'RuntimeError', 'RuntimeWarning', 'StopAsyncIteration', 'StopIteration', 'SyntaxError', 'SyntaxWarning', 'SystemError', 'SystemExit', 'TabError', 'TimeoutError', 'True', 'TypeError', 'UnboundLocalError', 'UnicodeDecodeError', 'UnicodeEncodeError', 'UnicodeError', 'UnicodeTranslateError', 'UnicodeWarning', 'UserWarning', 'ValueError', 'Warning', 'ZeroDivisionError', '_', '_IncompleteInputError', '__build_class__', '__debug__', '__doc__', '__import__', '__loader__', '__name__', '__package__', '__spec__', 'abs', 'aiter', 'all', 'anext', 'any', 'ascii', 'bin', 'bool', 'breakpoint', 'bytearray', 'bytes', 'callable', 'chr', 'classmethod', 'compile', 'complex', 'copyright', 'credits', 'delattr', 'dict', 'dir', 'divmod', 'enumerate', 'eval', 'exec', 'exit', 'filter', 'float', 'format', 'frozenset', 'getattr', 'globals', 'hasattr', 'hash', 'help', 'hex', 'id', 'input', 'int', 'isinstance', 'issubclass', 'iter', 'len', 'license', 'list', 'locals', 'map', 'max', 'memoryview', 'min', 'next', 'object', 'oct', 'open', 'ord', 'pow', 'print', 'property', 'quit', 'range', 'repr', 'reversed', 'round', 'set', 'setattr', 'slice', 'sorted', 'staticmethod', 'str', 'sum', 'super', 'tuple', 'type', 'vars', 'zip']</code></pre>
</div>
</div>
<p>Here are the key scopes to be aware of, in order (“LEGB”) of how the namespaces are searched:</p>
<ul>
<li><strong>L</strong>ocal scope: objects available within function (or class method).</li>
<li>non-local (<strong>E</strong>nclosing) scope: objects available from functions enclosing a given function (we’ll talk about this more later; this relates to <em>lexical scoping</em>).</li>
<li><strong>G</strong>lobal (aka ‘module’) scope: objects available in the module in which the function is defined (which may simply be the default global scope when you start the Python interpreter). This is also the local scope if the code is not executing inside a function.</li>
<li><strong>B</strong>uilt-ins scope: objects provided by Python through the built-ins module but available from anywhere.</li>
</ul>
<p>Note that <code>import</code> adds the name of the imported module to the namespace of the current (i.e., local) scope.</p>
<p>We can see the local and global namespaces using <code>locals()</code> and <code>globals()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb414"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb414-1"><a href="#cb414-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> local.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>gx = 7

def myfun(z):
    y = z*3
    print("local: ", locals())
    print("global: ", globals())</code></pre>
</div>
</div>
<p>Run the following code to see what is in the different namespaces:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb416"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb416-1"><a href="#cb416-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> local</span>
<span id="cb416-2"><a href="#cb416-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb416-3"><a href="#cb416-3" aria-hidden="true" tabindex="-1"></a>gx <span class="op">=</span> <span class="dv">99</span></span>
<span id="cb416-4"><a href="#cb416-4" aria-hidden="true" tabindex="-1"></a>local.myfun(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Strangely (for me being more used to R, where package namespaces are ‘locked’ such that objects can’t be added), we can add an object to a namespace created from a module or package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb417"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb417-1"><a href="#cb417-1" aria-hidden="true" tabindex="-1"></a>mymod.x <span class="op">=</span> <span class="dv">33</span></span>
<span id="cb417-2"><a href="#cb417-2" aria-hidden="true" tabindex="-1"></a><span class="bu">dir</span>(mymod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['__builtins__', '__cached__', '__doc__', '__file__', '__loader__', '__name__', '__package__', '__spec__', 'myfun', 'range', 'x']</code></pre>
</div>
<div class="sourceCode cell-code" id="cb419"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb419-1"><a href="#cb419-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb419-2"><a href="#cb419-2" aria-hidden="true" tabindex="-1"></a>np.x <span class="op">=</span> <span class="dv">33</span></span>
<span id="cb419-3"><a href="#cb419-3" aria-hidden="true" tabindex="-1"></a><span class="co">'x'</span> <span class="kw">in</span> <span class="bu">dir</span>(np)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True</code></pre>
</div>
</div>
<p>As more motivation, consider this example.</p>
<p>Suppose we have this code in a module named <code>test_scope.py</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb421"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb421-1"><a href="#cb421-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> test_scope.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>magic_number = 2

def transform(x):
    return x*5

def myfun(val):
    return(transform(val) * magic_number)</code></pre>
</div>
</div>
<p>Now suppose we also define <code>magic_number</code> and <code>transform()</code> in the scope in which <code>myfun</code> is called from.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb423"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb423-1"><a href="#cb423-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> test_scope</span>
<span id="cb423-2"><a href="#cb423-2" aria-hidden="true" tabindex="-1"></a>magic_number <span class="op">=</span> <span class="dv">900</span></span>
<span id="cb423-3"><a href="#cb423-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> transform(x):</span>
<span id="cb423-4"><a href="#cb423-4" aria-hidden="true" tabindex="-1"></a>   <span class="bu">print</span>(<span class="st">"haha"</span>)</span>
<span id="cb423-5"><a href="#cb423-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb423-6"><a href="#cb423-6" aria-hidden="true" tabindex="-1"></a>test_scope.myfun(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>30</code></pre>
</div>
</div>
<p>We see that Python uses <code>magic_number</code> and <code>transform()</code> from the module. What would be bad about using <code>magic_number</code> or <code>transform()</code> from the scope of the Python session rather than the scope of the module?</p>
<p>Consider a case where instead of using the <code>test_scope.py</code> module we were using code from a package and that code has a variable called <code>magic_number</code> or function called <code>transform</code>.</p>
<section id="lexical-scoping-and-enclosing-scopes" class="level3">
<h3 class="anchored" data-anchor-id="lexical-scoping-and-enclosing-scopes">Lexical scoping and enclosing scopes</h3>
<p>In this section, we seek to understand what happens in the following circumstance. Namely, where does Python get the value for the object <code>x</code>?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb425"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb425-1"><a href="#cb425-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f(y):</span>
<span id="cb425-2"><a href="#cb425-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> x <span class="op">+</span> y</span>
<span id="cb425-3"><a href="#cb425-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb425-4"><a href="#cb425-4" aria-hidden="true" tabindex="-1"></a>f(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The answer depends on where <code>f</code> is defined. If it is defined in a nested fashion within another function (or functions), then the lookup occurs in the (enclosing) scope(s) of those functions.</p>
<p><strong>The enclosing scope is the scope in which a function is defined, not the scope from which a function is called.</strong></p>
<p>Once the enclosing scopes are searched, if the object name is not found, then Python looks in the global/module scope where the function is defined. This is not considered part of the enclosing scope, but it does still follow the rule of looking where the function is defined, not where it is called from.</p>
<p>This approach is called <em>lexical scoping</em>. R and many other languages also use lexical scoping.</p>
<p>The behavior of looking up object names based on where functions are defined rather than where they are called from extends the local-global scoping discussed in the previous section, with similar motivation.</p>
<p>Let’s dig deeper to understand where Python looks for non-local variables, illustrating lexical scoping and the LEGB rule:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb426"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb426-1"><a href="#cb426-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Case 1</span></span>
<span id="cb426-2"><a href="#cb426-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb426-3"><a href="#cb426-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f2():</span>
<span id="cb426-4"><a href="#cb426-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(x)</span>
<span id="cb426-5"><a href="#cb426-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb426-6"><a href="#cb426-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f():</span>
<span id="cb426-7"><a href="#cb426-7" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb426-8"><a href="#cb426-8" aria-hidden="true" tabindex="-1"></a>    f2()</span>
<span id="cb426-9"><a href="#cb426-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb426-10"><a href="#cb426-10" aria-hidden="true" tabindex="-1"></a>f() <span class="co"># what will happen?</span></span>
<span id="cb426-11"><a href="#cb426-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb426-12"><a href="#cb426-12" aria-hidden="true" tabindex="-1"></a><span class="co">## Case 2</span></span>
<span id="cb426-13"><a href="#cb426-13" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb426-14"><a href="#cb426-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f2()</span>
<span id="cb426-15"><a href="#cb426-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(x)</span>
<span id="cb426-16"><a href="#cb426-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb426-17"><a href="#cb426-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f():</span>
<span id="cb426-18"><a href="#cb426-18" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb426-19"><a href="#cb426-19" aria-hidden="true" tabindex="-1"></a>    f2()</span>
<span id="cb426-20"><a href="#cb426-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb426-21"><a href="#cb426-21" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb426-22"><a href="#cb426-22" aria-hidden="true" tabindex="-1"></a>f() <span class="co"># what will happen?</span></span>
<span id="cb426-23"><a href="#cb426-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb426-24"><a href="#cb426-24" aria-hidden="true" tabindex="-1"></a><span class="co">## Case 3</span></span>
<span id="cb426-25"><a href="#cb426-25" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb426-26"><a href="#cb426-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f():</span>
<span id="cb426-27"><a href="#cb426-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> f2():</span>
<span id="cb426-28"><a href="#cb426-28" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(x)        </span>
<span id="cb426-29"><a href="#cb426-29" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb426-30"><a href="#cb426-30" aria-hidden="true" tabindex="-1"></a>    f2()</span>
<span id="cb426-31"><a href="#cb426-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb426-32"><a href="#cb426-32" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb426-33"><a href="#cb426-33" aria-hidden="true" tabindex="-1"></a>f() <span class="co"># what will happen?</span></span>
<span id="cb426-34"><a href="#cb426-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb426-35"><a href="#cb426-35" aria-hidden="true" tabindex="-1"></a><span class="co">## Case 4</span></span>
<span id="cb426-36"><a href="#cb426-36" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb426-37"><a href="#cb426-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f():</span>
<span id="cb426-38"><a href="#cb426-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> f2():</span>
<span id="cb426-39"><a href="#cb426-39" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(x)</span>
<span id="cb426-40"><a href="#cb426-40" aria-hidden="true" tabindex="-1"></a>    f2()</span>
<span id="cb426-41"><a href="#cb426-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb426-42"><a href="#cb426-42" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb426-43"><a href="#cb426-43" aria-hidden="true" tabindex="-1"></a>f() <span class="co"># what will happen?</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s a tricky example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb427"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb427-1"><a href="#cb427-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb427-2"><a href="#cb427-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun_constructor():</span>
<span id="cb427-3"><a href="#cb427-3" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb427-4"><a href="#cb427-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> g(x):</span>
<span id="cb427-5"><a href="#cb427-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x <span class="op">+</span> y</span>
<span id="cb427-6"><a href="#cb427-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> g</span>
<span id="cb427-7"><a href="#cb427-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb427-8"><a href="#cb427-8" aria-hidden="true" tabindex="-1"></a><span class="co">## fun_constructor() creates functions</span></span>
<span id="cb427-9"><a href="#cb427-9" aria-hidden="true" tabindex="-1"></a>myfun <span class="op">=</span> fun_constructor()</span>
<span id="cb427-10"><a href="#cb427-10" aria-hidden="true" tabindex="-1"></a>myfun(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s work through this:</p>
<ol type="1">
<li>What is the enclosing scope for the function <code>g()</code>?</li>
<li>Which <code>y</code> does <code>g()</code> use?</li>
<li>Where is <code>myfun</code> defined (this is tricky – how does <code>myfun</code> relate to <code>g</code>)?</li>
<li>What is the enclosing scope for <code>myfun()</code>?</li>
<li>When <code>fun_constructor()</code> finishes, does its scope (and namespace) disappear? What would happen if it did?</li>
<li>What does <code>myfun</code> use for <code>y</code>?</li>
</ol>
<p>We can use the <code>inspect</code> package to see information about the closure.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb428"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb428-1"><a href="#cb428-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> inspect</span>
<span id="cb428-2"><a href="#cb428-2" aria-hidden="true" tabindex="-1"></a>inspect.getclosurevars(myfun)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ClosureVars(nonlocals={}, globals={}, builtins={'id': &lt;built-in function id&gt;, 'print': &lt;built-in function print&gt;}, unbound={'copy'})</code></pre>
</div>
</div>
<p>(Note that I haven’t fully investigated the use of <code>inspect</code>, but it looks like it has a lot of useful tools.)</p>
<p>Be careful when using variables from non-local scopes as the value of that variable may well not be what you expect it to be. In general one wants to think carefully before using variables that are taken from outside the local scope, but in some cases it can be useful.</p>
<p>Next we’ll see some ways of accessing variables outside of the local scope.</p>
</section>
<section id="global-and-non-local-variables" class="level3">
<h3 class="anchored" data-anchor-id="global-and-non-local-variables">Global and non-local variables</h3>
<p>We can create and modify global variables and variables in the enclosing scope using <code>global</code> and <code>nonlocal</code> respectively. Note that <em>global</em> is in the context of the current module so this could be a variable in your current Python session if you’re working with functions defined in that session or a global variable in a module or package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb430"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb430-1"><a href="#cb430-1" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> x</span>
<span id="cb430-2"><a href="#cb430-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-3"><a href="#cb430-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> myfun():</span>
<span id="cb430-4"><a href="#cb430-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> x</span>
<span id="cb430-5"><a href="#cb430-5" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb430-6"><a href="#cb430-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-7"><a href="#cb430-7" aria-hidden="true" tabindex="-1"></a>myfun()</span>
<span id="cb430-8"><a href="#cb430-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb432"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb432-1"><a href="#cb432-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="dv">9</span></span>
<span id="cb432-2"><a href="#cb432-2" aria-hidden="true" tabindex="-1"></a>myfun()</span>
<span id="cb432-3"><a href="#cb432-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>7</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb434"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb434-1"><a href="#cb434-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> outer_function():</span>
<span id="cb434-2"><a href="#cb434-2" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="dv">10</span>  <span class="co"># Outer variable</span></span>
<span id="cb434-3"><a href="#cb434-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> inner_function():</span>
<span id="cb434-4"><a href="#cb434-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">nonlocal</span> x</span>
<span id="cb434-5"><a href="#cb434-5" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="dv">20</span>  <span class="co"># Modify the outer variable.</span></span>
<span id="cb434-6"><a href="#cb434-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(x)  <span class="co"># Output: 10</span></span>
<span id="cb434-7"><a href="#cb434-7" aria-hidden="true" tabindex="-1"></a>    inner_function()</span>
<span id="cb434-8"><a href="#cb434-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(x)  <span class="co"># Output: 20</span></span>
<span id="cb434-9"><a href="#cb434-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-10"><a href="#cb434-10" aria-hidden="true" tabindex="-1"></a>outer_function()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>10
20</code></pre>
</div>
</div>
<p>In R, one can do similar things using the global assignment operator <code>&lt;&lt;-</code>.</p>
</section>
<section id="closures" class="level3">
<h3 class="anchored" data-anchor-id="closures">Closures</h3>
<p>One way to associate data with functions is to use a <em>closure</em>. This is a functional programming way to achieve something like an OOP class. This <a href="https://en.wikipedia.org/wiki/Closure_(computer_programming)">Wikipedia entry</a> nicely summarizes the idea, which is a general functional programming idea and not specific to Python.</p>
<p>Using a closure involves creating one (or more functions) within a function call and returning the function(s) as the output. When one executes the original function (the constructor), the new function(s) is created and returned and one can then call that function(s). The function then can access objects in the enclosing scope (the scope of the constructor) and can use <code>nonlocal</code> to assign into the enclosing scope, to which the function (or the multiple functions) have access. The nice thing about this compared to using a global variable is that the data in the closure is bound up with the function(s) and is protected from being changed by the user.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb436"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb436-1"><a href="#cb436-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb436-2"><a href="#cb436-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> scaler_constructor(data):</span>
<span id="cb436-3"><a href="#cb436-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> g(param):</span>
<span id="cb436-4"><a href="#cb436-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> param <span class="op">*</span> data</span>
<span id="cb436-5"><a href="#cb436-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> g</span>
<span id="cb436-6"><a href="#cb436-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-7"><a href="#cb436-7" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> scaler_constructor(x)</span>
<span id="cb436-8"><a href="#cb436-8" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> x <span class="co"># to demonstrate we no longer need x</span></span>
<span id="cb436-9"><a href="#cb436-9" aria-hidden="true" tabindex="-1"></a>scaler(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>array([-4.5020648 , -3.25168752, -4.05046623,  0.66985868,  3.50796174])</code></pre>
</div>
<div class="sourceCode cell-code" id="cb438"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb438-1"><a href="#cb438-1" aria-hidden="true" tabindex="-1"></a>scaler(<span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>array([-9.0041296 , -6.50337504, -8.10093246,  1.33971736,  7.01592347])</code></pre>
</div>
</div>
<p>So calling <code>scaler(3)</code> multiplies 3 by the value of <code>data</code> stored in the closure (the namespace of the enclosing scope) of the function <code>scaler</code>.</p>
<p>Note that it can be hard to inspect the memory use involved in the closure.</p>
<p>Here’s a more realistic example. There are other ways you could do this, but this is slick:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb440"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb440-1"><a href="#cb440-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_container(n):</span>
<span id="cb440-2"><a href="#cb440-2" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.zeros(n)</span>
<span id="cb440-3"><a href="#cb440-3" aria-hidden="true" tabindex="-1"></a>    i <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb440-4"><a href="#cb440-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> store(value <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb440-5"><a href="#cb440-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">nonlocal</span> x, i</span>
<span id="cb440-6"><a href="#cb440-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> value <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb440-7"><a href="#cb440-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> x</span>
<span id="cb440-8"><a href="#cb440-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb440-9"><a href="#cb440-9" aria-hidden="true" tabindex="-1"></a>            x[i] <span class="op">=</span> value</span>
<span id="cb440-10"><a href="#cb440-10" aria-hidden="true" tabindex="-1"></a>            i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb440-11"><a href="#cb440-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> store</span>
<span id="cb440-12"><a href="#cb440-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-13"><a href="#cb440-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-14"><a href="#cb440-14" aria-hidden="true" tabindex="-1"></a>nboot <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb440-15"><a href="#cb440-15" aria-hidden="true" tabindex="-1"></a>bootmeans <span class="op">=</span> make_container(nboot)</span>
<span id="cb440-16"><a href="#cb440-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-17"><a href="#cb440-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb440-18"><a href="#cb440-18" aria-hidden="true" tabindex="-1"></a>iris <span class="op">=</span> pd.read_csv(<span class="st">'https://raw.githubusercontent.com/pandas-dev/pandas/master/pandas/tests/io/data/csv/iris.csv'</span>)</span>
<span id="cb440-19"><a href="#cb440-19" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> iris[<span class="st">'SepalLength'</span>]</span>
<span id="cb440-20"><a href="#cb440-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-21"><a href="#cb440-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(nboot): </span>
<span id="cb440-22"><a href="#cb440-22" aria-hidden="true" tabindex="-1"></a>    bootmeans(np.mean(np.random.choice(data, size <span class="op">=</span> <span class="bu">len</span>(data), replace <span class="op">=</span> <span class="va">True</span>)))</span>
<span id="cb440-23"><a href="#cb440-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-24"><a href="#cb440-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-25"><a href="#cb440-25" aria-hidden="true" tabindex="-1"></a>bootmeans()</span>
<span id="cb440-26"><a href="#cb440-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-27"><a href="#cb440-27" aria-hidden="true" tabindex="-1"></a>bootmeans.__closure__</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Closures are also used as “function factories” (where the outer (generator) function is also called a “factory function”) to easily generate a set of related functions. Here’s an example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb441"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb441-1"><a href="#cb441-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> number_formatter(notation<span class="op">=</span><span class="st">'US'</span>):</span>
<span id="cb441-2"><a href="#cb441-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb441-3"><a href="#cb441-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Creates a closure for formatting decimal numbers.</span></span>
<span id="cb441-4"><a href="#cb441-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb441-5"><a href="#cb441-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb441-6"><a href="#cb441-6" aria-hidden="true" tabindex="-1"></a><span class="co">        notation (str): 'US' for US notation (commas for thousands, period for decimal)</span></span>
<span id="cb441-7"><a href="#cb441-7" aria-hidden="true" tabindex="-1"></a><span class="co">                        'EU' for European notation (periods for thousands, comma for decimal)</span></span>
<span id="cb441-8"><a href="#cb441-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb441-9"><a href="#cb441-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb441-10"><a href="#cb441-10" aria-hidden="true" tabindex="-1"></a><span class="co">        function: A closure that formats numbers according to the specified notation</span></span>
<span id="cb441-11"><a href="#cb441-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb441-12"><a href="#cb441-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> format_number(number):</span>
<span id="cb441-13"><a href="#cb441-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">## GitHub Copilot suggested the `number:,` syntax and the string replace approach.</span></span>
<span id="cb441-14"><a href="#cb441-14" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>number<span class="sc">:,}</span><span class="ss">"</span></span>
<span id="cb441-15"><a href="#cb441-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> notation <span class="op">==</span> <span class="st">'US'</span>:</span>
<span id="cb441-16"><a href="#cb441-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># US notation: 1,234.56</span></span>
<span id="cb441-17"><a href="#cb441-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> result</span>
<span id="cb441-18"><a href="#cb441-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> notation <span class="op">==</span> <span class="st">'EU'</span>:</span>
<span id="cb441-19"><a href="#cb441-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># European notation: 1.234,56</span></span>
<span id="cb441-20"><a href="#cb441-20" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Swap commas and periods</span></span>
<span id="cb441-21"><a href="#cb441-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> result.replace(<span class="st">','</span>, <span class="st">'TEMP'</span>).replace(<span class="st">'.'</span>, <span class="st">','</span>).replace(<span class="st">'TEMP'</span>, <span class="st">'.'</span>)</span>
<span id="cb441-22"><a href="#cb441-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb441-23"><a href="#cb441-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Notation must be 'US' or 'EU'"</span>)</span>
<span id="cb441-24"><a href="#cb441-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb441-25"><a href="#cb441-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> format_number</span>
<span id="cb441-26"><a href="#cb441-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb441-27"><a href="#cb441-27" aria-hidden="true" tabindex="-1"></a>us_printer <span class="op">=</span> number_formatter(<span class="st">'US'</span>)</span>
<span id="cb441-28"><a href="#cb441-28" aria-hidden="true" tabindex="-1"></a>eu_printer <span class="op">=</span> number_formatter(<span class="st">'EU'</span>)</span>
<span id="cb441-29"><a href="#cb441-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb441-30"><a href="#cb441-30" aria-hidden="true" tabindex="-1"></a>us_printer(<span class="fl">1234.56</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'1,234.56'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb443"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb443-1"><a href="#cb443-1" aria-hidden="true" tabindex="-1"></a>eu_printer(<span class="fl">1234.56</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'1.234,56'</code></pre>
</div>
</div>
</section>
</section>
<section id="decorators" class="level2">
<h2 class="anchored" data-anchor-id="decorators">Decorators</h2>
<p>Now that we’ve seen function generators, it’s straightforward to discuss <em>decorators</em>.</p>
<p>A decorator is a wrapper around a function that extends the functionality of the function without actually modifying the function.</p>
<p>We can create a simple decorator “manually” like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb445"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb445-1"><a href="#cb445-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> verbosity_wrapper(myfun):</span>
<span id="cb445-2"><a href="#cb445-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> wrapper(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb445-3"><a href="#cb445-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Starting </span><span class="sc">{</span>myfun<span class="sc">.</span><span class="va">__name__</span><span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb445-4"><a href="#cb445-4" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> myfun(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb445-5"><a href="#cb445-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Finishing </span><span class="sc">{</span>myfun<span class="sc">.</span><span class="va">__name__</span><span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb445-6"><a href="#cb445-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> output</span>
<span id="cb445-7"><a href="#cb445-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> wrapper</span>
<span id="cb445-8"><a href="#cb445-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb445-9"><a href="#cb445-9" aria-hidden="true" tabindex="-1"></a>verbose_rnorm <span class="op">=</span> verbosity_wrapper(np.random.normal)</span>
<span id="cb445-10"><a href="#cb445-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb445-11"><a href="#cb445-11" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> verbose_rnorm(size <span class="op">=</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Starting normal.
Finishing normal.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb447"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb447-1"><a href="#cb447-1" aria-hidden="true" tabindex="-1"></a>x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>array([ 1.07413602,  0.20128607, -1.09658699, -1.93034821, -2.11644448])</code></pre>
</div>
</div>
<p>Python provides syntax that helps you create decorators with less work (this is an example of the general idea of <em>syntactic sugar</em>).</p>
<p>We can easily apply our decorator defined above to a function as follows. Now the function name refers to the wrapped version of the function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb449"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb449-1"><a href="#cb449-1" aria-hidden="true" tabindex="-1"></a><span class="at">@verbosity_wrapper</span></span>
<span id="cb449-2"><a href="#cb449-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> myfun(x):</span>
<span id="cb449-3"><a href="#cb449-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x</span>
<span id="cb449-4"><a href="#cb449-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb449-5"><a href="#cb449-5" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> myfun(<span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Starting myfun.
Finishing myfun.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb451"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb451-1"><a href="#cb451-1" aria-hidden="true" tabindex="-1"></a>y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>7</code></pre>
</div>
</div>
<p>Our decorator doesn’t do anything useful, but hopefully you can imagine that the idea of being able to have more control over the operation of functions could be useful. For example we could set up a timing wrapper so that when we run a function, we get a report on how long it took to run the function. Or using the idea of a closure, we could keep a running count of the number of times a function has been called.</p>
<p>One real-world example of using decorators is in setting up functions to run in parallel in <code>dask</code>, which we’ll discuss in Unit 7. Another is the use of Numba to do <a href="#just-in-time-jit-compilation">just-in-time (JIT) compilation</a> of Python code.</p>
</section>
</section>
<section id="memory-and-copies" class="level1">
<h1>8. Memory and copies</h1>
<section id="overview-2" class="level2">
<h2 class="anchored" data-anchor-id="overview-2">Overview</h2>
<p>The main things to remember when thinking about memory use are: (1) numeric arrays take 8 bytes per element and (2) we need to keep track of when large objects are created, including local variables in the frames of functions. To do (2) we need to know when a copy of an actual object is created versus when we simply copy the name/label/reference to an existing object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb453"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb453-1"><a href="#cb453-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb453-2"><a href="#cb453-2" aria-hidden="true" tabindex="-1"></a>x.itemsize <span class="co"># 8 bytes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>8</code></pre>
</div>
<div class="sourceCode cell-code" id="cb455"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb455-1"><a href="#cb455-1" aria-hidden="true" tabindex="-1"></a>x.nbytes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>40</code></pre>
</div>
</div>
<section id="allocating-and-freeing-memory" class="level3">
<h3 class="anchored" data-anchor-id="allocating-and-freeing-memory">Allocating and freeing memory</h3>
<p>Unlike compiled languages like C, in Python we do not need to explicitly allocate storage for objects. (However, we will see that there are times that we do want to allocate storage in advance, rather than successively concatenating onto a larger object.)</p>
<p>Python automatically manages memory, releasing memory back to the operating system when it’s not needed via a process called <em>garbage collection</em>. Very occasionally you may want to remove large objects as soon as they are not needed. <code>del</code> does not actually free up memory, it just disassociates the name from the memory used to store the object. In general Python will quickly clean up such objects without a reference (i.e., a name), so there is generally no need to call <code>gc.collect()</code> to force the garbage collection.</p>
<p>In a language like C in which the user allocates and frees up memory, memory leaks are a major cause of bugs. Basically if you are looping and you allocate memory at each iteration and forget to free it, the memory use builds up inexorably and eventually the machine runs out of memory. In Python, with automatic garbage collection, this is generally not an issue, but occasionally memory leaks could occur.</p>
</section>
<section id="the-heap-and-the-stack" class="level3">
<h3 class="anchored" data-anchor-id="the-heap-and-the-stack">The heap and the stack</h3>
<p>The <em>heap</em> is the memory that is available for dynamically creating new objects while a program is executing, e.g., if you create a new object in Python or call <em>new</em> in C++. When more memory is needed the program can request more from the operating system. When objects are removed in Python, Python will handle the garbage collection of releasing that memory.</p>
<p>The <em>stack</em> is the memory used for local variables when a function is called. I.e., the stack is the memory associated with function frames. Hence the term “stack trace” to refer to the active function frames during execution of code.</p>
<p>There’s a nice discussion of this on <a href="https://stackoverflow.com/questions/79923/what-and-where-are-the-stack-and-heap">this Stack Overflow thread</a>.</p>
</section>
</section>
<section id="monitoring-memory-use" class="level2">
<h2 class="anchored" data-anchor-id="monitoring-memory-use">Monitoring memory use</h2>
<section id="monitoring-overall-memory-use-on-a-unix-style-computer" class="level3">
<h3 class="anchored" data-anchor-id="monitoring-overall-memory-use-on-a-unix-style-computer">Monitoring overall memory use on a UNIX-style computer</h3>
<p>To understand how much memory is available on your computer, one needs to have a clear understanding of disk caching. The operating system will generally cache files/data in memory when it reads from disk. Then if that information is still in memory the next time it is needed, it will be much faster to access it the second time around than if it had to read the information from disk. While the cached information is using memory, that same memory is immediately available to other processes, so the memory is available even though it is “in use”.</p>
<p>We can see this via <code>free -h --si</code>.</p>
<p>The <code>-h</code> is for ‘human-readable’ for nicer numerical printout and the <code>--si</code> uses gigabytes (base 10) instead of gibibytes (base 2).</p>
<pre><code>paciorek@gandalf:~&gt; free -h --si
               total        used        free      shared  buff/cache   available
Mem:            135G         24G         30G        7.8M         80G        110G
Swap:           274G         44G        230G</code></pre>
<p>You’ll generally be interested in the <code>Mem</code> row. (See below for some comments on <code>Swap</code>.) The <code>shared</code> column is complicated and probably won’t be of use to you. The <code>buff/cache</code> column shows how much space is used for disk caching and related purposes but is actually available. Hence the <code>available</code> column is the sum of the <code>free</code> and <code>buff/cache</code> columns (more or less). In this case 24 GB is in use (indicated in the <code>used</code> column), leaving 110 GB available for use.</p>
<p><code>top</code> (Linux or Mac) shows both total memory use and statistics by process.</p>
<p>Here are some example lines from the first few lines of output from <code>top</code>:</p>
<pre><code>MiB Mem : 128877.0 total,  28825.9 free,  23856.4 used,  77249.1 buff/cache     
MiB Swap: 262144.0 total, 220103.3 free,  42040.7 used. 105020.6 avail Mem </code></pre>
<p>We see that this machine has 129 GiB RAM (the ‘total’ column in the <code>Mem</code> row), with 106 GiB available (29 GiB free plus 77 GiB buff/cache as seen in the <code>Mem</code> row). 24 GiB is in use.</p>
<p><em>Swap</em> is essentially the reverse of disk caching. It is disk space that is used for memory when the machine runs out of physical memory. You generally don’t want your machine to be using swap for memory because your jobs can slow to a crawl. As seen above, the <code>swap</code> line in <code>top</code> shows 262 GiB swap space (274 GB in <code>free</code>), with 42 GiB (44 GB) in use. One would often hope that little swap space is in use, but this can get complicated. In this case I’m not sure why 42 GiB of swap is being used given there is plenty of physical memory available.</p>
<p>Note that some of the numbers differ a bit between <code>top</code> and <code>free</code>, more so that can be explained based on gigabytes vs.&nbsp;gibibytes. I’m not sure why that is, but it doesn’t affect our overall assessment of memory used and available here.</p>
</section>
<section id="monitoring-memory-use-in-python" class="level3">
<h3 class="anchored" data-anchor-id="monitoring-memory-use-in-python">Monitoring memory use in Python</h3>
<p>There are a number of ways to see how much memory is being used. When Python is actively executing statements, you can use <code>top</code> from the UNIX shell.</p>
<p>In Python, we can call out to the system to get the info we want:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb459"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb459-1"><a href="#cb459-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> psutil</span>
<span id="cb459-2"><a href="#cb459-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb459-3"><a href="#cb459-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get memory information</span></span>
<span id="cb459-4"><a href="#cb459-4" aria-hidden="true" tabindex="-1"></a>memory_info <span class="op">=</span> psutil.Process().memory_info()</span>
<span id="cb459-5"><a href="#cb459-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb459-6"><a href="#cb459-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the memory usage</span></span>
<span id="cb459-7"><a href="#cb459-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Memory usage:"</span>, memory_info.rss<span class="op">/</span><span class="dv">10</span><span class="op">**</span><span class="dv">6</span>, <span class="st">" MB."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Memory usage: 310.337536  MB.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb461"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb461-1"><a href="#cb461-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb461-2"><a href="#cb461-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's turn that into a function for later use:</span></span>
<span id="cb461-3"><a href="#cb461-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mem_used():</span>
<span id="cb461-4"><a href="#cb461-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Memory usage:"</span>, psutil.Process().memory_info().rss<span class="op">/</span><span class="dv">10</span><span class="op">**</span><span class="dv">6</span>, <span class="st">" MB."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see the size of an object (in bytes) with <code>sys.getsizeof()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb462"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb462-1"><a href="#cb462-1" aria-hidden="true" tabindex="-1"></a>my_list <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>]</span>
<span id="cb462-2"><a href="#cb462-2" aria-hidden="true" tabindex="-1"></a>sys.getsizeof(my_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>104</code></pre>
</div>
<div class="sourceCode cell-code" id="cb464"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb464-1"><a href="#cb464-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">10</span><span class="op">**</span><span class="dv">7</span>) <span class="co"># should use about 80 MB</span></span>
<span id="cb464-2"><a href="#cb464-2" aria-hidden="true" tabindex="-1"></a>sys.getsizeof(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>80000112</code></pre>
</div>
</div>
<p>However, we need to be careful about objects that refer to other objects:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb466"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb466-1"><a href="#cb466-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> [<span class="dv">3</span>, x]</span>
<span id="cb466-2"><a href="#cb466-2" aria-hidden="true" tabindex="-1"></a>sys.getsizeof(y)  <span class="co"># Whoops!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>72</code></pre>
</div>
</div>
<p>Here’s a trick where we serialize the object, as if to export it, and then see how long the binary representation is.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb468"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb468-1"><a href="#cb468-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb468-2"><a href="#cb468-2" aria-hidden="true" tabindex="-1"></a>ser_object <span class="op">=</span> pickle.dumps(y)</span>
<span id="cb468-3"><a href="#cb468-3" aria-hidden="true" tabindex="-1"></a>sys.getsizeof(ser_object)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>80000202</code></pre>
</div>
</div>
<p>There are also some flags that one can start <code>python</code> with that allow one to see information about memory use and allocation. See <code>man python</code>. You could also look into the <code>memory_profiler</code> or <code>pympler</code> packages.</p>
</section>
</section>
<section id="how-memory-is-used-in-python" class="level2">
<h2 class="anchored" data-anchor-id="how-memory-is-used-in-python">How memory is used in Python</h2>
<section id="two-key-tools-id-and-is" class="level3">
<h3 class="anchored" data-anchor-id="two-key-tools-id-and-is">Two key tools: <code>id</code> and <code>is</code></h3>
<p>We can use the <code>id</code> function to see where in memory an object is stored and <code>is</code> to see if two object are actually the same objects in memory. It’s particularly useful for understanding storage and memory use for complicated data structures. We’ll also see that they can be handy tools for seeing where copies are made and where they are not.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb470"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb470-1"><a href="#cb470-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">10</span><span class="op">**</span><span class="dv">7</span>)</span>
<span id="cb470-2"><a href="#cb470-2" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231506710128</code></pre>
</div>
<div class="sourceCode cell-code" id="cb472"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb472-1"><a href="#cb472-1" aria-hidden="true" tabindex="-1"></a>sys.getsizeof(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>80000112</code></pre>
</div>
<div class="sourceCode cell-code" id="cb474"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb474-1"><a href="#cb474-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> x</span>
<span id="cb474-2"><a href="#cb474-2" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231506710128</code></pre>
</div>
<div class="sourceCode cell-code" id="cb476"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb476-1"><a href="#cb476-1" aria-hidden="true" tabindex="-1"></a>x <span class="kw">is</span> y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True</code></pre>
</div>
<div class="sourceCode cell-code" id="cb478"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb478-1"><a href="#cb478-1" aria-hidden="true" tabindex="-1"></a>sys.getsizeof(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>80000112</code></pre>
</div>
<div class="sourceCode cell-code" id="cb480"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb480-1"><a href="#cb480-1" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> x.copy()</span>
<span id="cb480-2"><a href="#cb480-2" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(z)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231506708592</code></pre>
</div>
<div class="sourceCode cell-code" id="cb482"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb482-1"><a href="#cb482-1" aria-hidden="true" tabindex="-1"></a>sys.getsizeof(z)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>80000112</code></pre>
</div>
</div>
</section>
<section id="memory-use-in-specific-circumstances" class="level3">
<h3 class="anchored" data-anchor-id="memory-use-in-specific-circumstances">Memory use in specific circumstances</h3>
<section id="how-lists-are-stored" class="level4">
<h4 class="anchored" data-anchor-id="how-lists-are-stored">How lists are stored</h4>
<p>Here we can use <code>id</code> to determine how the overall list is stored as well as the elements of the list.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb484"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb484-1"><a href="#cb484-1" aria-hidden="true" tabindex="-1"></a>nums <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb484-2"><a href="#cb484-2" aria-hidden="true" tabindex="-1"></a>obj <span class="op">=</span> [nums, nums, np.random.normal(size <span class="op">=</span> <span class="dv">5</span>), [<span class="st">'adfs'</span>]]</span>
<span id="cb484-3"><a href="#cb484-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb484-4"><a href="#cb484-4" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(nums)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231506711280</code></pre>
</div>
<div class="sourceCode cell-code" id="cb486"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb486-1"><a href="#cb486-1" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(obj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231505815424</code></pre>
</div>
<div class="sourceCode cell-code" id="cb488"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb488-1"><a href="#cb488-1" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(obj[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231506711280</code></pre>
</div>
<div class="sourceCode cell-code" id="cb490"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb490-1"><a href="#cb490-1" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(obj[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231506711280</code></pre>
</div>
<div class="sourceCode cell-code" id="cb492"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb492-1"><a href="#cb492-1" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(obj[<span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231506719344</code></pre>
</div>
<div class="sourceCode cell-code" id="cb494"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb494-1"><a href="#cb494-1" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(obj[<span class="dv">3</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231505822912</code></pre>
</div>
<div class="sourceCode cell-code" id="cb496"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb496-1"><a href="#cb496-1" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(obj[<span class="dv">3</span>][<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231508005904</code></pre>
</div>
<div class="sourceCode cell-code" id="cb498"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb498-1"><a href="#cb498-1" aria-hidden="true" tabindex="-1"></a>obj[<span class="dv">0</span>] <span class="kw">is</span> obj[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True</code></pre>
</div>
<div class="sourceCode cell-code" id="cb500"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb500-1"><a href="#cb500-1" aria-hidden="true" tabindex="-1"></a>obj[<span class="dv">0</span>] <span class="kw">is</span> obj[<span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>False</code></pre>
</div>
</div>
<p>What do we notice?</p>
<ul>
<li>The list itself appears to be a array of references (pointers) to the component elements.</li>
<li>Each element has its own address.</li>
<li>Two elements of a list can use the same memory (see the first two elements here, whose contents are at the same memory address).</li>
<li>A list element can use the same memory as another object (or part of another object).</li>
</ul>
<p>A note about calling <code>id</code> on list elements, e.g., <code>id(obj[0])</code>. Running that code causes execution of <code>obj[0]</code>, and the result is passed into <code>id</code>. That creates a new temporary object that is passed to <code>id</code>. The temporary object references the same object that <code>obj[0]</code> does, so we find out the id of <code>obj[0]</code>.</p>
</section>
<section id="how-character-strings-are-stored." class="level4">
<h4 class="anchored" data-anchor-id="how-character-strings-are-stored.">How character strings are stored.</h4>
<p>Similar tricks are used for storing strings (and also integers). We may explore this in a problem set problem.</p>
</section>
<section id="how-numpy-arrays-are-stored" class="level4">
<h4 class="anchored" data-anchor-id="how-numpy-arrays-are-stored">How numpy arrays are stored</h4>
<p>To do vectorized calculations and linear algebra efficiently, one needs the data in arrays stored contiguously in memory, and this is how numpy arrays are stored. We’ve seen that a numpy array involves the actual numbers plus 112 bytes of metadata/overhead associated with the object.</p>
<p>We can’t usefully call <code>id</code> on elements of the array. Consider this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb502"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb502-1"><a href="#cb502-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb502-2"><a href="#cb502-2" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(x[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'numpy.float64'&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb504"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb504-1"><a href="#cb504-1" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(x[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231506430928</code></pre>
</div>
<div class="sourceCode cell-code" id="cb506"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb506-1"><a href="#cb506-1" aria-hidden="true" tabindex="-1"></a>tmp1 <span class="op">=</span> x[<span class="dv">1</span>]</span>
<span id="cb506-2"><a href="#cb506-2" aria-hidden="true" tabindex="-1"></a>tmp2 <span class="op">=</span> x[<span class="dv">1</span>]</span>
<span id="cb506-3"><a href="#cb506-3" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(tmp1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231508807024</code></pre>
</div>
<div class="sourceCode cell-code" id="cb508"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb508-1"><a href="#cb508-1" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(tmp2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231506432464</code></pre>
</div>
</div>
<p>Each time we get the <code>x[1]</code> element we are creating a new numpy float64 scalar object. This is because each element of the array is not its own object (unlike a list element) so extracting the element involves copying the value and making a new object.</p>
<p>Another indication of the array being stored contiguously is that if we pickle the array, its size is just a bit more than the size needed just to store the 8-byte numbers. If we instead pickle a list containing those same numbers, the result is more than twice as big, related to the pointers involved in referring to the individual numbers.</p>
</section>
<section id="modifying-elements-in-place" class="level4">
<h4 class="anchored" data-anchor-id="modifying-elements-in-place">Modifying elements in place</h4>
<p>What do this simple experiment tell us?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb510"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb510-1"><a href="#cb510-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb510-2"><a href="#cb510-2" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231507141392</code></pre>
</div>
<div class="sourceCode cell-code" id="cb512"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb512-1"><a href="#cb512-1" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">2</span>] <span class="op">=</span> <span class="fl">3.5</span></span>
<span id="cb512-2"><a href="#cb512-2" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231507141392</code></pre>
</div>
</div>
<p>It makes some sense that modifying elements of an object here doesn’t cause a copy – if it did, working with large objects would be very difficult.</p>
</section>
<section id="shallow-copying" class="level4">
<h4 class="anchored" data-anchor-id="shallow-copying">Shallow copying</h4>
<p>A <em>shallow</em> copy only makes a new top-level object. The elements within the object are still shared with the original object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb514"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb514-1"><a href="#cb514-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> [<span class="dv">3</span>, [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]]</span>
<span id="cb514-2"><a href="#cb514-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> x.copy()</span>
<span id="cb514-3"><a href="#cb514-3" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231505652864</code></pre>
</div>
<div class="sourceCode cell-code" id="cb516"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb516-1"><a href="#cb516-1" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231506492416</code></pre>
</div>
<div class="sourceCode cell-code" id="cb518"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb518-1"><a href="#cb518-1" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">0</span>] <span class="op">=</span> <span class="dv">9</span></span>
<span id="cb518-2"><a href="#cb518-2" aria-hidden="true" tabindex="-1"></a>y[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb520"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb520-1"><a href="#cb520-1" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(x[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231505897600</code></pre>
</div>
<div class="sourceCode cell-code" id="cb522"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb522-1"><a href="#cb522-1" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(y[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231505897600</code></pre>
</div>
<div class="sourceCode cell-code" id="cb524"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb524-1"><a href="#cb524-1" aria-hidden="true" tabindex="-1"></a>y[<span class="dv">1</span>][<span class="dv">2</span>] <span class="op">=</span> <span class="dv">99</span></span>
<span id="cb524-2"><a href="#cb524-2" aria-hidden="true" tabindex="-1"></a>x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[9, [1, 2, 99]]</code></pre>
</div>
</div>
<p>We can force a <em>deep</em> copy such that nothing is shared between the objects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb526"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb526-1"><a href="#cb526-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> copy</span>
<span id="cb526-2"><a href="#cb526-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> [<span class="dv">3</span>, [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>]]</span>
<span id="cb526-3"><a href="#cb526-3" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> copy.deepcopy(x)</span>
<span id="cb526-4"><a href="#cb526-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb526-5"><a href="#cb526-5" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(x[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231505814528</code></pre>
</div>
<div class="sourceCode cell-code" id="cb528"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb528-1"><a href="#cb528-1" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(y[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231505868672</code></pre>
</div>
<div class="sourceCode cell-code" id="cb530"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb530-1"><a href="#cb530-1" aria-hidden="true" tabindex="-1"></a>y[<span class="dv">1</span>][<span class="dv">2</span>] <span class="op">=</span> <span class="dv">99</span></span>
<span id="cb530-2"><a href="#cb530-2" aria-hidden="true" tabindex="-1"></a>x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[3, [1, 2, 3]]</code></pre>
</div>
</div>
</section>
</section>
<section id="when-are-copies-made" class="level3">
<h3 class="anchored" data-anchor-id="when-are-copies-made">When are copies made?</h3>
<p>Let’s try to understand when Python uses additional memory for objects, and how it knows when it can delete memory. We’ll use large objects so that we can use <code>free</code> or <code>top</code> to see how memory use by the Python process changes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb532"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb532-1"><a href="#cb532-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">10</span><span class="op">**</span><span class="dv">8</span>)</span>
<span id="cb532-2"><a href="#cb532-2" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231506710608</code></pre>
</div>
<div class="sourceCode cell-code" id="cb534"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb534-1"><a href="#cb534-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> x</span>
<span id="cb534-2"><a href="#cb534-2" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231506710608</code></pre>
</div>
<div class="sourceCode cell-code" id="cb536"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb536-1"><a href="#cb536-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">10</span><span class="op">**</span><span class="dv">8</span>)</span>
<span id="cb536-2"><a href="#cb536-2" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231506710128</code></pre>
</div>
</div>
<p>Only if we re-assign <code>x</code> to reference a different object does additional memory get used.</p>
<section id="how-does-python-know-when-it-can-free-up-memory" class="level4">
<h4 class="anchored" data-anchor-id="how-does-python-know-when-it-can-free-up-memory">How does Python know when it can free up memory?</h4>
<p>Python keeps track of how many names refer to an object and only removes memory when there are no remaining references to an object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb538"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb538-1"><a href="#cb538-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb538-2"><a href="#cb538-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb538-3"><a href="#cb538-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">10</span><span class="op">**</span><span class="dv">8</span>)</span>
<span id="cb538-4"><a href="#cb538-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> x</span>
<span id="cb538-5"><a href="#cb538-5" aria-hidden="true" tabindex="-1"></a>sys.getrefcount(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb540"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb540-1"><a href="#cb540-1" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> x</span>
<span id="cb540-2"><a href="#cb540-2" aria-hidden="true" tabindex="-1"></a>sys.getrefcount(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb542"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb542-1"><a href="#cb542-1" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see the number of references using <code>sys.getrefcount</code>. Confusingly, the number is one higher than we’d expect, because it includes the temporary reference from passing the object as the argument to <code>getrefcount</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb543"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb543-1"><a href="#cb543-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb543-2"><a href="#cb543-2" aria-hidden="true" tabindex="-1"></a>sys.getrefcount(x)  <span class="co"># In reality, only 1. </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb545"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb545-1"><a href="#cb545-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> x</span>
<span id="cb545-2"><a href="#cb545-2" aria-hidden="true" tabindex="-1"></a>sys.getrefcount(x)  <span class="co"># In reality, 2.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb547"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb547-1"><a href="#cb547-1" aria-hidden="true" tabindex="-1"></a>sys.getrefcount(y)  <span class="co"># In reality, 2.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb549"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb549-1"><a href="#cb549-1" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> y</span>
<span id="cb549-2"><a href="#cb549-2" aria-hidden="true" tabindex="-1"></a>sys.getrefcount(x)  <span class="co"># In reality, only 1. </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb551"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb551-1"><a href="#cb551-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> x</span>
<span id="cb551-2"><a href="#cb551-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb551-3"><a href="#cb551-3" aria-hidden="true" tabindex="-1"></a>sys.getrefcount(y)  <span class="co"># In reality, only 1. </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb553"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb553-1"><a href="#cb553-1" aria-hidden="true" tabindex="-1"></a>sys.getrefcount(x)  <span class="co"># In reality, only 1. </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2</code></pre>
</div>
</div>
<p>This notion of reference counting occurs in other contexts, such as shared pointers in C++ and in how R handles copying and garbage collection.</p>
</section>
</section>
</section>
<section id="strategies-for-saving-memory" class="level2">
<h2 class="anchored" data-anchor-id="strategies-for-saving-memory">Strategies for saving memory</h2>
<p>A few basic strategies for saving memory include:</p>
<ul>
<li>Avoiding unnecessary copies.</li>
<li>Removing objects that are not being used, at which point the Python garbage collector should free up the memory.</li>
<li>Use iterators (e.g., <code>range()</code>) and <a href="https://wiki.python.org/moin/Generators">generators</a> to avoid building long lists that are iterated over.</li>
</ul>
<p>If you’re really trying to optimize memory use, you may also consider:</p>
<ul>
<li><p>Using types that take up less memory (e.g., <code>Bool</code>, <code>Int16</code>, <code>Float32</code>) when possible.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb555"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb555-1"><a href="#cb555-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.array(np.random.normal(size <span class="op">=</span> <span class="dv">5</span>), dtype <span class="op">=</span> <span class="st">"float32"</span>)</span>
<span id="cb555-2"><a href="#cb555-2" aria-hidden="true" tabindex="-1"></a>x.itemsize</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb557"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb557-1"><a href="#cb557-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.array([<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">2</span>,<span class="op">-</span><span class="dv">2</span>], dtype <span class="op">=</span> <span class="st">"int16"</span>)</span>
<span id="cb557-2"><a href="#cb557-2" aria-hidden="true" tabindex="-1"></a>x.itemsize</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2</code></pre>
</div>
</div></li>
<li><p>Reading data in from files in chunks rather than reading the entire dataset (more in Unit 7).</p></li>
<li><p>Exploring packages such as <code>arrow</code> for efficiently using memory, as discussed in <a href="unit2-dataTech.html#reading-data-quickly-arrow-and-polars">Unit 2</a>.</p></li>
</ul>
</section>
<section id="example" class="level2">
<h2 class="anchored" data-anchor-id="example">Example</h2>
<p>Let’s work through a real example where we keep a running tally of current memory in use and maximum memory used in a function call. We’ll want to consider hidden uses of memory and when copies of the object are made rather than simply creating a new reference to an existing object. This code (translated from the original R code) comes from a PhD student’s research. For our purposes here, let’s assume that the input <code>x</code> and <code>y</code> are very long numpy arrays using a lot of memory.</p>
<p><code>np.isnan</code> returns an boolean array of True/False values indicating whether each input element is a NaN (not a number).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb559"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb559-1"><a href="#cb559-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fastcount(xvar, yvar):</span>
<span id="cb559-2"><a href="#cb559-2" aria-hidden="true" tabindex="-1"></a>    naline <span class="op">=</span> np.isnan(xvar)</span>
<span id="cb559-3"><a href="#cb559-3" aria-hidden="true" tabindex="-1"></a>    naline[np.isnan(yvar)] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb559-4"><a href="#cb559-4" aria-hidden="true" tabindex="-1"></a>    localx <span class="op">=</span> xvar.copy()</span>
<span id="cb559-5"><a href="#cb559-5" aria-hidden="true" tabindex="-1"></a>    localy <span class="op">=</span> yvar.copy()</span>
<span id="cb559-6"><a href="#cb559-6" aria-hidden="true" tabindex="-1"></a>    localx[naline] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb559-7"><a href="#cb559-7" aria-hidden="true" tabindex="-1"></a>    localy[naline] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb559-8"><a href="#cb559-8" aria-hidden="true" tabindex="-1"></a>    useline <span class="op">=</span> <span class="op">~</span>naline</span>
<span id="cb559-9"><a href="#cb559-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">## We'll ignore the rest of the code.</span></span>
<span id="cb559-10"><a href="#cb559-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">## ....</span></span>
<span id="cb559-11"><a href="#cb559-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb559-12"><a href="#cb559-12" aria-hidden="true" tabindex="-1"></a>fastcount(x, y) <span class="co"># Assume x, y are existing large numpy arrays.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Challenge">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge
</div>
</div>
<div class="callout-body-container callout-body">
<p>In the code above, note all the places where new memory must be allocated.</p>
</div>
</div>
</section>
</section>
<section id="efficiency" class="level1">
<h1>9. Efficiency</h1>
<section id="interpreters-and-compilation" class="level2">
<h2 class="anchored" data-anchor-id="interpreters-and-compilation">Interpreters and compilation</h2>
<section id="why-are-interpreted-languages-slow" class="level3">
<h3 class="anchored" data-anchor-id="why-are-interpreted-languages-slow">Why are interpreted languages slow?</h3>
<p>Compiled code runs quickly because the original code has been translated into instructions (machine language) that the processor can understand (i.e., zeros and ones). In the process of doing so, various checking and lookup steps are done once and don’t need to be redone when running the compiled code.</p>
<p>In contrast, when one runs code in an interpreted language such as Python or R, the interpreter needs to do all the checking and lookup each time the code is run. This is required because the types and locations in memory of the variables could have changed.</p>
<p>We’ll focus on Python in the following discussion, but most of the concepts apply to other interpreted languages.</p>
<p>For example, consider this code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb560"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb560-1"><a href="#cb560-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb560-2"><a href="#cb560-2" aria-hidden="true" tabindex="-1"></a><span class="bu">abs</span>(x)</span>
<span id="cb560-3"><a href="#cb560-3" aria-hidden="true" tabindex="-1"></a>x<span class="op">*</span><span class="dv">7</span></span>
<span id="cb560-4"><a href="#cb560-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb560-5"><a href="#cb560-5" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="st">'hi'</span></span>
<span id="cb560-6"><a href="#cb560-6" aria-hidden="true" tabindex="-1"></a><span class="bu">abs</span>(x)</span>
<span id="cb560-7"><a href="#cb560-7" aria-hidden="true" tabindex="-1"></a>x<span class="op">*</span><span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Because of dynamic typing, when the interpreter sees <code>abs(x)</code> it needs to check if <code>x</code> is something to which the absolute value function can be applied, including dealing with the fact that <code>x</code> could be a list or array with many numbers in it. In addition it needs to (using scoping rules) look up the value of <code>x</code>. (Consider that <code>x</code> might not even exist at the point that <code>abs(x)</code> is called.) Only then can the absolute value calculation happen. For the multiplication, Python needs to lookup the version of <code>*</code> that can be used, depending on the type of <code>x</code>.</p>
<p>Let’s consider writing a loop with some ridiculous code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb561"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb561-1"><a href="#cb561-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">10</span>)</span>
<span id="cb561-2"><a href="#cb561-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb561-3"><a href="#cb561-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> np.random.normal(size <span class="op">=</span> <span class="dv">1</span>) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb561-4"><a href="#cb561-4" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="st">'hi'</span></span>
<span id="cb561-5"><a href="#cb561-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> np.random.normal(size <span class="op">=</span> <span class="dv">1</span>) <span class="op">&gt;</span> <span class="fl">0.5</span>:</span>
<span id="cb561-6"><a href="#cb561-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> x</span>
<span id="cb561-7"><a href="#cb561-7" aria-hidden="true" tabindex="-1"></a>    x[i]<span class="op">=</span> np.exp(x[i])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There is no way around the fact that because of how dynamic this is, the interpreter needs to check if <code>x</code> exists, if it is an array of sufficient length, if it contains numeric values, and it needs to go retrieve the required value, EVERY TIME the <code>np.exp()</code> is executed. Now the code above is unusual, and in most cases, we wouldn’t have the <code>if</code> statements that modify <code>x</code>. So you could imagine a process by which the checking were done on the first iteration and then not needed after that – that gets into the idea of just-in-time compilation, discussed later.</p>
<p>The standard Python interpreter (CPython) is a C function so in some sense everything that happens is running as compiled code, but there are lots more things being done to accomplish a given task using interpreted code than if the task had been written directly in code that is compiled. By analogy, consider talking directly to a person in a language you both know compared to talking to a person via an interpreter who has to translate between two languages. Ultimately, the same information gets communicated (hopefully!) but the number of words spoken and time involved is much greater.</p>
<p>When running more complicated functions, there is often a lot of checking that is part of the function itself. For example scipy’s <code>solve_triangular</code> function ultimately calls out to the <code>trtrs</code> Lapack function, but before doing so, there is a lot of checking that can take time. To that point, the documentation suggests you might set <code>check_finite=False</code> to improve performance at the expense of potential problems if the input matrices contain troublesome elements.</p>
<p>We can flip the question on its head and ask what operations in an interpreted language will execute quickly. In Python, these include:</p>
<ul>
<li>operations that call out to compiled C code,</li>
<li>linear algebra operations (these call out to compiled C or Fortran code provided by the BLAS and LAPACK software packages), and</li>
<li>vectorized calls rather than loops:
<ul>
<li>vectorized calls generally run loops in compiled C code rather than having the loop run in Python, and</li>
<li>that means that the interpreter doesn’t have to do all the checking discussed above for every iteration of the loop.</li>
</ul></li>
</ul>
</section>
<section id="compilation" class="level3">
<h3 class="anchored" data-anchor-id="compilation">Compilation</h3>
<section id="overview-3" class="level4">
<h4 class="anchored" data-anchor-id="overview-3">Overview</h4>
<p>Compilation is the process of turning code in a given language (such a C++) into machine code. Machine code is the code that the processor actually executes. The machine code is stored in the executable file, which is a binary file. The history of programming has seen ever great levels of abstraction, so that humans can write code using syntax that is easier for us to understand, re-use, and develop building blocks that can be put together to do complicated tasks. For example assembly language is a step above machine code. Languages like C and Fortran provide additional abstraction beyond that. The Statistics 750 class at CMU has a <a href="https://36-750.github.io/tools/computer-architecture/#how-programs--aka-apps--run">nice overview</a> if you want to see more details.</p>
<p>Note that interpreters such as Python are themselves programs – the standard Python interpreter (CPython) is a C program that has been compiled. It happens to be a program that processes Python code. The interpreter doesn’t turn Python code into machine code, but the interpreter itself is machine code.</p>
</section>
<section id="just-in-time-jit-compilation" class="level4">
<h4 class="anchored" data-anchor-id="just-in-time-jit-compilation">Just-in-time (JIT) compilation</h4>
<p>Standard compilation (ahead-of-time or AOT compilation) happens before any code is executed and can involve a lot of optimization to produce the most efficient machine code possible.</p>
<p>In contrast, just-in-time (JIT) compilation happens at the time that the code is executing. JIT compilation is heavily used in Julia, which is very fast (in some cases as fast as C). JIT compilation involves translating to machine code as the code is running. One nice aspect is that the results are cached so that if code is rerun, the compilation process doesn’t have to be redone. So if you use a language like Julia, you’ll see that the speed can vary drastically between the first time and later times you run a given function during a given session.</p>
<p>One thing that needs to be dealt with is type checking. As discussed above, part of why an interpreter is slow is because the type of the variable(s) involved in execution of a piece of code is not known in advance, so the interpreter needs to check the type. In JIT systems, there are often type inference systems that determine variable types.</p>
<p>JIT compilation can involve translation from the original code to machine code or translation of bytecode (see next section) to machine code.</p>
<p>At the end of this unit, we’ll see the use of JIT compilation with the JAX package in Python.</p>
<p><code>numba</code> is a standard JIT compiler for Python and numpy that uses the LLVM compiler library. To use it one applies the <code>numba.njit</code> decorator to a Python function.</p>
</section>
<section id="byte-compiling-optional" class="level4">
<h4 class="anchored" data-anchor-id="byte-compiling-optional">Byte compiling (optional)</h4>
<p>Functions in Python and Python packages may byte compiled. What does that mean? Byte-compiled code is a special representation that can be executed more efficiently because it is in the form of compact codes that encode the results of parsing and semantic analysis of scoping and other complexities of the Python source code. This byte code can be executed faster than the original Python code because it skips the stage of having to be interpreted by the Python interpreter.</p>
<p>If you look at the file names in the directory of an installed Python package you may see files with the <code>.pyc</code> extension. These files have been byte-compiled.</p>
<p>We can byte compile our own functions using either the <code>py_compile</code> or <code>compileall</code> modules. Here’s an example (silly since as experienced Python programmers, we would use vectorized calculation here rather than this unvectorized code.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb562"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb562-1"><a href="#cb562-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb562-2"><a href="#cb562-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb562-3"><a href="#cb562-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f(vals):</span>
<span id="cb562-4"><a href="#cb562-4" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.zeros(<span class="bu">len</span>(vals))</span>
<span id="cb562-5"><a href="#cb562-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(vals)):</span>
<span id="cb562-6"><a href="#cb562-6" aria-hidden="true" tabindex="-1"></a>        x[i] <span class="op">=</span> np.exp(vals[i])</span>
<span id="cb562-7"><a href="#cb562-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x</span>
<span id="cb562-8"><a href="#cb562-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb562-9"><a href="#cb562-9" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">10</span><span class="op">**</span><span class="dv">6</span>)</span>
<span id="cb562-10"><a href="#cb562-10" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb562-11"><a href="#cb562-11" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> f(x)</span>
<span id="cb562-12"><a href="#cb562-12" aria-hidden="true" tabindex="-1"></a>time.time() <span class="op">-</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>0.7561802864074707</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb564"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb564-1"><a href="#cb564-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb564-2"><a href="#cb564-2" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> np.exp(x)</span>
<span id="cb564-3"><a href="#cb564-3" aria-hidden="true" tabindex="-1"></a>time.time() <span class="op">-</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>0.013027191162109375</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb566"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb566-1"><a href="#cb566-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> py_compile</span>
<span id="cb566-2"><a href="#cb566-2" aria-hidden="true" tabindex="-1"></a>py_compile.<span class="bu">compile</span>(<span class="st">'vec.py'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>'__pycache__/vec.cpython-312.pyc'</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb568"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb568-1"><a href="#cb568-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> __pycache__/vec.cpython-312.pyc vec.pyc</span>
<span id="cb568-2"><a href="#cb568-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> vec.py    <span class="co"># Make sure non-compiled module not loaded.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb569"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb569-1"><a href="#cb569-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> vec</span>
<span id="cb569-2"><a href="#cb569-2" aria-hidden="true" tabindex="-1"></a>vec.<span class="va">__file__</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>'/accounts/vis/paciorek/teaching/243fall24/fall-2024/units/vec.pyc'</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb571"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb571-1"><a href="#cb571-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb571-2"><a href="#cb571-2" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> vec.f(x)</span>
<span id="cb571-3"><a href="#cb571-3" aria-hidden="true" tabindex="-1"></a>time.time() <span class="op">-</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>0.7301280498504639</code></pre>
<p>Unfortunately, as seen above byte compiling may not speed things up much. I’m not sure why.</p>
</section>
</section>
</section>
<section id="benchmarking-and-profiling" class="level2">
<h2 class="anchored" data-anchor-id="benchmarking-and-profiling">Benchmarking and profiling</h2>
<p>Recall that it’s a waste of time to optimize code before you determine (1) that the code is too slow for how it will be used and (2) which are the slow steps on which to focus your attempts to speed the code up. A 100x speedup in a step that takes 1% of the time will speed up the overall code by essentially nothing.</p>
<section id="timing-your-code" class="level3">
<h3 class="anchored" data-anchor-id="timing-your-code">Timing your code</h3>
<p>There are a few ways to time code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb573"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb573-1"><a href="#cb573-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb573-2"><a href="#cb573-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">10</span><span class="op">**</span><span class="dv">7</span>)</span>
<span id="cb573-3"><a href="#cb573-3" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb573-4"><a href="#cb573-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.exp(x)</span>
<span id="cb573-5"><a href="#cb573-5" aria-hidden="true" tabindex="-1"></a>t1 <span class="op">=</span> time.time()</span>
<span id="cb573-6"><a href="#cb573-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb573-7"><a href="#cb573-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Execution time: </span><span class="sc">{</span>t1<span class="op">-</span>t0<span class="sc">}</span><span class="ss"> seconds."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Execution time: 0.07009458541870117 seconds.</code></pre>
</div>
</div>
<p>In general, it’s a good idea to repeat (replicate) your timing, as there is some stochasticity in how fast your computer will run a piece of code at any given moment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb575"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb575-1"><a href="#cb575-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb575-2"><a href="#cb575-2" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb575-3"><a href="#cb575-3" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.exp(<span class="fl">3.</span>)</span>
<span id="cb575-4"><a href="#cb575-4" aria-hidden="true" tabindex="-1"></a>t1 <span class="op">=</span> time.time()</span>
<span id="cb575-5"><a href="#cb575-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb575-6"><a href="#cb575-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Execution time: </span><span class="sc">{</span>t1<span class="op">-</span>t0<span class="sc">}</span><span class="ss"> seconds."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Execution time: 0.006430387496948242 seconds.</code></pre>
</div>
</div>
<p>Using <code>time</code> is fine for code that takes a little while to run, but for code that is really fast (such as the code above), it may not be very accurate. Measuring fast bits of code is tricky to do well. This next approach is better for benchmarking code (particularly faster bits of code).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb577"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb577-1"><a href="#cb577-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> timeit</span>
<span id="cb577-2"><a href="#cb577-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb577-3"><a href="#cb577-3" aria-hidden="true" tabindex="-1"></a>timeit.timeit(<span class="st">'x = np.exp(3.)'</span>, setup <span class="op">=</span> <span class="st">'import numpy as np'</span>, number <span class="op">=</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>9.450002107769251e-05</code></pre>
</div>
<div class="sourceCode cell-code" id="cb579"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb579-1"><a href="#cb579-1" aria-hidden="true" tabindex="-1"></a>code <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb579-2"><a href="#cb579-2" aria-hidden="true" tabindex="-1"></a><span class="st">x = np.exp(3.)</span></span>
<span id="cb579-3"><a href="#cb579-3" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span></span>
<span id="cb579-4"><a href="#cb579-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb579-5"><a href="#cb579-5" aria-hidden="true" tabindex="-1"></a>timeit.timeit(code, setup <span class="op">=</span> <span class="st">'import numpy as np'</span>, number <span class="op">=</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>8.726498344913125e-05</code></pre>
</div>
</div>
<p>That reports the <strong>total</strong> time for the 100 replications.</p>
<p>We can run it from the command line.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb581"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb581-1"><a href="#cb581-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-m</span> timeit <span class="at">-n</span> 1000 <span class="st">'x = 3.73 * 5.12'</span></span>
<span id="cb581-2"><a href="#cb581-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-m</span> timeit <span class="at">-s</span> <span class="st">'import numpy'</span> <span class="at">-n</span> 1000 <span class="st">'x = numpy.exp(3.)'</span></span>
<span id="cb581-3"><a href="#cb581-3" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-m</span> timeit <span class="at">-s</span> <span class="st">'from scipy.special import gammaln'</span> <span class="at">-n</span> 1000 <span class="st">'x = gammaln(3.)'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1000 loops, best of 5: 41.3 nsec per loop
1000 loops, best of 5: 1.59 usec per loop
1000 loops, best of 5: 1.77 usec per loop</code></pre>
</div>
</div>
<p><code>timeit</code> ran the code 1000 times for 5 different repetitions, giving the <strong>average</strong> time for the 1000 samples for the best of the 5 repetitions.</p>
<p>We can see that there can be large relative differences for different fundamental mathematical operations, although each one is individually fast on an absolute basis.</p>
</section>
<section id="profiling" class="level3">
<h3 class="anchored" data-anchor-id="profiling">Profiling</h3>
<p>The <code>Cprofile</code> module will show you how much time is spent in different functions, which can help you pinpoint bottlenecks in your code.</p>
<p>I haven’t run this code when producing this document as the output of the profiling can be lengthy.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb583"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb583-1"><a href="#cb583-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lr_slow(y, x):</span>
<span id="cb583-2"><a href="#cb583-2" aria-hidden="true" tabindex="-1"></a>    xtx <span class="op">=</span> x.T <span class="op">@</span> x</span>
<span id="cb583-3"><a href="#cb583-3" aria-hidden="true" tabindex="-1"></a>    xty <span class="op">=</span> x.T <span class="op">@</span> y</span>
<span id="cb583-4"><a href="#cb583-4" aria-hidden="true" tabindex="-1"></a>    inv <span class="op">=</span> np.linalg.inv(xtx)</span>
<span id="cb583-5"><a href="#cb583-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> inv <span class="op">@</span> xty</span>
<span id="cb583-6"><a href="#cb583-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb583-7"><a href="#cb583-7" aria-hidden="true" tabindex="-1"></a><span class="co">## generate random observations and random matrix of predictors</span></span>
<span id="cb583-8"><a href="#cb583-8" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">7000</span></span>
<span id="cb583-9"><a href="#cb583-9" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">7000</span>)</span>
<span id="cb583-10"><a href="#cb583-10" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> (<span class="dv">7000</span>,<span class="dv">1000</span>))</span>
<span id="cb583-11"><a href="#cb583-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb583-12"><a href="#cb583-12" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb583-13"><a href="#cb583-13" aria-hidden="true" tabindex="-1"></a>regr <span class="op">=</span> lr_slow(y, x)</span>
<span id="cb583-14"><a href="#cb583-14" aria-hidden="true" tabindex="-1"></a>t1 <span class="op">=</span> time.time()</span>
<span id="cb583-15"><a href="#cb583-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Execution time: </span><span class="sc">{</span>t1<span class="op">-</span>t0<span class="sc">}</span><span class="ss"> seconds."</span>)</span>
<span id="cb583-16"><a href="#cb583-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb583-17"><a href="#cb583-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cProfile</span>
<span id="cb583-18"><a href="#cb583-18" aria-hidden="true" tabindex="-1"></a>cProfile.run(<span class="st">'lr_slow(y,x)'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>cumtime</code> column includes the time spent in nested calls to functions while the <code>tottime</code> column excludes it.</p>
<p>As we’ll discuss in detail in Unit 10, we almost never want to explicitly invert a matrix. Instead we factorize the matrix and use the factorized result to do the computation of interest. In this case using the Cholesky decomposition is a standard approach, followed by solving triangular systems of equations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb584"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb584-1"><a href="#cb584-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy <span class="im">as</span> sp</span>
<span id="cb584-2"><a href="#cb584-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb584-3"><a href="#cb584-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lr_fast(y, x):</span>
<span id="cb584-4"><a href="#cb584-4" aria-hidden="true" tabindex="-1"></a>    xtx <span class="op">=</span> x.T <span class="op">@</span> x</span>
<span id="cb584-5"><a href="#cb584-5" aria-hidden="true" tabindex="-1"></a>    xty <span class="op">=</span> x.T <span class="op">@</span> y</span>
<span id="cb584-6"><a href="#cb584-6" aria-hidden="true" tabindex="-1"></a>    L <span class="op">=</span> sp.linalg.cholesky(xtx)</span>
<span id="cb584-7"><a href="#cb584-7" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> sp.linalg.solve_triangular(L.T, </span>
<span id="cb584-8"><a href="#cb584-8" aria-hidden="true" tabindex="-1"></a>          sp.linalg.solve_triangular(L, xty, lower<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb584-9"><a href="#cb584-9" aria-hidden="true" tabindex="-1"></a>          lower<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb584-10"><a href="#cb584-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out</span>
<span id="cb584-11"><a href="#cb584-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb584-12"><a href="#cb584-12" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb584-13"><a href="#cb584-13" aria-hidden="true" tabindex="-1"></a>regr <span class="op">=</span> lr_fast(y, x)</span>
<span id="cb584-14"><a href="#cb584-14" aria-hidden="true" tabindex="-1"></a>t1 <span class="op">=</span> time.time()</span>
<span id="cb584-15"><a href="#cb584-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Execution time: </span><span class="sc">{</span>t1<span class="op">-</span>t0<span class="sc">}</span><span class="ss"> seconds."</span>)</span>
<span id="cb584-16"><a href="#cb584-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb584-17"><a href="#cb584-17" aria-hidden="true" tabindex="-1"></a>cProfile.run(<span class="st">'lr_fast(y,x)'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In principle, the Cholesky now dominates the computational time (but is much faster than <code>inv</code>), so there’s not much more we can do in this case. That said, it’s not obvious from the profiling that the fact that most of the time is in the Cholesky is the case. Interpreting the output of a profiler can be hard. In this case to investigate further I would probably time individual steps with <code>timeit</code>.</p>
<p>You might wonder if it’s better to use <code>x.T</code> or <code>np.transpose(x)</code>. Try using <code>timeit</code> to decide.</p>
<p>The Python profilers (<code>cProfile</code> and <code>profile</code> (not shown)) use <a href="https://docs.python.org/3/library/profile.html#what-is-deterministic-profiling">deterministic profiling</a> – calculating the interval between events (i.e., function calls and returns). However, there is some limit to accuracy – the underlying ‘clock’ measures in units of about 0.001 seconds.</p>
<p>(In contrast, R’s profiler works by sampling (statistical profiling) - every little while during a calculation it finds out what function R is in and saves that information to a file. So if you try to profile code that finishes really quickly, there’s not enough opportunity for the sampling to represent the calculation accurately and you may get spurious results.)</p>
</section>
</section>
<section id="writing-efficient-python-code" class="level2">
<h2 class="anchored" data-anchor-id="writing-efficient-python-code">Writing efficient (Python) code</h2>
<p>We’ll discuss a variety of these strategies, including:</p>
<ul>
<li>Pre-allocating memory rather than growing objects iteratively</li>
<li>Vectorization and use of fast matrix algebra</li>
<li>Consideration of loops vs.&nbsp;map operations</li>
<li>Speed of lookup operations, including hashing</li>
</ul>
<p>While illustrated in Python, many of the underlying ideas pertain in other contexts.</p>
<section id="pre-allocating-memory" class="level3">
<h3 class="anchored" data-anchor-id="pre-allocating-memory">Pre-allocating memory</h3>
<p>Let’s consider whether we should pre-allocate space for the output of an operation or if it’s ok to keep extending the length of an array or list.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb585"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb585-1"><a href="#cb585-1" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">100000</span></span>
<span id="cb585-2"><a href="#cb585-2" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> np.random.normal(size <span class="op">=</span> n)</span>
<span id="cb585-3"><a href="#cb585-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb585-4"><a href="#cb585-4" aria-hidden="true" tabindex="-1"></a><span class="co">## Pre-allocation</span></span>
<span id="cb585-5"><a href="#cb585-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb585-6"><a href="#cb585-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun_prealloc(vals):</span>
<span id="cb585-7"><a href="#cb585-7" aria-hidden="true" tabindex="-1"></a>   n <span class="op">=</span> <span class="bu">len</span>(vals)</span>
<span id="cb585-8"><a href="#cb585-8" aria-hidden="true" tabindex="-1"></a>   x <span class="op">=</span> [<span class="dv">0</span>] <span class="op">*</span> n</span>
<span id="cb585-9"><a href="#cb585-9" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb585-10"><a href="#cb585-10" aria-hidden="true" tabindex="-1"></a>       x[i] <span class="op">=</span> np.exp(vals[i])</span>
<span id="cb585-11"><a href="#cb585-11" aria-hidden="true" tabindex="-1"></a>   <span class="cf">return</span> x</span>
<span id="cb585-12"><a href="#cb585-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb585-13"><a href="#cb585-13" aria-hidden="true" tabindex="-1"></a><span class="co">## Appending to a list</span></span>
<span id="cb585-14"><a href="#cb585-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb585-15"><a href="#cb585-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun_append(vals):</span>
<span id="cb585-16"><a href="#cb585-16" aria-hidden="true" tabindex="-1"></a>   x <span class="op">=</span> []</span>
<span id="cb585-17"><a href="#cb585-17" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb585-18"><a href="#cb585-18" aria-hidden="true" tabindex="-1"></a>       x.append(np.exp(vals[i]))</span>
<span id="cb585-19"><a href="#cb585-19" aria-hidden="true" tabindex="-1"></a>   <span class="cf">return</span> x</span>
<span id="cb585-20"><a href="#cb585-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb585-21"><a href="#cb585-21" aria-hidden="true" tabindex="-1"></a><span class="co">## Appending to a numpy array</span></span>
<span id="cb585-22"><a href="#cb585-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb585-23"><a href="#cb585-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun_append_np(vals):</span>
<span id="cb585-24"><a href="#cb585-24" aria-hidden="true" tabindex="-1"></a>   x <span class="op">=</span> np.array([])</span>
<span id="cb585-25"><a href="#cb585-25" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb585-26"><a href="#cb585-26" aria-hidden="true" tabindex="-1"></a>       x <span class="op">=</span> np.append(x, np.exp(vals[i]))</span>
<span id="cb585-27"><a href="#cb585-27" aria-hidden="true" tabindex="-1"></a>   <span class="cf">return</span> x</span>
<span id="cb585-28"><a href="#cb585-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb585-29"><a href="#cb585-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb585-30"><a href="#cb585-30" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb585-31"><a href="#cb585-31" aria-hidden="true" tabindex="-1"></a>out1 <span class="op">=</span> fun_prealloc(z)</span>
<span id="cb585-32"><a href="#cb585-32" aria-hidden="true" tabindex="-1"></a>time.time() <span class="op">-</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.08990192413330078</code></pre>
</div>
<div class="sourceCode cell-code" id="cb587"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb587-1"><a href="#cb587-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb587-2"><a href="#cb587-2" aria-hidden="true" tabindex="-1"></a>out2 <span class="op">=</span> fun_append(z)</span>
<span id="cb587-3"><a href="#cb587-3" aria-hidden="true" tabindex="-1"></a>time.time() <span class="op">-</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.09307098388671875</code></pre>
</div>
<div class="sourceCode cell-code" id="cb589"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb589-1"><a href="#cb589-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb589-2"><a href="#cb589-2" aria-hidden="true" tabindex="-1"></a>out3 <span class="op">=</span> fun_append_np(z)</span>
<span id="cb589-3"><a href="#cb589-3" aria-hidden="true" tabindex="-1"></a>time.time() <span class="op">-</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2.4568870067596436</code></pre>
</div>
</div>
<p>So what’s going on? First let’s consider what is happening with the use of <code>np.append</code>. Note that it is a function, rather than a method, and we need to reassign to <code>x</code>. What must be happening in terms of memory use and copying when we append an element?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb591"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb591-1"><a href="#cb591-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb591-2"><a href="#cb591-2" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231507133712</code></pre>
</div>
<div class="sourceCode cell-code" id="cb593"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb593-1"><a href="#cb593-1" aria-hidden="true" tabindex="-1"></a><span class="bu">id</span>(np.append(x, <span class="fl">3.34</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>128231507140144</code></pre>
</div>
</div>
<p>We can avoid that large cost of copying and memory allocation by pre-allocating space for the entire output array. (This is equivalent to variable initialization in compiled languages.)</p>
<p>Ok, but how is it that we can append to the <strong>list</strong> at apparently no cost?</p>
<p>It’s not magic, just that Python is clever. Let’s get an idea of what is going on:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb595"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb595-1"><a href="#cb595-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun_append2(vals):</span>
<span id="cb595-2"><a href="#cb595-2" aria-hidden="true" tabindex="-1"></a>   n <span class="op">=</span> <span class="bu">len</span>(vals)</span>
<span id="cb595-3"><a href="#cb595-3" aria-hidden="true" tabindex="-1"></a>   x <span class="op">=</span> []</span>
<span id="cb595-4"><a href="#cb595-4" aria-hidden="true" tabindex="-1"></a>   <span class="bu">print</span>(<span class="ss">f"Initial id: </span><span class="sc">{</span><span class="bu">id</span>(x)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb595-5"><a href="#cb595-5" aria-hidden="true" tabindex="-1"></a>   sz <span class="op">=</span> sys.getsizeof(x)</span>
<span id="cb595-6"><a href="#cb595-6" aria-hidden="true" tabindex="-1"></a>   <span class="bu">print</span>(<span class="ss">f"iteration 0: size </span><span class="sc">{</span>sz<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb595-7"><a href="#cb595-7" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb595-8"><a href="#cb595-8" aria-hidden="true" tabindex="-1"></a>       x.append(np.exp(vals[i]))</span>
<span id="cb595-9"><a href="#cb595-9" aria-hidden="true" tabindex="-1"></a>       <span class="cf">if</span> sys.getsizeof(x) <span class="op">!=</span> sz:</span>
<span id="cb595-10"><a href="#cb595-10" aria-hidden="true" tabindex="-1"></a>           sz <span class="op">=</span> sys.getsizeof(x)</span>
<span id="cb595-11"><a href="#cb595-11" aria-hidden="true" tabindex="-1"></a>           <span class="bu">print</span>(<span class="ss">f"iteration </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: size </span><span class="sc">{</span>sz<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb595-12"><a href="#cb595-12" aria-hidden="true" tabindex="-1"></a>   <span class="bu">print</span>(<span class="ss">f"Final id: </span><span class="sc">{</span><span class="bu">id</span>(x)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb595-13"><a href="#cb595-13" aria-hidden="true" tabindex="-1"></a>   <span class="cf">return</span> x</span>
<span id="cb595-14"><a href="#cb595-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb595-15"><a href="#cb595-15" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">1000</span>)</span>
<span id="cb595-16"><a href="#cb595-16" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> fun_append2(z)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Initial id: 128231510177216
iteration 0: size 56
iteration 0: size 88
iteration 4: size 120
iteration 8: size 184
iteration 16: size 248
iteration 24: size 312
iteration 32: size 376
iteration 40: size 472
iteration 52: size 568
iteration 64: size 664
iteration 76: size 792
iteration 92: size 920
iteration 108: size 1080
iteration 128: size 1240
iteration 148: size 1432
iteration 172: size 1656
iteration 200: size 1912
iteration 232: size 2200
iteration 268: size 2520
iteration 308: size 2872
iteration 352: size 3256
iteration 400: size 3704
iteration 456: size 4216
iteration 520: size 4792
iteration 592: size 5432
iteration 672: size 6136
iteration 760: size 6936
iteration 860: size 7832
iteration 972: size 8856
Final id: 128231510177216</code></pre>
</div>
</div>
<p>Surprisingly, the id of <code>x</code> doesn’t seem to change, even though we are allocating new memory at many of the iterations. What is happening is that <code>x</code> is a wrapper object that contains within it a reference to an array of references (pointers) to the list elements. The location of the wrapper object doesn’t change, but the underlying array of references/pointers is being reallocated.</p>
<p>Side note: I don’t know of any way to find out the location of the underlying array of pointers. I believe that under the hood, Python uses the <code>realloc</code> system call to request memory from the operating system when it needs to use additional pointers, and that the operating system can then try to allocate the additional memory at the same location (i.e., extending the block of memory).</p>
<p>Note that as we discussed in the previous section on memory use, our assessment of size above does not include the actual size of the list elements, as illustrated by having one element of the list be a big object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb597"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb597-1"><a href="#cb597-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sys.getsizeof(out))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>8856</code></pre>
</div>
<div class="sourceCode cell-code" id="cb599"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb599-1"><a href="#cb599-1" aria-hidden="true" tabindex="-1"></a>out[<span class="dv">2</span>] <span class="op">=</span> np.random.normal(size <span class="op">=</span> <span class="dv">100000</span>)</span>
<span id="cb599-2"><a href="#cb599-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sys.getsizeof(out))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>8856</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Grow objects using lists, then convert">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Grow objects using lists, then convert
</div>
</div>
<div class="callout-body-container callout-body">
<p>One upshot of how Python efficiently grows lists is that if you need to grow an object, use a Python list. Then once it is complete, you can always convert it to another type, such as a numpy array.</p>
</div>
</div>
</section>
<section id="vectorization-and-use-of-fast-matrix-algebra" class="level3">
<h3 class="anchored" data-anchor-id="vectorization-and-use-of-fast-matrix-algebra">Vectorization and use of fast matrix algebra</h3>
<p>One key way to write efficient Python code is to take advantage of numpy’s vectorized operations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb601"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb601-1"><a href="#cb601-1" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">10</span><span class="op">**</span><span class="dv">6</span></span>
<span id="cb601-2"><a href="#cb601-2" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> np.random.normal(size <span class="op">=</span> n)</span>
<span id="cb601-3"><a href="#cb601-3" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb601-4"><a href="#cb601-4" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.exp(z)</span>
<span id="cb601-5"><a href="#cb601-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(time.time() <span class="op">-</span> t0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.01285696029663086</code></pre>
</div>
<div class="sourceCode cell-code" id="cb603"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb603-1"><a href="#cb603-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.zeros(n)  <span class="co"># Leave out pre-allocation timing to focus on computation.</span></span>
<span id="cb603-2"><a href="#cb603-2" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb603-3"><a href="#cb603-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb603-4"><a href="#cb603-4" aria-hidden="true" tabindex="-1"></a>    x[i] <span class="op">=</span> np.exp(z[i])</span>
<span id="cb603-5"><a href="#cb603-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb603-6"><a href="#cb603-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb603-7"><a href="#cb603-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(time.time() <span class="op">-</span> t0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.7170143127441406</code></pre>
</div>
</div>
<p>So what is different in how Python handles the calculations above that explains the huge disparity in efficiency? The vectorized calculation is being done natively in C in a for loop. The explicit Python for loop involves executing the for loop in Python with repeated calls to C code at each iteration. This involves a lot of overhead because of the repeated processing of the Python code inside the loop. For example, in each iteration of the loop, Python is checking the types of the variables because it’s possible that the types might change, as discussed earlier.</p>
<p>You can usually get a sense for how quickly a Python call will pass things along to C or Fortran by looking at the body of the relevant function(s) being called.</p>
<p>Unfortunately seeing the source code in Python often involves going and finding it in a file on disk, whereas in R, printing a function will show its source code. However you can use <code>??</code> in IPython to get the code for non-builtin functions. Consider <code>numpy.linspace??</code>.</p>
<p>Here I found the source code for the scipy <code>triangular_solve</code> function, which calls out to a Fortran function <code>trtrs</code>, found in the LAPACK library.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb605"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb605-1"><a href="#cb605-1" aria-hidden="true" tabindex="-1"></a><span class="co">## On an SCF machine:</span></span>
<span id="cb605-2"><a href="#cb605-2" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/local/linux/miniforge-3.12/lib/python3.12/site-packages/scipy/linalg/_basic.py</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With a bit more digging around we could verify that <code>trtrs</code> is a LAPACK funcion by doing some grepping:</p>
<pre><code>./linalg/_basic.py:    trtrs, = get_lapack_funcs(('trtrs',), (a1, b1))</code></pre>
<p>Many numpy and scipy functions allow you to pass in arrays, and operate on those arrays in vectorized fashion. So before writing a for loop, look at the help information on the relevant function(s) to see if they operate in a vectorized fashion. Functions might take arrays for one or more of their arguments.</p>
<p>Outside of the numerical packages, we often have to manually do the looping:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb607"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb607-1"><a href="#cb607-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> [<span class="fl">3.5</span>, <span class="fl">2.7</span>, <span class="fl">4.6</span>]</span>
<span id="cb607-2"><a href="#cb607-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb607-3"><a href="#cb607-3" aria-hidden="true" tabindex="-1"></a>    math.cos(x)</span>
<span id="cb607-4"><a href="#cb607-4" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> error:</span>
<span id="cb607-5"><a href="#cb607-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(error)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>must be real number, not list</code></pre>
</div>
<div class="sourceCode cell-code" id="cb609"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb609-1"><a href="#cb609-1" aria-hidden="true" tabindex="-1"></a>[math.cos(val) <span class="cf">for</span> val <span class="kw">in</span> x]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[-0.9364566872907963, -0.9040721420170612, -0.11215252693505487]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb611"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb611-1"><a href="#cb611-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(<span class="bu">map</span>(math.cos, x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[-0.9364566872907963, -0.9040721420170612, -0.11215252693505487]</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Challenge">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge
</div>
</div>
<div class="callout-body-container callout-body">
<p>Consider the chi-squared statistic involved in a test of independence in a contingency table:</p>
<p><span class="math display">\[
\chi^{2}=\sum_{i}\sum_{j}\frac{(y_{ij}-e_{ij})^{2}}{e_{ij}},\,\,\,\, e_{ij}=\frac{y_{i\cdot}y_{\cdot j}}{y_{\cdot\cdot}}
\]</span></p>
<p>where <span class="math inline">\(y_{i\cdot}=\sum_{j}y_{ij}\)</span> and <span class="math inline">\(y_{\cdot j} = \sum_{i} y_{ij}\)</span> and <span class="math inline">\(y_{\cdot\cdot} = \sum_{i} \sum_{j} y_{ij}\)</span>. Write this in a vectorized way without any loops. Note that ‘vectorized’ calculations also work with matrices and arrays.</p>
</div>
</div>
<p>Sometimes we can exploit vectorized mathematical operations in surprising ways, though sometimes the code is uglier.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb613"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb613-1"><a href="#cb613-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> n)</span>
<span id="cb613-2"><a href="#cb613-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb613-3"><a href="#cb613-3" aria-hidden="true" tabindex="-1"></a><span class="co">## List comprehension</span></span>
<span id="cb613-4"><a href="#cb613-4" aria-hidden="true" tabindex="-1"></a>timeit.timeit(<span class="st">'truncx = [max(0,val) for val in x]'</span>, number <span class="op">=</span> <span class="dv">10</span>, <span class="bu">globals</span> <span class="op">=</span> {<span class="st">'x'</span>:x})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.7045243841130286</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb615"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb615-1"><a href="#cb615-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Vectorized slice replacement</span></span>
<span id="cb615-2"><a href="#cb615-2" aria-hidden="true" tabindex="-1"></a>timeit.timeit(<span class="st">'truncx = x.copy(); truncx[x &lt; 0] = 0'</span>, number <span class="op">=</span> <span class="dv">10</span>, <span class="bu">globals</span> <span class="op">=</span> {<span class="st">'x'</span>:x})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.06893204897642136</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb617"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb617-1"><a href="#cb617-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Vectorized math trick</span></span>
<span id="cb617-2"><a href="#cb617-2" aria-hidden="true" tabindex="-1"></a>timeit.timeit(<span class="st">'truncx = x * x&gt;0'</span>, number <span class="op">=</span> <span class="dv">10</span>, <span class="bu">globals</span> <span class="op">=</span> {<span class="st">'x'</span>:x})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.015284791123121977</code></pre>
</div>
</div>
<p>We’ll discuss what has to happen (in terms of calculations, memory allocation, and copying) in the two vectorized approaches to try to understand which is more efficient.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Additional efficiency tips">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Additional efficiency tips
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>If you do need to loop over dimensions of a matrix or array, if possible loop over the smallest dimension and use the vectorized calculation on the larger dimension(s). For example if you have a 10000 by 10 matrix, try to set up your problem so you can loop over the 10 columns rather than the 10000 rows.</li>
<li>In general, in Python looping over rows is likely to be faster than looping over columns because of numpy’s row-major ordering (by default, matrices are stored in memory as a long array in which values in a row are adjacent to each other). However how numpy handles this is <a href="https://numpy.org/doc/stable/dev/internals.html#multidimensional-array-indexing-order-issues">more complicated</a> (see more in the <a href="#cache-aware-programming">Section on cache-aware programming</a>), such that it may not matter for numpy calculations.</li>
<li>You can use direct arithmetic operations to add/subtract/multiply/divide a 1-d array by each column of a matrix, e.g.&nbsp;<code>A*b</code> does element-wise multiplication of each row of <em>A</em> by a 1-d array <em>b</em>. If you need to operate by column, you can do it by transposing the matrix.</li>
</ul>
</div>
</div>
<p>Caution: relying on Python’s broadcasting rule in the context of vectorized operations, such as is done when direct-multiplying a matrix by a 1-d array to scale the columns relative to each other, can be dangerous as the code may not be easy for someone to read and poses greater dangers of bugs. In some cases you may want to first write the code more directly and then compare the more efficient code to make sure the results are the same. It’s also a good idea to comment your code in such cases.</p>
</section>
<section id="vectorization-mapping-and-loops" class="level3">
<h3 class="anchored" data-anchor-id="vectorization-mapping-and-loops">Vectorization, mapping, and loops</h3>
<p>Next let’s consider when loops and mapping would be particularly slow and how mapping and loops might compare to each other.</p>
<p>First, the potential for inefficiency of looping and map operations in interpreted languages will depend in part on whether a substantial part of the work is in the overhead involved in the looping or in the time required by the function evaluation on each of the elements.</p>
<p>Here’s an example, where the core computation is very fast, so we might expect the overhead of looping (in its various forms seen here) to be important.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb619"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb619-1"><a href="#cb619-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb619-2"><a href="#cb619-2" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">10</span><span class="op">**</span><span class="dv">6</span></span>
<span id="cb619-3"><a href="#cb619-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> n)</span>
<span id="cb619-4"><a href="#cb619-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb619-5"><a href="#cb619-5" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb619-6"><a href="#cb619-6" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> np.exp(x)</span>
<span id="cb619-7"><a href="#cb619-7" aria-hidden="true" tabindex="-1"></a>time.time() <span class="op">-</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.01398921012878418</code></pre>
</div>
<div class="sourceCode cell-code" id="cb621"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb621-1"><a href="#cb621-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb621-2"><a href="#cb621-2" aria-hidden="true" tabindex="-1"></a>vals <span class="op">=</span> np.zeros(n)</span>
<span id="cb621-3"><a href="#cb621-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb621-4"><a href="#cb621-4" aria-hidden="true" tabindex="-1"></a>    vals[i] <span class="op">=</span> np.exp(x[i])</span>
<span id="cb621-5"><a href="#cb621-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb621-6"><a href="#cb621-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb621-7"><a href="#cb621-7" aria-hidden="true" tabindex="-1"></a>time.time() <span class="op">-</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.0142087936401367</code></pre>
</div>
<div class="sourceCode cell-code" id="cb623"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb623-1"><a href="#cb623-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb623-2"><a href="#cb623-2" aria-hidden="true" tabindex="-1"></a>vals <span class="op">=</span> [np.exp(v) <span class="cf">for</span> v <span class="kw">in</span> x]</span>
<span id="cb623-3"><a href="#cb623-3" aria-hidden="true" tabindex="-1"></a>time.time() <span class="op">-</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.7831203937530518</code></pre>
</div>
<div class="sourceCode cell-code" id="cb625"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb625-1"><a href="#cb625-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb625-2"><a href="#cb625-2" aria-hidden="true" tabindex="-1"></a>vals <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(np.exp, x))</span>
<span id="cb625-3"><a href="#cb625-3" aria-hidden="true" tabindex="-1"></a>time.time() <span class="op">-</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.679100751876831</code></pre>
</div>
</div>
<p>Regardless of how we do the looping (an explicit loop, list comprehension, or <code>map</code>), it looks like we can’t avoid the overhead unless we use the vectorized call, which is of course the recommended approach in this case, both for speed and readability (and conciseness).</p>
<p>Second, is it faster to use <code>map</code> than to use a loop? In the example above it is somewhat (but not substantially) faster to use <code>map</code> (and still much slower than vectorization). In the loop case, the interpreter needs to do the checking we discussed earlier in this section at each iteration of the loop. What about in the <code>map</code> case? For mapping over a numpy array, perhaps not, but what if mapping over a list? Without digging into how <code>map</code> works, it’s hard to say, but it does seem that based on this example, <code>map</code> is not doing anything special that saves much time when mapping over the elements of a numpy array.</p>
<p>Here’s an example where the bulk of time is in the actual computation and not in the looping itself. We’ll run a bunch of regressions on a matrix <code>X</code> (i.e., each column of <code>X</code> is a predictor) using each column of the matrix <code>mat</code> to do a separate regression.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb627"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb627-1"><a href="#cb627-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb627-2"><a href="#cb627-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb627-3"><a href="#cb627-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb627-4"><a href="#cb627-4" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">500000</span><span class="op">;</span></span>
<span id="cb627-5"><a href="#cb627-5" aria-hidden="true" tabindex="-1"></a>nr <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb627-6"><a href="#cb627-6" aria-hidden="true" tabindex="-1"></a>nCalcs <span class="op">=</span> <span class="bu">int</span>(n<span class="op">/</span>nr)</span>
<span id="cb627-7"><a href="#cb627-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb627-8"><a href="#cb627-8" aria-hidden="true" tabindex="-1"></a>mat <span class="op">=</span> np.random.normal(size <span class="op">=</span> (nr, nCalcs))</span>
<span id="cb627-9"><a href="#cb627-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb627-10"><a href="#cb627-10" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(nr))</span>
<span id="cb627-11"><a href="#cb627-11" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> sm.add_constant(X)</span>
<span id="cb627-12"><a href="#cb627-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb627-13"><a href="#cb627-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> regrFun(i):</span>
<span id="cb627-14"><a href="#cb627-14" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> sm.OLS(mat[:,i], X)</span>
<span id="cb627-15"><a href="#cb627-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model.fit().params[<span class="dv">1</span>]</span>
<span id="cb627-16"><a href="#cb627-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb627-17"><a href="#cb627-17" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb627-18"><a href="#cb627-18" aria-hidden="true" tabindex="-1"></a>out1 <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(regrFun, <span class="bu">range</span>(nCalcs)))</span>
<span id="cb627-19"><a href="#cb627-19" aria-hidden="true" tabindex="-1"></a>time.time() <span class="op">-</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.06848573684692383</code></pre>
</div>
<div class="sourceCode cell-code" id="cb629"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb629-1"><a href="#cb629-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb629-2"><a href="#cb629-2" aria-hidden="true" tabindex="-1"></a>out2 <span class="op">=</span> np.zeros(nCalcs)</span>
<span id="cb629-3"><a href="#cb629-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(nCalcs):</span>
<span id="cb629-4"><a href="#cb629-4" aria-hidden="true" tabindex="-1"></a>    out2[i] <span class="op">=</span> regrFun(i)</span>
<span id="cb629-5"><a href="#cb629-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb629-6"><a href="#cb629-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb629-7"><a href="#cb629-7" aria-hidden="true" tabindex="-1"></a>time.time() <span class="op">-</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.06563305854797363</code></pre>
</div>
</div>
<p>Here they’re about the same time (depending on when I render the document, I am getting some stochasticity in the timing). This is not too surprising – the overhead of the iteration should be small relative to the fundamental cost of the model fitting, and we wouldn’t be concerned with the overhead of using a loop.</p>
</section>
<section id="matrix-algebra-efficiency" class="level3">
<h3 class="anchored" data-anchor-id="matrix-algebra-efficiency">Matrix algebra efficiency</h3>
<p>Often calculations that are not explicitly linear algebra calculations can be done as matrix algebra. If our Python installation has a fast (and possibly parallelized) BLAS, this allows our calculation to take advantage of it.</p>
<p>For example, we can sum the rows of a matrix by multiplying by a 1-d array of ones.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb631"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb631-1"><a href="#cb631-1" aria-hidden="true" tabindex="-1"></a>mat <span class="op">=</span> np.random.normal(size<span class="op">=</span>(<span class="dv">500</span>,<span class="dv">500</span>))</span>
<span id="cb631-2"><a href="#cb631-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb631-3"><a href="#cb631-3" aria-hidden="true" tabindex="-1"></a>timeit.timeit(<span class="st">'mat.dot(np.ones(500))'</span>, setup <span class="op">=</span> <span class="st">'import numpy as np'</span>,</span>
<span id="cb631-4"><a href="#cb631-4" aria-hidden="true" tabindex="-1"></a>              number <span class="op">=</span> <span class="dv">1000</span>, <span class="bu">globals</span> <span class="op">=</span> {<span class="st">'mat'</span>: mat})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.04924217896768823</code></pre>
</div>
<div class="sourceCode cell-code" id="cb633"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb633-1"><a href="#cb633-1" aria-hidden="true" tabindex="-1"></a>timeit.timeit(<span class="st">'np.sum(mat, axis = 1)'</span>, setup <span class="op">=</span> <span class="st">'import numpy as np'</span>,</span>
<span id="cb633-2"><a href="#cb633-2" aria-hidden="true" tabindex="-1"></a>              number <span class="op">=</span> <span class="dv">1000</span>, <span class="bu">globals</span> <span class="op">=</span> {<span class="st">'mat'</span>: mat})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.14316379296360537</code></pre>
</div>
</div>
<p>Given the extra computation involved in actually multiplying each number by one, it’s surprising that this is faster than numpy sum function. One thing we’d want to know is whether the BLAS matrix multiplication call is being done in parallel.</p>
<p>On the other hand, big matrix operations can be slow.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Challenge">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge
</div>
</div>
<div class="callout-body-container callout-body">
<p>Suppose you want a new matrix that computes the differences between successive columns of a matrix of arbitrary size. How would you do this as matrix algebra operations? It’s possible to write it as multiplying the matrix by another matrix that contains 0s, 1s, and -1s in appropriate places. Here it turns out that the <em>for</em> loop is much faster than matrix multiplication. However, there is a way to do it faster as matrix direct subtraction.</p>
</div>
</div>
</section>
<section id="order-of-operations-and-efficiency" class="level3">
<h3 class="anchored" data-anchor-id="order-of-operations-and-efficiency">Order of operations and efficiency</h3>
<p>When doing matrix algebra, the order in which you do operations can be critical for efficiency. How should I order the following calculation?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb635"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb635-1"><a href="#cb635-1" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">5000</span></span>
<span id="cb635-2"><a href="#cb635-2" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> np.random.normal(size<span class="op">=</span>(n, n))</span>
<span id="cb635-3"><a href="#cb635-3" aria-hidden="true" tabindex="-1"></a>B <span class="op">=</span> np.random.normal(size<span class="op">=</span>(n, n))</span>
<span id="cb635-4"><a href="#cb635-4" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size<span class="op">=</span>n)</span>
<span id="cb635-5"><a href="#cb635-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb635-6"><a href="#cb635-6" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb635-7"><a href="#cb635-7" aria-hidden="true" tabindex="-1"></a>res1 <span class="op">=</span> (A <span class="op">@</span> B) <span class="op">@</span> x</span>
<span id="cb635-8"><a href="#cb635-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(time.time() <span class="op">-</span> t0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2.171241044998169</code></pre>
</div>
<div class="sourceCode cell-code" id="cb637"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb637-1"><a href="#cb637-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb637-2"><a href="#cb637-2" aria-hidden="true" tabindex="-1"></a>res1 <span class="op">=</span> A <span class="op">@</span> (B <span class="op">@</span> x)</span>
<span id="cb637-3"><a href="#cb637-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(time.time() <span class="op">-</span> t0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.03216886520385742</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Challenge">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge
</div>
</div>
<div class="callout-body-container callout-body">
<p>Why is the second order much faster?</p>
<p>Count the number of multiplications involved in each of the two approaches.</p>
</div>
</div>
</section>
<section id="avoiding-unnecessary-operations" class="level3">
<h3 class="anchored" data-anchor-id="avoiding-unnecessary-operations">Avoiding unnecessary operations</h3>
<p>We can use the matrix direct product (i.e., <code>A*B</code>) to do some manipulations much more quickly than using matrix multiplication.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Challenge">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge
</div>
</div>
<div class="callout-body-container callout-body">
<p>How can I use the direct product to find the trace of a matrix, <span class="math inline">\(XY\)</span>?</p>
</div>
</div>
<p>When working with diagonal matrices, you can generally get much faster results by being smart. The following operations: <span class="math inline">\(X+D\)</span>, <span class="math inline">\(DX\)</span>, <span class="math inline">\(XD\)</span> are mathematically the sum of two matrices and products of two matrices. But we can do the computation without using two full matrices.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb639"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb639-1"><a href="#cb639-1" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb639-2"><a href="#cb639-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> np.random.normal(size<span class="op">=</span>(n, n))</span>
<span id="cb639-3"><a href="#cb639-3" aria-hidden="true" tabindex="-1"></a>diagvals <span class="op">=</span> np.random.normal(size<span class="op">=</span>n)</span>
<span id="cb639-4"><a href="#cb639-4" aria-hidden="true" tabindex="-1"></a>D <span class="op">=</span> np.diag(diagvals)</span>
<span id="cb639-5"><a href="#cb639-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb639-6"><a href="#cb639-6" aria-hidden="true" tabindex="-1"></a><span class="co"># The following lines are very inefficient</span></span>
<span id="cb639-7"><a href="#cb639-7" aria-hidden="true" tabindex="-1"></a>summedMat <span class="op">=</span> X <span class="op">+</span> D</span>
<span id="cb639-8"><a href="#cb639-8" aria-hidden="true" tabindex="-1"></a>prodMat1 <span class="op">=</span> D <span class="op">@</span> X</span>
<span id="cb639-9"><a href="#cb639-9" aria-hidden="true" tabindex="-1"></a>prodMat2 <span class="op">=</span> X <span class="op">@</span> D</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Challenge">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge
</div>
</div>
<div class="callout-body-container callout-body">
<p>Consider either <span class="math inline">\(X+D\)</span>, <span class="math inline">\(DX\)</span>, or <span class="math inline">\(XD\)</span>. How can I use vectorization to do this much more quickly than the direct, naive translation of the math into code?</p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled" title="Exploit sparsity/structure!">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exploit sparsity/structure!
</div>
</div>
<div class="callout-body-container callout-body">
<p>More generally, sparse matrices and structured matrices (such as block diagonal matrices) can generally be worked with MUCH more efficiently than treating them as arbitrary matrices. The <code>scipy.sparse</code> package (for both structured and arbitrary sparse matrices) can help, as can specialized code available in other languages, such as C and Fortran packages.</p>
</div>
</div>
</section>
<section id="speed-of-lookup-operations" class="level3">
<h3 class="anchored" data-anchor-id="speed-of-lookup-operations">Speed of lookup operations</h3>
<p>There are lots of situations in which we need to retrieve values for subsequent computations. In some cases we might be retrieving elements of an array or looking up values in a dictionary.</p>
<p>Let’s compare the speed of some different approaches to lookup.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb640"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb640-1"><a href="#cb640-1" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb640-2"><a href="#cb640-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="bu">list</span>(np.random.normal(size <span class="op">=</span> n))</span>
<span id="cb640-3"><a href="#cb640-3" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> [<span class="bu">str</span>(v) <span class="cf">for</span> v <span class="kw">in</span> <span class="bu">range</span>(n)]</span>
<span id="cb640-4"><a href="#cb640-4" aria-hidden="true" tabindex="-1"></a>xD <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(labels, x))</span>
<span id="cb640-5"><a href="#cb640-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb640-6"><a href="#cb640-6" aria-hidden="true" tabindex="-1"></a>timeit.timeit(<span class="st">"x[500]"</span>, number <span class="op">=</span> <span class="dv">10</span><span class="op">**</span><span class="dv">6</span>, <span class="bu">globals</span> <span class="op">=</span> {<span class="st">'x'</span>:x})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.020614201028365642</code></pre>
</div>
<div class="sourceCode cell-code" id="cb642"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb642-1"><a href="#cb642-1" aria-hidden="true" tabindex="-1"></a>timeit.timeit(<span class="st">"xD['500']"</span>, number<span class="op">=</span><span class="dv">10</span><span class="op">**</span><span class="dv">6</span>, <span class="bu">globals</span> <span class="op">=</span> {<span class="st">'xD'</span>:xD})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.029645846982020885</code></pre>
</div>
</div>
<p>How is it that Python can look up by key in the dictionary at essentially the same speed as jumping to an index position? It uses hashing, which allows O(1) lookup. In contrast, if one has to look through each label (key) in turn, that is O(n), which is much slower:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb644"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb644-1"><a href="#cb644-1" aria-hidden="true" tabindex="-1"></a>timeit.timeit(<span class="st">"x[labels.index('500')]"</span>, number <span class="op">=</span> <span class="dv">10</span><span class="op">**</span><span class="dv">6</span>, <span class="bu">globals</span> <span class="op">=</span> {<span class="st">'x'</span>:x, <span class="st">'labels'</span>: labels})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>6.221759032050613</code></pre>
</div>
</div>
<p>As a further point of contrast, if we look up elements by name in R in named vectors or lists, that is much slower than looking up by index, because R doesn’t use hashing in that context and has to scan through the objects one by one until it finds the one with the name it is looking for. This stands in contrast to R and Python being able to directly go to the position of interest based on the index of an array, or to the hash-based lookup in a Python dictionary or an R environment.</p>
</section>
<section id="hashing-including-name-lookup" class="level3">
<h3 class="anchored" data-anchor-id="hashing-including-name-lookup">Hashing (including name lookup)</h3>
<p>Above I mentioned that Python uses hashing to store and lookup values by key in a dictionary. I’ll briefly describe what hashing is here, because it is a commonly-used strategy in programming in general.</p>
<p>A hash function is a function that takes as input some data (some input of arbitrary length) and maps it to a fixed-length output that can be used as a shortened reference to the data. (The function should be deterministic, always returing the same output for a given input.) We’ve seen this in the context of git commits where each commit was labeled with a long base-16 number. This also comes up when verifying files on the Internet. You can compute the hash value on the file you get and check that it is the same as the hash value associated with the legitimate copy of the file. Even small changes in the file will result in a different hash value.</p>
<p>While there are various uses of hashing, for our purposes here, hashing can allow one to look up values by their name via a hash table. The idea is that you have a set of key-value pairs (sometimes called a dictionary) where the key is the name associated with the value and the value is some arbitrary object. You want to be able to quickly find the value/object quickly.</p>
<p>Hashing allows one to quickly determine an index associated with the key and therefore quickly find the relevant value based on the index. For example, one approach is to compute the hash as a function of the key and then take the remainder when dividing by the number of possible results (here the fact that the result is a fixed-length output is important) to get the index. Here’s the procedure in pseudocode:</p>
<pre><code>    hash = hashfunc(key) 
    index = hash %% array_size 
    ## %% is modulo operator - it gives the remainder</code></pre>
<p>In general, there will be collisions – multiple keys will be assigned to the same index (this is unavoidable because of the fact that the hash function returns a fixed length output). However with a good hash function, usually there will be a small number of keys associated with a given bucket. So each bucket will contain a list of a small number of values and the associated keys. (The buckets might contain the actual values or they might contain the addresses of where the values are actually stored if the values are complicated objects.) Then determining the correct value (or the required address) within a given bucket is fast even with simple linear search through the items one by one. Put another way, the hash function distributes the keys amongst an array of buckets and allows one to look up the appropriate bucket quickly based on the computed index value. When the hash table is properly set up, the cost of looking up a value does not depend on the number of key-value pairs stored.</p>
<p>Python uses hashing to look up the value based on the key in a given dictionary, and similarly when looking up variables in namespaces. This allows Python to retrieve objects very quickly.</p>
</section>
</section>
<section id="additional-general-strategies-for-efficiency" class="level2">
<h2 class="anchored" data-anchor-id="additional-general-strategies-for-efficiency">Additional general strategies for efficiency</h2>
<p>It’s also useful to be aware of some other strategies for improving efficiency.</p>
<section id="cache-aware-programming" class="level3">
<h3 class="anchored" data-anchor-id="cache-aware-programming">Cache-aware programming</h3>
<p>In addition to main memory (what we usually mean when we talk about RAM), computers also have memory caches, which are small amounts of fast memory that can be accessed very quickly by the processor. For example your computer might have L1, L2, and L3 caches, with L1 the smallest and fastest and L3 the largest and slowest. The idea is to try to have the data that is most used by the processor in the cache.</p>
<p>If the next piece of data needed for computation is available in the cache, this is a <em>cache hit</em> and the data can be accessed very quickly. However, if the data is not available in the cache, this is a <em>cache miss</em> and the speed of access will be a lot slower. <em>Cache-aware programming</em> involves writing your code to minimize cache misses. Generally when data is read from memory it will be read in chunks, so values that are contiguous will be read together.</p>
<p>How does this inform one’s programming? For example, if you have a matrix of values stored in row-major order, computing on a row will be a lot faster than computing on a column, because the row can be read into the cache from main memory and then accessed in the cache. In contrast, if the matrix is large and therefore won’t fit in the cache, when you access the values of a column, you’ll have to go to main memory repeatedly to get the values for the row because the values are not stored contiguously.</p>
<p>There’s a nice example of the importance of the cache at <a href="https://wrathematics.github.io/2016/10/28/comparing-symmetric-eigenvalue-performance/">the bottom of this blog post</a>.</p>
<p>If you know the size of the cache, you can try to design your code so that in a given part of your code you access data structures that will fit in the cache. This sort of thing is generally more relevant if you’re coding in a language like C. But it can matter sometimes in interpreted languages too.</p>
<p>Let’s see what happens in Python. By default, matrices in numpy are row-major, also called “C order”. I’ll create a long matrix with a small number of very long columns and a wide matrix with a small number of very long rows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb647"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb647-1"><a href="#cb647-1" aria-hidden="true" tabindex="-1"></a>nr <span class="op">=</span> <span class="dv">800000</span></span>
<span id="cb647-2"><a href="#cb647-2" aria-hidden="true" tabindex="-1"></a>nc <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb647-3"><a href="#cb647-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb647-4"><a href="#cb647-4" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> np.random.normal(size<span class="op">=</span>(nr, nc))   <span class="co"># long matrix</span></span>
<span id="cb647-5"><a href="#cb647-5" aria-hidden="true" tabindex="-1"></a>tA <span class="op">=</span> np.random.normal(size<span class="op">=</span>(nc, nr))  <span class="co"># wide matrix</span></span>
<span id="cb647-6"><a href="#cb647-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb647-7"><a href="#cb647-7" aria-hidden="true" tabindex="-1"></a><span class="co">## Verify that A is row-major using `.flags` (notice the `C_CONTIGUOUS: True`).</span></span>
<span id="cb647-8"><a href="#cb647-8" aria-hidden="true" tabindex="-1"></a>A.flags</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  C_CONTIGUOUS : True
  F_CONTIGUOUS : False
  OWNDATA : True
  WRITEABLE : True
  ALIGNED : True
  WRITEBACKIFCOPY : False</code></pre>
</div>
</div>
<p>Note that I didn’t use <code>A.T</code> or <code>np.transpose</code> as that doesn’t make a copy in memory and so the transposed matrix doesn’t end up being row-major. You can use <code>A.flags</code> and A.T.flags` to see this.</p>
<p>Now let’s time calculating the sum by column in the long matrix vs.&nbsp;the sum by row in the wide matrix. Exactly the same number of arithmetic operations needs to be done in an equivalent manner for the two cases. We want to use a large enough matrix so the entire matrix doesn’t fit in the cache, but not so large that the example takes a long time or a huge amount of memory. We’ll use a rectangular matrix, such that the summation for a single column of the long matrix or a single row of the wide matrix involves many numbers, but there are a limited number of such summations. This focuses the example on the efficiency of the column-wise vs.&nbsp;row-wise summation rather than any issues that might be involved in managing large numbers of such summations (e.g., doing many, many summations that involve just a few numbers).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb649"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb649-1"><a href="#cb649-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the sum calculations as functions</span></span>
<span id="cb649-2"><a href="#cb649-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sum_by_row():</span>
<span id="cb649-3"><a href="#cb649-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.<span class="bu">sum</span>(tA, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb649-4"><a href="#cb649-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb649-5"><a href="#cb649-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sum_by_column():</span>
<span id="cb649-6"><a href="#cb649-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.<span class="bu">sum</span>(A, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb649-7"><a href="#cb649-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb649-8"><a href="#cb649-8" aria-hidden="true" tabindex="-1"></a>timeit.timeit(sum_by_row, number<span class="op">=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.4013006199966185</code></pre>
</div>
<div class="sourceCode cell-code" id="cb651"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb651-1"><a href="#cb651-1" aria-hidden="true" tabindex="-1"></a>timeit.timeit(sum_by_column, number<span class="op">=</span><span class="dv">10</span>)  <span class="co"># potentially slow</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.47492743702605367</code></pre>
</div>
</div>
<p>Suppose we instead do the looping manually.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb653"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb653-1"><a href="#cb653-1" aria-hidden="true" tabindex="-1"></a>timeit.timeit(<span class="st">'[np.sum(A[:,col]) for col in range(A.shape[1])]'</span>,</span>
<span id="cb653-2"><a href="#cb653-2" aria-hidden="true" tabindex="-1"></a>    setup <span class="op">=</span> <span class="st">'import numpy as np'</span>, number<span class="op">=</span><span class="dv">10</span>, <span class="bu">globals</span> <span class="op">=</span> {<span class="st">'A'</span>: A})   </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>5.249344462004956</code></pre>
</div>
<div class="sourceCode cell-code" id="cb655"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb655-1"><a href="#cb655-1" aria-hidden="true" tabindex="-1"></a>timeit.timeit(<span class="st">'[np.sum(tA[row,:]) for row in range(tA.shape[0])]'</span>,</span>
<span id="cb655-2"><a href="#cb655-2" aria-hidden="true" tabindex="-1"></a>    setup <span class="op">=</span> <span class="st">'import numpy as np'</span>, number<span class="op">=</span><span class="dv">10</span>, <span class="bu">globals</span> <span class="op">=</span> {<span class="st">'tA'</span>: tA})  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.4107386370305903</code></pre>
</div>
</div>
<p>Indeed, the row-wise calculations are much faster when done manually. However, when done with the <code>axis</code> argument in <code>np.sum</code> there is little difference. So that suggests numpy might be doing something clever in its implementation of <code>sum</code> with the <code>axis</code> argument.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Challenge">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge
</div>
</div>
<div class="callout-body-container callout-body">
<p>Suppose you were writing code for this kind of use case. How could you set up your calculations to do either row-wise or column-wise operations in a way that processes each number sequentially based on the order in which the numbers are stored? For example suppose the values are stored row-major but you want the column sums.</p>
</div>
</div>
<p>When we define a numpy array, we can choose to use column-major order (i.e., “Fortran” order) with the <code>order</code> argument.</p>
</section>
<section id="loop-fusion" class="level3">
<h3 class="anchored" data-anchor-id="loop-fusion">Loop fusion</h3>
<p>Let’s consider this (vectorized) code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb657"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb657-1"><a href="#cb657-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.exp(x) <span class="op">+</span> <span class="dv">3</span><span class="op">*</span>np.sin(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This code has some downsides.</p>
<ul>
<li>Think about whether any additional memory has to be allocated.</li>
<li>Think about how many for loops will have to get executed.</li>
</ul>
<p>Contrast that to running directly as a for loop (e.g., here in Julia or in C/C++):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb658"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb658-1"><a href="#cb658-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu">length</span>(x)</span>
<span id="cb658-2"><a href="#cb658-2" aria-hidden="true" tabindex="-1"></a>    x[i] <span class="op">=</span> <span class="fu">exp</span>(x[i]) <span class="op">+</span> <span class="fl">3</span><span class="fu">*sin</span>(x[i])</span>
<span id="cb658-3"><a href="#cb658-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>How does that affect the downsides mentioned above?</p>
<p>Combining loops is called ‘fusing’ and is an <a href="https://docs.julialang.org/en/v1/manual/performance-tips/#More-dots:-Fuse-vectorized-operations">important optimization that Julia can do</a>, as shown in <a href="https://computing.stat.berkeley.edu/tutorial-parallelization/parallel-julia#4-loops-and-fused-operations">this demo</a>. It’s also a <a href="https://www.tensorflow.org/xla">key optimization done by XLA</a>, a compiler used with JAX and Tensorflow, so one approach to getting loop fusion in Python is to use JAX (or Tensorflow) for such calculations within Python rather than simply using numpy.</p>
</section>
<section id="jit-compilation-with-jax" class="level3">
<h3 class="anchored" data-anchor-id="jit-compilation-with-jax">JIT compilation (with JAX)</h3>
<p>You can think of JAX as a version of numpy enabled to use the GPU (or automatically parallelize on CPU threads) and provide automatic differentiation.</p>
<p>We can also JIT compile JAX code. Behind the scenes, the instructions are compiled to machine code for different backends (e.g., CPU and GPU) using the XLA compiler.</p>
<p>Let’s first consider running a vectorized calculation using JAX on the CPU, which will use multiple threads (discussed in Unit 6), each thread running on a separate CPU core on our computer. For now all we need to know is that the calculation will run in parallel, so we expect it to be faster than when using numpy, which won’t run the calculation in parallel.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>This demo uses 4 GB of memory just for <code>x</code>. Run on your own machine with caution.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb659"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb659-1"><a href="#cb659-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb659-2"><a href="#cb659-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb659-3"><a href="#cb659-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.numpy <span class="im">as</span> jnp</span>
<span id="cb659-4"><a href="#cb659-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb659-5"><a href="#cb659-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> myfun_np(x):</span>
<span id="cb659-6"><a href="#cb659-6" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> np.exp(x) <span class="op">+</span> <span class="dv">3</span> <span class="op">*</span> np.sin(x)</span>
<span id="cb659-7"><a href="#cb659-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> y</span>
<span id="cb659-8"><a href="#cb659-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb659-9"><a href="#cb659-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> myfun_jnp(x):</span>
<span id="cb659-10"><a href="#cb659-10" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> jnp.exp(x) <span class="op">+</span> <span class="dv">3</span> <span class="op">*</span> jnp.sin(x)</span>
<span id="cb659-11"><a href="#cb659-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> y</span>
<span id="cb659-12"><a href="#cb659-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb659-13"><a href="#cb659-13" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">500000000</span></span>
<span id="cb659-14"><a href="#cb659-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb659-15"><a href="#cb659-15" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(size <span class="op">=</span> n).astype(np.float32)  <span class="co"># 32-bit for consistency with JAX default</span></span>
<span id="cb659-16"><a href="#cb659-16" aria-hidden="true" tabindex="-1"></a>x_jax <span class="op">=</span> jnp.array(x)  <span class="co"># 32-bit by default</span></span>
<span id="cb659-17"><a href="#cb659-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_jax.platform())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>cpu</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb661"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb661-1"><a href="#cb661-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb661-2"><a href="#cb661-2" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> myfun_np(x)</span>
<span id="cb661-3"><a href="#cb661-3" aria-hidden="true" tabindex="-1"></a>t1 <span class="op">=</span> time.time() <span class="op">-</span> t0</span>
<span id="cb661-4"><a href="#cb661-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb661-5"><a href="#cb661-5" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb661-6"><a href="#cb661-6" aria-hidden="true" tabindex="-1"></a>z_jax <span class="op">=</span> myfun_jnp(x_jax).block_until_ready()</span>
<span id="cb661-7"><a href="#cb661-7" aria-hidden="true" tabindex="-1"></a>t2 <span class="op">=</span> time.time() <span class="op">-</span> t0</span>
<span id="cb661-8"><a href="#cb661-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb661-9"><a href="#cb661-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"numpy time: </span><span class="sc">{</span><span class="bu">round</span>(t1,<span class="dv">3</span>)<span class="sc">}</span><span class="ch">\n</span><span class="ss">jax time: </span><span class="sc">{</span><span class="bu">round</span>(t2,<span class="dv">3</span>)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Running on the SCF gandalf machine (not shown above), we get these times.</p>
<pre><code>numpy time: 17.181
jax time: 5.722</code></pre>
<p>There’s a nice speedup compared to numpy.</p>
<p>Since JAX will often execute computations asynchronously (in particular when using the GPU), the <code>block_until_ready</code> invocation ensures that the computation finishes before we stop timing.</p>
<p>By default the JAX floating point type is 32-bit so we forced the use of 32-bit numbers for numpy for comparability. One could have JAX use 64-bit numbers like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb663"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb663-1"><a href="#cb663-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax</span>
<span id="cb663-2"><a href="#cb663-2" aria-hidden="true" tabindex="-1"></a>jax.config.update(<span class="st">"jax_enable_x64"</span>, <span class="va">True</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next let’s consider JIT compiling it, which should fuse the vectorized operations and avoid temporary objects. The JAX docs have a <a href="https://jax.readthedocs.io/en/latest/notebooks/thinking_in_jax.html#to-jit-or-not-to-jit">nice discussion</a> of when JIT compilation will be beneficial.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb664"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb664-1"><a href="#cb664-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax</span>
<span id="cb664-2"><a href="#cb664-2" aria-hidden="true" tabindex="-1"></a>myfun_jnp_jit <span class="op">=</span> jax.jit(myfun_jnp)</span>
<span id="cb664-3"><a href="#cb664-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb664-4"><a href="#cb664-4" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb664-5"><a href="#cb664-5" aria-hidden="true" tabindex="-1"></a>z_jax_jit <span class="op">=</span> myfun_jnp_jit(x_jax).block_until_ready()</span>
<span id="cb664-6"><a href="#cb664-6" aria-hidden="true" tabindex="-1"></a>t3 <span class="op">=</span> time.time() <span class="op">-</span> t0</span>
<span id="cb664-7"><a href="#cb664-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"jitted jax time: </span><span class="sc">{</span><span class="bu">round</span>(t3,<span class="dv">3</span>)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>jitted jax time: 3.218</code></pre>
<p>So that gives a nice two-fold additional speedup.</p>
</section>
<section id="lazy-evaluation" class="level3">
<h3 class="anchored" data-anchor-id="lazy-evaluation">Lazy evaluation</h3>
<p>What’s strange about this R code?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb666"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb666-1"><a href="#cb666-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">print</span>(<span class="st">"hi"</span>)</span>
<span id="cb666-2"><a href="#cb666-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">mean</span>(<span class="fu">rnorm</span>(<span class="dv">1000000</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.060   0.000   0.061 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb668"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb668-1"><a href="#cb668-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">f</span>(<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "hi"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
      0       0       0 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb671"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb671-1"><a href="#cb671-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">f</span>(<span class="fu">mean</span>(<span class="fu">rnorm</span>(<span class="dv">1000000</span>)))) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "hi"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.001   0.000   0.001 </code></pre>
</div>
</div>
<p>It seems like the <code>rnorm(1000000)</code> is not actually executed when being passed to <code>f</code>. That is “lazy evaluation” in action - the code that is passed in as an argument is only evaluated when it is needed (and in this case it’s not needed for the function to run).</p>
<p>Lazy evaluation is not just an R thing. It also occurs in Tensorflow (particularly version 1), the Python Dask package, and in Spark. The basic idea is to delay executation until it’s really needed, with the goal that if one does so, the system may be able to better optimize a series of multiple steps as a joint operation relative to executing them one by one.</p>
<p>However, Python itself does not have lazy evaluation.</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/stat243\.berkeley\.edu\/fall-2025");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>